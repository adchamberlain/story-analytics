version: 2

semantic_models:
  - name: orders
    description: |
      Core order fact table containing the complete order lifecycle from purchase through delivery.
      Each order represents a customer transaction on the Olist marketplace. Orders can contain
      multiple items from multiple sellers. 97% of orders (96,478) are successfully delivered,
      with 63% meeting estimated delivery dates. Average order lifecycle is ~12 days from purchase
      to customer delivery.
    model: ref('orders')
    defaults:
      agg_time_dimension: order_date
    
    entities:
      - name: order
        type: primary
        expr: order_id
      - name: customer
        type: foreign
        expr: customer_id
    
    dimensions:
      - name: order_date
        type: time
        label: Order Purchase Date
        description: Timestamp when customer placed the order
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: order_approved_date
        type: time
        label: Order Approval Date
        description: Timestamp when payment was approved
        expr: order_approved_at
        type_params:
          time_granularity: day
      
      - name: delivered_carrier_date
        type: time
        label: Carrier Pickup Date
        description: Timestamp when carrier picked up order from seller
        expr: order_delivered_carrier_date
        type_params:
          time_granularity: day
      
      - name: delivered_customer_date
        type: time
        label: Customer Delivery Date
        description: Timestamp when order was delivered to customer
        expr: order_delivered_customer_date
        type_params:
          time_granularity: day
      
      - name: estimated_delivery_date
        type: time
        label: Estimated Delivery Date
        description: Promised delivery date shown to customer at purchase
        expr: order_estimated_delivery_date
        type_params:
          time_granularity: day
      
      - name: order_status
        type: categorical
        label: Order Status
        description: |
          Current order status: delivered (96,478 orders, 97%), shipped (1,107), 
          canceled (625), processing, unavailable, invoiced, created, approved
      
      - name: is_delivered
        type: categorical
        label: Is Delivered
        description: Boolean flag for successfully delivered orders
        expr: "CASE WHEN order_status = 'delivered' THEN TRUE ELSE FALSE END"
      
      - name: is_canceled
        type: categorical
        label: Is Canceled
        description: Boolean flag for canceled orders
        expr: "CASE WHEN order_status = 'canceled' THEN TRUE ELSE FALSE END"
      
      - name: is_on_time
        type: categorical
        label: Is On Time Delivery
        description: Boolean flag for orders delivered by estimated date (63% on-time rate)
        expr: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN TRUE ELSE FALSE END"
      
      - name: delivery_days
        type: categorical
        label: Delivery Time (Days)
        description: Days from purchase to customer delivery
        expr: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp))/86400"
      
      - name: approval_delay_hours
        type: categorical
        label: Approval Delay (Hours)
        description: Hours from purchase to payment approval
        expr: "EXTRACT(EPOCH FROM (order_approved_at - order_purchase_timestamp))/3600"
    
    measures:
      - name: orders_total_count
        agg: count
        label: Total Orders
        description: Total count of all orders regardless of status
      
      - name: orders_delivered_count
        agg: count
        label: Delivered Orders
        description: Count of successfully delivered orders (97% of all orders)
        expr: "CASE WHEN order_status = 'delivered' THEN order_id END"
      
      - name: orders_canceled_count
        agg: count
        label: Canceled Orders
        description: Count of canceled orders
        expr: "CASE WHEN order_status = 'canceled' THEN order_id END"
      
      - name: orders_on_time_count
        agg: count
        label: On-Time Deliveries
        description: Count of orders delivered by estimated date
        expr: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN order_id END"
      
      - name: orders_late_count
        agg: count
        label: Late Deliveries
        description: Count of orders delivered after estimated date
        expr: "CASE WHEN order_delivered_customer_date > order_estimated_delivery_date THEN order_id END"
      
      - name: orders_delivery_days_sum
        agg: sum
        label: Total Delivery Days
        description: Sum of delivery days for calculating averages
        expr: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp))/86400"
      
      - name: orders_approval_hours_sum
        agg: sum
        label: Total Approval Hours
        description: Sum of approval delay hours for calculating averages
        expr: "EXTRACT(EPOCH FROM (order_approved_at - order_purchase_timestamp))/3600"

  - name: order_items
    description: |
      Line items within orders, representing individual products sold. Each order can have
      multiple items (average 1.2 items per order, max 21 items). Items include pricing,
      freight costs, and seller information. Total of 112,650 line items across 98,666 orders.
      Average item price is R$120.65, average freight is R$19.99.
    model: ref('order_items')
    defaults:
      agg_time_dimension: shipping_limit_date
    
    entities:
      - name: order_item
        type: primary
        expr: "order_id || '-' || order_item_id"
      - name: order
        type: foreign
        expr: order_id
      - name: product
        type: foreign
        expr: product_id
      - name: seller
        type: foreign
        expr: seller_id
    
    dimensions:
      - name: shipping_limit_date
        type: time
        label: Shipping Limit Date
        description: Deadline for seller to ship the item
        type_params:
          time_granularity: day
      
      - name: order_item_sequence
        type: categorical
        label: Item Sequence Number
        description: Sequential number of item within order (1-21)
        expr: order_item_id
    
    measures:
      - name: order_items_count
        agg: count
        label: Order Items Count
        description: Total number of line items sold
      
      - name: order_items_price_sum
        agg: sum
        label: Product Revenue (GMV)
        description: Total product price excluding freight (R$13.6M total)
        expr: price
      
      - name: order_items_freight_sum
        agg: sum
        label: Total Freight Revenue
        description: Total shipping charges collected (R$2.25M total)
        expr: freight_value
      
      - name: order_items_total_value_sum
        agg: sum
        label: Total Item Value (Price + Freight)
        description: Combined product price and freight charges
        expr: "price + freight_value"
      
      - name: order_items_price_avg
        agg: average
        label: Average Item Price
        description: Average product price per line item (R$120.65)
        expr: price
      
      - name: order_items_freight_avg
        agg: average
        label: Average Freight per Item
        description: Average shipping cost per line item (R$19.99)
        expr: freight_value
      
      - name: order_items_distinct_orders
        agg: count_distinct
        label: Orders with Items
        description: Distinct count of orders containing items
        expr: order_id
      
      - name: order_items_distinct_products
        agg: count_distinct
        label: Distinct Products Sold
        description: Count of unique products sold
        expr: product_id
      
      - name: order_items_distinct_sellers
        agg: count_distinct
        label: Active Sellers
        description: Count of unique sellers with sales
        expr: seller_id

  - name: order_payments
    description: |
      Payment transactions for orders. Orders can have multiple payment records for installments
      or split payments (average 1.09 payments per order). Credit cards dominate at 76% of 
      payments (76,795 transactions), followed by boleto (19,784), voucher (5,775), and debit.
      Average payment value is R$154.10, with credit card AOV at R$162.70.
    model: ref('order_payments')
    defaults:
      agg_time_dimension: order_date
    
    entities:
      - name: payment
        type: primary
        expr: "order_id || '-' || payment_sequential"
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: order_date
        type: time
        label: Order Date
        description: Order purchase date (joined from orders table)
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: payment_type
        type: categorical
        label: Payment Method
        description: |
          Payment method: credit_card (76%, R$162.70 AOV), boleto (18%), 
          voucher (5.5%, R$62.33 AOV), debit_card, not_defined
      
      - name: payment_sequential
        type: categorical
        label: Payment Sequence Number
        description: Sequential payment number for split/installment payments (1-29)
      
      - name: payment_installments
        type: categorical
        label: Installment Count
        description: Number of installments for credit card payments (0-24, average 2.85)
      
      - name: is_credit_card
        type: categorical
        label: Is Credit Card
        description: Boolean flag for credit card payments
        expr: "CASE WHEN payment_type = 'credit_card' THEN TRUE ELSE FALSE END"
      
      - name: is_boleto
        type: categorical
        label: Is Boleto
        description: Boolean flag for boleto (bank slip) payments
        expr: "CASE WHEN payment_type = 'boleto' THEN TRUE ELSE FALSE END"
      
      - name: is_voucher
        type: categorical
        label: Is Voucher
        description: Boolean flag for voucher/gift card payments
        expr: "CASE WHEN payment_type = 'voucher' THEN TRUE ELSE FALSE END"
    
    measures:
      - name: payments_count
        agg: count
        label: Payment Transactions
        description: Total number of payment records
      
      - name: payments_value_sum
        agg: sum
        label: Total Payment Value
        description: Total payment amount collected (R$16M total)
        expr: payment_value
      
      - name: payments_value_avg
        agg: average
        label: Average Payment Value
        description: Average payment amount per transaction (R$154.10)
        expr: payment_value
      
      - name: payments_installments_sum
        agg: sum
        label: Total Installments
        description: Sum of installment counts for analysis
        expr: payment_installments
      
      - name: payments_installments_avg
        agg: average
        label: Average Installments
        description: Average number of installments per payment (2.85)
        expr: payment_installments
      
      - name: payments_distinct_orders
        agg: count_distinct
        label: Orders with Payments
        description: Distinct count of orders with payment records
        expr: order_id
      
      - name: payments_credit_card_count
        agg: count
        label: Credit Card Payments
        description: Count of credit card payment transactions
        expr: "CASE WHEN payment_type = 'credit_card' THEN order_id END"
      
      - name: payments_boleto_count
        agg: count
        label: Boleto Payments
        description: Count of boleto payment transactions
        expr: "CASE WHEN payment_type = 'boleto' THEN order_id END"
      
      - name: payments_voucher_count
        agg: count
        label: Voucher Payments
        description: Count of voucher payment transactions
        expr: "CASE WHEN payment_type = 'voucher' THEN order_id END"

  - name: order_reviews
    description: |
      Customer reviews and ratings for completed orders. 99,224 reviews with average score
      of 4.09/5.0. Distribution heavily skewed positive: 57,328 five-star reviews (56.55%),
      19,142 four-star (19%), 11,424 one-star (11%). 58.7% include written comments.
      Reviews created 0-636 days after order, with answers typically within 1-3 days.
    model: ref('order_reviews')
    defaults:
      agg_time_dimension: review_creation_date
    
    entities:
      - name: review
        type: primary
        expr: review_id
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: review_creation_date
        type: time
        label: Review Creation Date
        description: Date customer created the review
        type_params:
          time_granularity: day
      
      - name: review_answer_date
        type: time
        label: Review Answer Date
        description: Date marketplace responded to review
        expr: review_answer_timestamp
        type_params:
          time_granularity: day
      
      - name: review_score
        type: categorical
        label: Review Score
        description: Customer rating from 1-5 stars (average 4.09)
      
      - name: has_comment_title
        type: categorical
        label: Has Comment Title
        description: Boolean flag for reviews with title (11.7% have titles)
        expr: "CASE WHEN review_comment_title IS NOT NULL THEN TRUE ELSE FALSE END"
      
      - name: has_comment_message
        type: categorical
        label: Has Comment Message
        description: Boolean flag for reviews with written feedback (41.3% have messages)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN TRUE ELSE FALSE END"
      
      - name: is_positive_review
        type: categorical
        label: Is Positive Review
        description: Boolean flag for 4-5 star reviews (75.55% positive)
        expr: "CASE WHEN review_score >= 4 THEN TRUE ELSE FALSE END"
      
      - name: is_five_star
        type: categorical
        label: Is Five Star
        description: Boolean flag for perfect 5-star reviews (56.55%)
        expr: "CASE WHEN review_score = 5 THEN TRUE ELSE FALSE END"
      
      - name: is_one_star
        type: categorical
        label: Is One Star
        description: Boolean flag for 1-star reviews (11.5%)
        expr: "CASE WHEN review_score = 1 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: reviews_count
        agg: count
        label: Total Reviews
        description: Total number of customer reviews submitted
      
      - name: reviews_score_sum
        agg: sum
        label: Total Review Score Points
        description: Sum of all review scores for calculating averages
        expr: review_score
      
      - name: reviews_score_avg
        agg: average
        label: Average Review Score
        description: Mean customer satisfaction rating (4.09/5.0)
        expr: review_score
      
      - name: reviews_five_star_count
        agg: count
        label: Five Star Reviews
        description: Count of perfect 5-star reviews (56.55% of all reviews)
        expr: "CASE WHEN review_score = 5 THEN review_id END"
      
      - name: reviews_four_star_count
        agg: count
        label: Four Star Reviews
        description: Count of 4-star reviews (19% of all reviews)
        expr: "CASE WHEN review_score = 4 THEN review_id END"
      
      - name: reviews_positive_count
        agg: count
        label: Positive Reviews (4-5 Stars)
        description: Count of reviews with 4 or 5 stars (75.55%)
        expr: "CASE WHEN review_score >= 4 THEN review_id END"
      
      - name: reviews_negative_count
        agg: count
        label: Negative Reviews (1-2 Stars)
        description: Count of reviews with 1 or 2 stars
        expr: "CASE WHEN review_score <= 2 THEN review_id END"
      
      - name: reviews_with_comments_count
        agg: count
        label: Reviews with Comments
        description: Count of reviews containing written feedback (41.3%)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN review_id END"
      
      - name: reviews_distinct_orders
        agg: count_distinct
        label: Orders with Reviews
        description: Distinct count of orders that received reviews
        expr: order_id

  - name: customers
    description: |
      Customer dimension table with geographic information. 99,441 customer records representing
      96,096 unique individuals (customer_unique_id). São Paulo state dominates with 41,746
      customers (42%), followed by Rio de Janeiro (12,852, 13%) and Minas Gerais (11,635, 12%).
      Customers span 14,994 zip codes and 4,119 cities across 27 Brazilian states.
    model: ref('customers')
    defaults:
      agg_time_dimension: first_order_date
    
    entities:
      - name: customer
        type: primary
        expr: customer_id
      - name: customer_unique
        type: natural
        expr: customer_unique_id
    
    dimensions:
      - name: first_order_date
        type: time
        label: First Order Date
        description: Date of customer's first order (joined from orders)
        expr: first_order_timestamp
        type_params:
          time_granularity: day
      
      - name: customer_state
        type: categorical
        label: Customer State
        description: |
          Brazilian state code (27 states). Top states: SP (42%), RJ (13%), MG (12%),
          RS (5.5%), PR (5.1%). SP + RJ account for 55% of customer base.
      
      - name: customer_city
        type: categorical
        label: Customer City
        description: Customer city name (4,119 unique cities)
      
      - name: customer_zip_code_prefix
        type: categorical
        label: Customer Zip Code
        description: First 5 digits of customer zip code (14,994 unique prefixes)
      
      - name: is_sao_paulo
        type: categorical
        label: Is São Paulo Customer
        description: Boolean flag for customers in SP state (42% of customers)
        expr: "CASE WHEN customer_state = 'SP' THEN TRUE ELSE FALSE END"
      
      - name: is_top_state
        type: categorical
        label: Is Top 3 State
        description: Boolean flag for SP, RJ, or MG customers (67% of customer base)
        expr: "CASE WHEN customer_state IN ('SP', 'RJ', 'MG') THEN TRUE ELSE FALSE END"
    
    measures:
      - name: customers_count
        agg: count
        label: Customer Records
        description: Total customer records (includes duplicates per order)
      
      - name: customers_unique_count
        agg: count_distinct
        label: Unique Customers
        description: Distinct count of unique individuals (96,096 unique customers)
        expr: customer_unique_id
      
      - name: customers_states_count
        agg: count_distinct
        label: States with Customers
        description: Number of distinct states with customer presence
        expr: customer_state
      
      - name: customers_cities_count
        agg: count_distinct
        label: Cities with Customers
        description: Number of distinct cities with customer presence
        expr: customer_city
      
      - name: customers_zip_codes_count
        agg: count_distinct
        label: Zip Codes with Customers
        description: Number of distinct zip code prefixes
        expr: customer_zip_code_prefix

  - name: products
    description: |
      Product catalog with 32,951 unique products across 73 categories. Products have physical
      dimensions and weights that drive freight costs. Average weight is 2,276g (median 700g),
      ranging from 0g to 40,425g. Average dimensions: 30.8cm length, 16.9cm height, 23.2cm width.
      Most products have 1-2 photos (average 2.19). 1.9% of products missing category data.
    model: ref('products')
    defaults:
      agg_time_dimension: first_sale_date
    
    entities:
      - name: product
        type: primary
        expr: product_id
      - name: product_category
        type: foreign
        expr: product_category_name
    
    dimensions:
      - name: first_sale_date
        type: time
        label: First Sale Date
        description: Date product was first sold (joined from order_items)
        expr: first_sale_timestamp
        type_params:
          time_granularity: day
      
      - name: product_category_name
        type: categorical
        label: Product Category (Portuguese)
        description: Product category in Portuguese (73 categories, 1.9% null)
      
      - name: product_weight_g
        type: categorical
        label: Product Weight (grams)
        description: Product weight in grams (0-40,425g, average 2,276g, median 700g)
      
      - name: product_length_cm
        type: categorical
        label: Product Length (cm)
        description: Product length in centimeters (7-105cm, average 30.8cm)
      
      - name: product_height_cm
        type: categorical
        label: Product Height (cm)
        description: Product height in centimeters (2-105cm, average 16.9cm)
      
      - name: product_width_cm
        type: categorical
        label: Product Width (cm)
        description: Product width in centimeters (6-118cm, average 23.2cm)
      
      - name: product_photos_qty
        type: categorical
        label: Product Photo Count
        description: Number of product photos (1-20, average 2.19, most have 1-2)
      
      - name: product_name_length
        type: categorical
        label: Product Name Length
        description: Character count of product name (5-76, average 48.5)
      
      - name: product_description_length
        type: categorical
        label: Product Description Length
        description: Character count of product description (4-3,992, average 771.5)
      
      - name: weight_category
        type: categorical
        label: Weight Category
        description: Product weight classification for freight analysis
        expr: |
          CASE 
            WHEN product_weight_g < 500 THEN 'Light (<500g)'
            WHEN product_weight_g < 2000 THEN 'Medium (500-2000g)'
            WHEN product_weight_g < 5000 THEN 'Heavy (2000-5000g)'
            ELSE 'Very Heavy (5000g+)'
          END
      
      - name: has_multiple_photos
        type: categorical
        label: Has Multiple Photos
        description: Boolean flag for products with 2+ photos
        expr: "CASE WHEN product_photos_qty >= 2 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: products_count
        agg: count
        label: Total Products
        description: Total number of products in catalog
      
      - name: products_weight_avg
        agg: average
        label: Average Product Weight
        description: Mean product weight in grams (2,276g)
        expr: product_weight_g
      
      - name: products_weight_sum
        agg: sum
        label: Total Catalog Weight
        description: Sum of all product weights
        expr: product_weight_g
      
      - name: products_volume_avg
        agg: average
        label: Average Product Volume
        description: Mean product volume in cubic cm
        expr: "product_length_cm * product_height_cm * product_width_cm"
      
      - name: products_photos_avg
        agg: average
        label: Average Photos per Product
        description: Mean number of product photos (2.19)
        expr: product_photos_qty
      
      - name: products_categories_count
        agg: count_distinct
        label: Product Categories
        description: Number of distinct product categories
        expr: product_category_name

  - name: sellers
    description: |
      Seller dimension table with 3,095 active sellers across Brazil. São Paulo state has
      the most sellers (1,849, 60%), followed by Paraná (349, 11%) and Minas Gerais (244, 8%).
      Sellers span 2,246 zip codes and 611 cities across 23 states. Geographic distribution
      affects fulfillment speed and freight costs.
    model: ref('sellers')
    defaults:
      agg_time_dimension: first_sale_date
    
    entities:
      - name: seller
        type: primary
        expr: seller_id
    
    dimensions:
      - name: first_sale_date
        type: time
        label: First Sale Date
        description: Date of seller's first sale (joined from order_items)
        expr: first_sale_timestamp
        type_params:
          time_granularity: day
      
      - name: seller_state
        type: categorical
        label: Seller State
        description: |
          Brazilian state code (23 states). Top states: SP (60%), PR (11%), MG (8%),
          RJ (5%), SC (4%). São Paulo dominates seller concentration.
      
      - name: seller_city
        type: categorical
        label: Seller City
        description: Seller city name (611 unique cities)
      
      - name: seller_zip_code_prefix
        type: categorical
        label: Seller Zip Code
        description: First 5 digits of seller zip code (2,246 unique prefixes)
      
      - name: is_sao_paulo_seller
        type: categorical
        label: Is São Paulo Seller
        description: Boolean flag for sellers in SP state (60% of sellers)
        expr: "CASE WHEN seller_state = 'SP' THEN TRUE ELSE FALSE END"
    
    measures:
      - name: sellers_count
        agg: count
        label: Total Sellers
        description: Total number of active sellers on platform
      
      - name: sellers_states_count
        agg: count_distinct
        label: States with Sellers
        description: Number of distinct states with seller presence
        expr: seller_state
      
      - name: sellers_cities_count
        agg: count_distinct
        label: Cities with Sellers
        description: Number of distinct cities with seller presence
        expr: seller_city

  - name: product_category_translation
    description: |
      Translation table mapping Portuguese product category names to English equivalents.
      Contains 73 category translations covering the full product taxonomy. Used for
      reporting and international analysis. All categories in the products table have
      corresponding English translations.
    model: ref('product_category_translation')
    defaults:
      agg_time_dimension: created_date
    
    entities:
      - name: product_category
        type: primary
        expr: product_category_name
    
    dimensions:
      - name: created_date
        type: time
        label: Translation Created Date
        description: Date translation was added (static dimension table)
        expr: current_date
        type_params:
          time_granularity: day
      
      - name: product_category_name
        type: categorical
        label: Category Name (Portuguese)
        description: Product category name in Portuguese
      
      - name: product_category_name_english
        type: categorical
        label: Category Name (English)
        description: Product category name translated to English
    
    measures:
      - name: categories_count
        agg: count
        label: Total Categories
        description: Total number of product categories with translations

---

version: 2

metrics:
  # ============================================================================
  # REVENUE & VALUE METRICS
  # ============================================================================
  
  - name: total_revenue
    label: Total Revenue
    description: |
      Total payment value from all non-canceled orders. This is the canonical revenue
      metric for the business. Excludes canceled orders. Expected total: ~R$16M.
    type: simple
    type_params:
      measure: payments_value_sum
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: gmv
    label: Gross Merchandise Value (GMV)
    description: |
      Total value of goods sold (product price only, excluding freight) from delivered
      orders. Represents the core product revenue. Expected total: ~R$13.6M.
    type: simple
    type_params:
      measure: order_items_price_sum
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: gmv_with_freight
    label: GMV Including Freight
    description: |
      Total value of goods sold including freight charges from delivered orders.
      Combined product and shipping revenue. Expected total: ~R$15.9M.
    type: simple
    type_params:
      measure: order_items_total_value_sum
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: freight_revenue
    label: Total Freight Revenue
    description: |
      Total shipping charges collected from delivered orders. Average freight per
      item is R$19.99. Expected total: ~R$2.25M.
    type: simple
    type_params:
      measure: order_items_freight_sum
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: aov
    label: Average Order Value (AOV)
    description: |
      Average payment value per order. Overall AOV is ~R$154. Credit card AOV is
      R$162.70, voucher AOV is R$62.33. Key metric for pricing strategy.
    type: derived
    type_params:
      expr: total_revenue / NULLIF(order_count, 0)
      metrics:
        - name: total_revenue
        - name: order_count
  
  - name: average_item_price
    label: Average Item Price
    description: |
      Average product price per line item, excluding freight. Overall average is
      R$120.65. Used for product pricing analysis.
    type: simple
    type_params:
      measure: order_items_price_avg
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: average_freight_per_item
    label: Average Freight per Item
    description: |
      Average shipping cost per line item. Overall average is R$19.99. Varies by
      distance, weight, and product category.
    type: simple
    type_params:
      measure: order_items_freight_avg
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: freight_to_price_ratio
    label: Freight to Price Ratio
    description: |
      Shipping cost as a percentage of product price. Used for logistics optimization
      and identifying high-freight categories. Lower ratio indicates better economics.
    type: derived
    type_params:
      expr: freight_revenue / NULLIF(gmv, 0)
      metrics:
        - name: freight_revenue
        - name: gmv
  
  # ============================================================================
  # VOLUME & COUNT METRICS
  # ============================================================================
  
  - name: order_count
    label: Total Orders
    description: |
      Total count of non-canceled orders. Used as denominator for rate calculations.
      Expected total: ~98,816 orders (excluding 625 canceled).
    type: simple
    type_params:
      measure: orders_total_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: delivered_order_count
    label: Delivered Orders
    description: |
      Count of successfully delivered orders. 97% of all orders are delivered.
      Expected total: ~96,478 orders.
    type: simple
    type_params:
      measure: orders_delivered_count
  
  - name: canceled_order_count
    label: Canceled Orders
    description: |
      Count of canceled orders. Represents 0.6% of all orders. Expected total: ~625 orders.
    type: simple
    type_params:
      measure: orders_canceled_count
  
  - name: items_sold
    label: Total Items Sold
    description: |
      Total number of line items sold across all delivered orders. Average 1.2 items
      per order. Expected total: ~112,650 items.
    type: simple
    type_params:
      measure: order_items_count
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: unique_customers
    label: Unique Customers
    description: |
      Distinct count of unique individuals who placed orders. CRITICAL: Use
      customer_unique_id, not customer_id. Expected total: ~96,096 unique customers.
    type: simple
    type_params:
      measure: customers_unique_count
  
  - name: active_sellers
    label: Active Sellers
    description: |
      Count of unique sellers with sales in the period. Expected total: ~3,095 sellers.
    type: simple
    type_params:
      measure: order_items_distinct_sellers
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: products_sold
    label: Distinct Products Sold
    description: |
      Count of unique products sold in the period. Expected total: ~32,951 products.
    type: simple
    type_params:
      measure: order_items_distinct_products
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: items_per_order
    label: Average Items per Order
    description: |
      Average number of line items per order. Overall average is 1.2 items per order.
      Most orders (98,666 of 99,441) contain a single item.
    type: derived
    type_params:
      expr: items_sold / NULLIF(delivered_order_count, 0)
      metrics:
        - name: items_sold
        - name: delivered_order_count
  
  # ============================================================================
  # PAYMENT METHOD METRICS
  # ============================================================================
  
  - name: credit_card_orders
    label: Credit Card Orders
    description: |
      Count of orders paid by credit card. Credit cards account for 76% of all orders
      and 75% of revenue. Expected: ~76,795 orders.
    type: simple
    type_params:
      measure: payments_credit_card_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: credit_card_revenue
    label: Credit Card Revenue
    description: |
      Total revenue from credit card payments. Represents 75% of total revenue.
      Credit card AOV is R$162.70.
    type: simple
    type_params:
      measure: payments_value_sum
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled' AND
      {{ Dimension('payment__payment_type') }} = 'credit_card'
  
  - name: boleto_orders
    label: Boleto Orders
    description: |
      Count of orders paid by boleto (bank slip). Boleto accounts for 18% of orders.
      Expected: ~19,784 orders.
    type: simple
    type_params:
      measure: payments_boleto_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: voucher_orders
    label: Voucher Orders
    description: |
      Count of orders paid by voucher/gift card. Vouchers account for 5.5% of orders
      with lower AOV of R$62.33. Expected: ~5,775 orders.
    type: simple
    type_params:
      measure: payments_voucher_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: credit_card_share
    label: Credit Card Order Share
    description: |
      Percentage of orders paid by credit card. Benchmark: 76% of all orders.
      Key metric for payment mix analysis.
    type: derived
    type_params:
      expr: credit_card_orders / NULLIF(order_count, 0) * 100
      metrics:
        - name: credit_card_orders
        - name: order_count
  
  - name: average_installments
    label: Average Payment Installments
    description: |
      Average number of installments for credit card payments. Overall average is
      2.85 installments, with most payments using 1 installment.
    type: simple
    type_params:
      measure: payments_installments_avg
    filter: |
      {{ Dimension('payment__payment_type') }} = 'credit_card'
  
  # ============================================================================
  # DELIVERY PERFORMANCE METRICS
  # ============================================================================
  
  - name: on_time_deliveries
    label: On-Time Deliveries
    description: |
      Count of orders delivered by or before the estimated delivery date. Benchmark:
      63% on-time delivery rate. Critical operational KPI.
    type: simple
    type_params:
      measure: orders_on_time_count
  
  - name: late_deliveries
    label: Late Deliveries
    description: |
      Count of orders delivered after the estimated delivery date. Represents 37%
      of deliveries. Late delivery strongly correlates with poor reviews.
    type: simple
    type_params:
      measure: orders_late_count
  
  - name: on_time_delivery_rate
    label: On-Time Delivery Rate
    description: |
      Percentage of orders delivered by estimated date. Benchmark: 63% on-time rate.
      Critical for customer satisfaction and review scores.
    type: derived
    type_params:
      expr: on_time_deliveries / NULLIF(delivered_order_count, 0) * 100
      metrics:
        - name: on_time_deliveries
        - name: delivered_order_count
  
  - name: average_delivery_days
    label: Average Delivery Time (Days)
    description: |
      Average days from purchase to customer delivery. Used for logistics performance
      tracking and customer expectation management.
    type: derived
    type_params:
      expr: total_delivery_days / NULLIF(delivered_order_count, 0)
      metrics:
        - name: total_delivery_days
        - name: delivered_order_count
  
  - name: total_delivery_days
    label: Total Delivery Days
    description: |
      Sum of delivery days across all delivered orders. Used for calculating average
      delivery time. Internal metric for aggregation.
    type: simple
    type_params:
      measure: orders_delivery_days_sum
  
  - name: average_approval_hours
    label: Average Approval Time (Hours)
    description: |
      Average hours from order purchase to payment approval. Measures payment
      processing efficiency.
    type: derived
    type_params:
      expr: total_approval_hours / NULLIF(order_count, 0)
      metrics:
        - name: total_approval_hours
        - name: order_count
  
  - name: total_approval_hours
    label: Total Approval Hours
    description: |
      Sum of approval delay hours across all orders. Used for calculating average
      approval time. Internal metric for aggregation.
    type: simple
    type_params:
      measure: orders_approval_hours_sum
  
  # ============================================================================
  # CUSTOMER SATISFACTION METRICS
  # ============================================================================
  
  - name: total_reviews
    label: Total Reviews
    description: |
      Total number of customer reviews submitted. Expected: ~99,224 reviews covering
      99.5% of delivered orders.
    type: simple
    type_params:
      measure: reviews_count
  
  - name: average_review_score
    label: Average Review Score
    description: |
      Mean customer satisfaction rating on 1-5 scale. Benchmark: 4.09/5.0.
      Distribution heavily skewed positive with 56.55% five-star reviews.
    type: simple
    type_params:
      measure: reviews_score_avg
  
  - name: five_star_reviews
    label: Five Star Reviews
    description: |
      Count of perfect 5-star reviews. Represents 56.55% of all reviews (57,328 reviews).
      Key indicator of customer delight.
    type: simple
    type_params:
      measure: reviews_five_star_count
  
  - name: positive_reviews
    label: Positive Reviews (4-5 Stars)
    description: |
      Count of reviews with 4 or 5 stars. Represents 75.55% of all reviews.
      Standard definition of positive customer feedback.
    type: simple
    type_params:
      measure: reviews_positive_count
  
  - name: negative_reviews
    label: Negative Reviews (1-2 Stars)
    description: |
      Count of reviews with 1 or 2 stars. Represents detractors and dissatisfied
      customers. Used for service recovery prioritization.
    type: simple
    type_params:
      measure: reviews_negative_count
  
  - name: positive_review_rate
    label: Positive Review Rate
    description: |
      Percentage of reviews with 4-5 stars. Benchmark: 75.55% positive rate.
      Key customer satisfaction KPI.
    type: derived
    type_params:
      expr: positive_reviews / NULLIF(total_reviews, 0) * 100
      metrics:
        - name: positive_reviews
        - name: total_reviews
  
  - name: five_star_rate
    label: Five Star Rate
    description: |
      Percentage of reviews with perfect 5-star rating. Benchmark: 56.55%.
      Measures exceptional customer experiences.
    type: derived
    type_params:
      expr: five_star_reviews / NULLIF(total_reviews, 0) * 100
      metrics:
        - name: five_star_reviews
        - name: total_reviews
  
  - name: reviews_with_comments
    label: Reviews with Written Comments
    description: |
      Count of reviews containing written feedback. 41.3% of reviews include comments.
      Valuable for qualitative analysis.
    type: simple
    type_params:
      measure: reviews_with_comments_count
  
  - name: comment_rate
    label: Review Comment Rate
    description: |
      Percentage of reviews with written comments. Benchmark: 41.3%. Higher rates
      indicate stronger customer engagement (positive or negative).
    type: derived
    type_params:
      expr: reviews_with_comments / NULLIF(total_reviews, 0) * 100
      metrics:
        - name: reviews_with_comments
        - name: total_reviews
  
  # ============================================================================
  # CUSTOMER BEHAVIOR METRICS
  # ============================================================================
  
  - name: repeat_customers
    label: Repeat Customers
    description: |
      Count of customers who made more than one purchase. Only ~3% of customers are
      repeat buyers. Major retention opportunity.
    type: simple
    type_params:
      measure: customers_unique_count
    filter: |
      {{ Dimension('customer__order_count') }} > 1
  
  - name: repeat_purchase_rate
    label: Repeat Purchase Rate
    description: |
      Percentage of customers who make more than one purchase. Benchmark: ~3% repeat
      rate (97% one-time buyers). Critical retention metric.
    type: derived
    type_params:
      expr: repeat_customers / NULLIF(unique_customers, 0) * 100
      metrics:
        - name: repeat_customers
        - name: unique_customers
  
  - name: orders_per_customer
    label: Average Orders per Customer
    description: |
      Average number of orders per unique customer. Given 3% repeat rate, overall
      average is ~1.03 orders per customer.
    type: derived
    type_params:
      expr: order_count / NULLIF(unique_customers, 0)
      metrics:
        - name: order_count
        - name: unique_customers
  
  # ============================================================================
  # GROWTH & TREND METRICS
  # ============================================================================
  
  - name: revenue_previous_month
    label: Revenue (Previous Month)
    description: |
      Total revenue from the previous month. Used for month-over-month growth
      calculations and trend analysis.
    type: simple
    type_params:
      measure: payments_value_sum
      offset_window: 1 month
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: revenue_mom_growth
    label: Revenue Month-over-Month Growth
    description: |
      Percentage change in revenue compared to previous month. Key metric for
      tracking business momentum and seasonality.
    type: derived
    type_params:
      expr: (total_revenue - revenue_previous_month) / NULLIF(revenue_previous_month, 0) * 100
      metrics:
        - name: total_revenue
        - name: revenue_previous_month
  
  - name: orders_previous_month
    label: Orders (Previous Month)
    description: |
      Total orders from the previous month. Used for month-over-month growth
      calculations.
    type: simple
    type_params:
      measure: orders_total_count
      offset_window: 1 month
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: orders_mom_growth
    label: Orders Month-over-Month Growth
    description: |
      Percentage change in order count compared to previous month. Tracks volume
      trends independent of pricing changes.
    type: derived
    type_params:
      expr: (order_count - orders_previous_month) / NULLIF(orders_previous_month, 0) * 100
      metrics:
        - name: order_count
        - name: orders_previous_month
  
  # ============================================================================
  # CUMULATIVE METRICS
  # ============================================================================
  
  - name: cumulative_revenue
    label: Cumulative Revenue (All-Time)
    description: |
      Running total of revenue from the beginning of time. Used for lifetime value
      tracking and cumulative performance dashboards.
    type: cumulative
    type_params:
      measure: payments_value_sum
  
  - name: cumulative_revenue_mtd
    label: Cumulative Revenue (Month-to-Date)
    description: |
      Running total of revenue within the current month. Resets at month boundaries.
      Used for monthly target tracking.
    type: cumulative
    type_params:
      measure: payments_value_sum
      grain_to_date: month
  
  - name: cumulative_orders
    label: Cumulative Orders (All-Time)
    description: |
      Running total of orders from the beginning of time. Used for milestone tracking
      and growth visualization.
    type: cumulative
    type_params:
      measure: orders_total_count
  
  - name: cumulative_customers
    label: Cumulative Unique Customers
    description: |
      Running total of unique customers acquired over time. Tracks customer base
      growth and acquisition trends.
    type: cumulative
    type_params:
      measure: customers_unique_count
  
  # ============================================================================
  # RATIO METRICS
  # ============================================================================
  
  - name: cancellation_rate
    label: Order Cancellation Rate
    description: |
      Percentage of orders that are canceled. Benchmark: 0.6% cancellation rate
      (625 of 99,441 orders). Low rate indicates healthy operations.
    type: ratio
    type_params:
      numerator: canceled_order_count
      denominator: order_count
  
  - name: review_coverage_rate
    label: Review Coverage Rate
    description: |
      Percentage of delivered orders that received customer reviews. Benchmark:
      99.5% coverage. High rate indicates strong customer engagement.
    type: ratio
    type_params:
      numerator: total_reviews
      denominator: delivered_order_count

---

version: 2

saved_queries:
  - name: monthly_revenue_overview
    label: Monthly Revenue Overview
    description: |
      Key revenue and volume metrics by month with month-over-month growth rates.
      Shows total revenue, GMV, order count, AOV, and growth trends. Used for
      executive dashboards and monthly business reviews.
    query_params:
      metrics:
        - total_revenue
        - gmv
        - order_count
        - aov
        - revenue_mom_growth
        - orders_mom_growth
      group_by:
        - "TimeDimension('metric_time', 'month')"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: revenue_by_state
    label: Revenue by Customer State
    description: |
      Geographic revenue analysis showing total revenue, orders, and AOV by customer
      state. São Paulo dominates at 42% of customers. Used for regional performance
      tracking and market expansion planning.
    query_params:
      metrics:
        - total_revenue
        - order_count
        - unique_customers
        - aov
      group_by:
        - "Dimension('customer__customer_state')"
      order_by:
        - total_revenue desc
  
  - name: product_category_performance
    label: Product Category Performance
    description: |
      Product category analysis showing revenue, items sold, average price, and
      review scores. Top category is bed_bath_table at ~R$1.69M. Used for inventory
      planning and category management.
    query_params:
      metrics:
        - gmv
        - items_sold
        - average_item_price
        - average_review_score
        - positive_review_rate
      group_by:
        - "Dimension('product__product_category_name_english')"
      order_by:
        - gmv desc
      where:
        - "{{ Dimension('product__product_category_name_english') }} IS NOT NULL"
  
  - name: delivery_performance_dashboard
    label: Delivery Performance Dashboard
    description: |
      Logistics KPI dashboard showing on-time delivery rate, average delivery days,
      and correlation with review scores. Benchmark: 63% on-time rate. Used for
      operations monitoring and service level tracking.
    query_params:
      metrics:
        - delivered_order_count
        - on_time_deliveries
        - late_deliveries
        - on_time_delivery_rate
        - average_delivery_days
        - average_review_score
      group_by:
        - "TimeDimension('metric_time', 'month')"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: payment_method_analysis
    label: Payment Method Analysis
    description: |
      Payment mix and performance by payment type. Credit cards dominate at 76% of
      orders with R$162.70 AOV. Used for payment strategy and partnership decisions.
    query_params:
      metrics:
        - order_count
        - total_revenue
        - aov
        - average_installments
      group_by:
        - "Dimension('payment__payment_type')"
      order_by:
        - order_count desc
  
  - name: seller_performance_ranking
    label: Top Seller Performance
    description: |
      Seller leaderboard showing revenue, orders, items sold, and average review
      scores. Minimum 10 orders for statistical significance. Used for seller
      relationship management and marketplace health monitoring.
    query_params:
      metrics:
        - gmv
        - order_count
        - items_sold
        - average_review_score
      group_by:
        - "Dimension('seller__seller_id')"
        - "Dimension('seller__seller_state')"
      order_by:
        - gmv desc
      where:
        - "{{ Metric('order_count') }} >= 10"
      limit: 100
  
  - name: customer_satisfaction_trends
    label: Customer Satisfaction Trends
    description: |
      Monthly customer satisfaction metrics including average review score, positive
      review rate, and five-star rate. Benchmark: 4.09/5.0 average, 75.55% positive.
      Used for customer experience monitoring.
    query_params:
      metrics:
        - total_reviews
        - average_review_score
        - positive_review_rate
        - five_star_rate
        - comment_rate
      group_by:
        - "TimeDimension('metric_time', 'month')"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: freight_cost_analysis
    label: Freight Cost Analysis
    description: |
      Shipping cost analysis showing freight revenue, freight-to-price ratio, and
      average freight by product weight category. Used for logistics optimization
      and pricing strategy.
    query_params:
      metrics:
        - freight_revenue
        - gmv
        - freight_to_price_ratio
        - average_freight_per_item
        - items_sold
      group_by:
        - "Dimension('product__weight_category')"
      order_by:
        - items_sold desc
  
  - name: customer_cohort_retention
    label: Customer Cohort Retention
    description: |
      Cohort analysis showing customer acquisition and repeat purchase behavior by
      cohort month. Benchmark: 3% repeat rate. Used for retention strategy and
      lifecycle marketing.
    query_params:
      metrics:
        - unique_customers
        - order_count
        - repeat_customers
        - repeat_purchase_rate
        - orders_per_customer
      group_by:
        - "TimeDimension('customer__first_order_date', 'month')"
      order_by:
        - "TimeDimension('customer__first_order_date', 'month')"
  
  - name: weekly_operations_snapshot
    label: Weekly Operations Snapshot
    description: |
      Weekly operational metrics including orders, revenue, delivery performance,
      and customer satisfaction. Used for weekly business reviews and operational
      planning.
    query_params:
      metrics:
        - order_count
        - total_revenue
        - aov
        - on_time_delivery_rate
        - average_delivery_days
        - average_review_score
        - active_sellers
      group_by:
        - "TimeDimension('metric_time', 'week')"
      order_by:
        - "TimeDimension('metric_time', 'week')"
  
  - name: marketplace_health_scorecard
    label: Marketplace Health Scorecard
    description: |
      Comprehensive marketplace health metrics including revenue, volume, customer
      satisfaction, delivery performance, and seller activity. Used for executive
      reporting and strategic planning.
    query_params:
      metrics:
        - total_revenue
        - order_count
        - unique_customers
        - aov
        - on_time_delivery_rate
        - average_review_score
        - positive_review_rate
        - active_sellers
        - products_sold
        - repeat_purchase_rate
      group_by:
        - "TimeDimension('metric_time', 'month')"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: state_delivery_performance
    label: Delivery Performance by State
    description: |
      Geographic delivery performance showing on-time rates and average delivery
      days by customer state. Used for logistics network optimization and regional
      service level management.
    query_params:
      metrics:
        - delivered_order_count
        - on_time_delivery_rate
        - average_delivery_days
        - average_review_score
      group_by:
        - "Dimension('customer__customer_state')"
      order_by:
        - delivered_order_count desc
      where:
        - "{{ Metric('delivered_order_count') }} >= 100"
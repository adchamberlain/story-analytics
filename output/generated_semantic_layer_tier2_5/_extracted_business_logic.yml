business_domain:
  description: "Brazilian e-commerce marketplace (Olist) connecting sellers with customers across Brazil. Platform facilitates order fulfillment, payments, shipping, and customer reviews. Data represents actual transactions, logistics performance, and customer satisfaction metrics from a multi-seller marketplace model."
  currency: "BRL (Brazilian Real, R$)"
  date_range: "September 2016 - September 2018 (~2 years, ~100K orders)"

metric_definitions:
  total_revenue:
    description: "Total payment value from completed orders"
    calculation: "SUM(order_payments.payment_value)"
    standard_filters: "order_status <> 'canceled' OR order_status = 'delivered'"
    notes: "Always exclude canceled orders. This is the canonical revenue metric."
  
  gmv:
    description: "Gross Merchandise Value - total value of goods sold"
    calculation: "SUM(order_items.price + order_items.freight_value) OR SUM(order_items.price)"
    standard_filters: "order_status = 'delivered'"
    notes: "Two definitions exist: (1) price only, (2) price + freight. Context-dependent. Expected total: R$15.4-15.9M"
  
  aov:
    description: "Average Order Value"
    calculation: "AVG(order_payments.payment_value) OR SUM(payment_value) / COUNT(DISTINCT order_id)"
    standard_filters: "order_status = 'delivered'"
    notes: "Credit card AOV: ~R$162.70, Voucher AOV: ~R$62.33"
  
  on_time_delivery_rate:
    description: "Percentage of orders delivered by estimated date"
    calculation: "SUM(CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN 1 ELSE 0 END) * 100.0 / COUNT(*)"
    standard_filters: "order_status = 'delivered' AND order_delivered_customer_date IS NOT NULL"
    notes: "Benchmark: ~63% on-time delivery rate. Critical operational KPI."
  
  delivery_time_days:
    description: "Days from purchase to customer delivery"
    calculation: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp))/86400"
    standard_filters: "order_status = 'delivered' AND order_delivered_customer_date IS NOT NULL"
    notes: "Use DATEDIFF for SQL Server, date subtraction for PostgreSQL"
  
  repeat_purchase_rate:
    description: "Percentage of customers who make more than one purchase"
    calculation: "COUNT(customers with order_count > 1) * 100.0 / COUNT(DISTINCT customer_unique_id)"
    standard_filters: "order_status <> 'canceled'"
    notes: "Benchmark: ~3% repeat rate (97% one-time buyers). Major retention opportunity."
  
  freight_to_price_ratio:
    description: "Shipping cost as percentage of product price"
    calculation: "SUM(order_items.freight_value) / NULLIF(SUM(order_items.price), 0)"
    standard_filters: "order_status = 'delivered'"
    notes: "Varies by distance and product category. Used for logistics optimization."
  
  customer_lifetime_value:
    description: "Total spending by customer in defined time window"
    calculation: "SUM(order_payments.payment_value) per customer_unique_id"
    standard_filters: "order_status <> 'canceled', typically first 6 months (182.5 days)"
    notes: "Time window varies: first 6 months is standard cohort analysis period"

standard_filters:
  - name: "exclude_canceled_orders"
    sql: "WHERE order_status <> 'canceled'"
    when_applied: "All revenue, GMV, and financial metrics. Universal filter for business performance."
  
  - name: "delivered_orders_only"
    sql: "WHERE order_status = 'delivered'"
    when_applied: "Delivery performance, review analysis, product/seller performance. More restrictive than exclude_canceled."
  
  - name: "valid_delivery_dates"
    sql: "WHERE order_delivered_customer_date IS NOT NULL"
    when_applied: "Any delivery time or on-time rate calculation. Ensures data quality."
  
  - name: "minimum_review_threshold"
    sql: "HAVING COUNT(review_id) >= 100"
    when_applied: "Category or seller review analysis. Ensures statistical significance."
  
  - name: "minimum_order_threshold"
    sql: "HAVING COUNT(DISTINCT order_id) >= 10"
    when_applied: "Seller performance analysis. Filters out low-volume sellers."

join_patterns:
  - tables: ["customers", "orders"]
    join_key: "customer_id"
    join_type: "INNER"
    notes: "Standard join for customer analysis. Always use customer_unique_id for deduplication, not customer_id."
  
  - tables: ["orders", "order_payments"]
    join_key: "order_id"
    join_type: "INNER"
    notes: "Revenue calculation. One order can have multiple payment records (installments)."
  
  - tables: ["orders", "order_items"]
    join_key: "order_id"
    join_type: "INNER"
    notes: "Product-level analysis. One order can have multiple items from multiple sellers."
  
  - tables: ["order_items", "products"]
    join_key: "product_id"
    join_type: "INNER"
    notes: "Product category and attribute analysis."
  
  - tables: ["products", "product_category_name_translation"]
    join_key: "product_category_name"
    join_type: "LEFT"
    notes: "Always LEFT JOIN - not all categories have English translations. Use for reporting."
  
  - tables: ["order_items", "sellers"]
    join_key: "seller_id"
    join_type: "INNER"
    notes: "Seller performance and geographic analysis."
  
  - tables: ["orders", "reviews"]
    join_key: "order_id"
    join_type: "INNER"
    notes: "Customer satisfaction analysis. One review per order."
  
  - tables: ["customers", "geolocation"]
    join_key: "customer_zip_code = geolocation_zip_code_prefix"
    join_type: "INNER"
    notes: "Distance calculations using Haversine formula. Join on zip code prefix."
  
  - tables: ["sellers", "geolocation"]
    join_key: "seller_zip_code_prefix = geolocation_zip_code_prefix"
    join_type: "INNER"
    notes: "Seller location for distance/logistics analysis."

naming_conventions:
  - concept: "Gross sales value"
    preferred_name: "GMV"
    alternatives: ["revenue", "total_revenue", "category_revenue"]
  
  - concept: "Unique customer identifier"
    preferred_name: "customer_unique_id"
    alternatives: ["customer_id"]
    notes: "CRITICAL: customer_id is NOT unique per person. Always use customer_unique_id for customer counts."
  
  - concept: "Product price"
    preferred_name: "price"
    alternatives: ["item_price", "product_revenue"]
    notes: "From order_items.price, excludes freight"
  
  - concept: "Shipping cost"
    preferred_name: "freight_value"
    alternatives: ["shipping_cost", "freight", "total_freight"]
  
  - concept: "Order completion"
    preferred_name: "delivered"
    alternatives: ["completed", "fulfilled"]
    notes: "order_status = 'delivered' is the canonical success state"
  
  - concept: "Customer satisfaction score"
    preferred_name: "review_score"
    alternatives: ["rating", "avg_review_score"]
    notes: "Scale of 1-5, average is ~4.09"
  
  - concept: "Geographic region"
    preferred_name: "state"
    alternatives: ["customer_state", "seller_state"]
    notes: "Two-letter state codes (SP, RJ, MG). State preferred over city for aggregation."
  
  - concept: "Payment method"
    preferred_name: "payment_type"
    alternatives: ["payment_method"]
    notes: "Values: credit_card, boleto, voucher, debit_card"
  
  - concept: "Time period grouping"
    preferred_name: "month" (from DATE_TRUNC)
    alternatives: ["cohort_month", "activity_month", "order_month"]
    notes: "PostgreSQL: DATE_TRUNC('month', timestamp). SQL Server: use DATEPART."

key_dimensions:
  - dimension: "customer_state"
    used_for: "Geographic revenue analysis, logistics planning. SP dominates at ~46% of customers."
  
  - dimension: "product_category_name_english"
    used_for: "Product performance, inventory planning. Top: bed_bath_table (~R$1.69M), health_beauty, computers_accessories."
  
  - dimension: "payment_type"
    used_for: "Payment method analysis. Credit card: 76% of orders, 75% of revenue."
  
  - dimension: "DATE_TRUNC('month', order_purchase_timestamp)"
    used_for: "Time series analysis, trend reporting, cohort definition. Standard temporal grouping."
  
  - dimension: "order_status"
    used_for: "Order lifecycle tracking. Values: delivered, shipped, canceled, processing, unavailable."
  
  - dimension: "seller_id / seller_state"
    used_for: "Seller performance ranking, marketplace coverage analysis."
  
  - dimension: "review_score"
    used_for: "Customer satisfaction distribution. 56.55% give 5 stars."
  
  - dimension: "cohort_month (MIN(order_purchase_timestamp))"
    used_for: "Cohort retention analysis. Defines customer 'birth date' for lifecycle tracking."
  
  - dimension: "EXTRACT(DOW FROM order_purchase_timestamp)"
    used_for: "Day-of-week seasonality, operational planning."
  
  - dimension: "delivery_status (on-time vs late)"
    used_for: "Logistics performance, correlation with review scores."

business_rules:
  - rule: "On-time delivery definition"
    sql_pattern: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN 'On Time' ELSE 'Late' END"
    notes: "Critical for logistics KPIs. Late delivery strongly correlates with poor reviews."
  
  - rule: "Customer deduplication"
    sql_pattern: "COUNT(DISTINCT customer_unique_id) NOT COUNT(DISTINCT customer_id)"
    notes: "customer_id can repeat per person. customer_unique_id is the true unique identifier."
  
  - rule: "Revenue recognition"
    sql_pattern: "WHERE order_status <> 'canceled' OR WHERE order_status = 'delivered'"
    notes: "Only count completed/delivered orders for financial metrics. Canceled orders excluded."
  
  - rule: "Repeat customer identification"
    sql_pattern: "CASE WHEN order_count > 1 THEN 1 ELSE 0 END"
    notes: "Only ~3% of customers are repeat buyers. Major retention opportunity."
  
  - rule: "Positive review definition"
    sql_pattern: "CASE WHEN review_score >= 4 THEN 1 ELSE 0 END"
    notes: "4-5 stars considered positive. Used for positive_review_pct calculations."
  
  - rule: "Weight-based freight categorization"
    sql_pattern: "CASE WHEN product_weight_g < 500 THEN 'Light' WHEN product_weight_g < 2000 THEN 'Medium' WHEN product_weight_g < 5000 THEN 'Heavy' ELSE 'Very Heavy' END"
    notes: "Product weight drives freight costs. Used for logistics pricing analysis."
  
  - rule: "Distance-based shipping buckets"
    sql_pattern: "CASE WHEN distance_km < 100 THEN '< 100km' WHEN distance_km < 500 THEN '100-500km' WHEN distance_km < 1000 THEN '500-1000km' ELSE '1000km+' END"
    notes: "Distance calculated via Haversine formula. Drives delivery time and freight cost."
  
  - rule: "Freight cost bucketing"
    sql_pattern: "CASE WHEN freight_value < 10 THEN '< R$10' WHEN freight_value < 20 THEN 'R$10-20' WHEN freight_value < 30 THEN 'R$20-30' ELSE 'R$30+' END"
    notes: "Used to analyze freight cost vs delivery time tradeoffs."
  
  - rule: "Cohort time window"
    sql_pattern: "WHERE order_purchase_timestamp < first_order_date + INTERVAL '182.5 day'"
    notes: "Standard 6-month window for CLV and cohort retention analysis."
  
  - rule: "Statistical significance threshold"
    sql_pattern: "HAVING COUNT(*) >= 100 OR HAVING COUNT(DISTINCT order_id) >= 10"
    notes: "Minimum sample sizes for category/seller analysis to ensure valid insights."
  
  - rule: "Multi-seller order complexity"
    sql_pattern: "COUNT(DISTINCT seller_id) per order_id"
    notes: "Orders with multiple sellers require coordination. Impacts fulfillment complexity."
  
  - rule: "Payment reconciliation"
    sql_pattern: "ABS(SUM(price + freight_value) - SUM(payment_value)) > 0.01"
    notes: "Data quality check. Payment total should match order items total within 1 cent."
  
  - rule: "Order timeline validation"
    sql_pattern: "WHERE order_approved_at >= order_purchase_timestamp AND order_delivered_carrier_date >= order_approved_at"
    notes: "Ensures logical sequence of order lifecycle events for data quality."

analytical_patterns:
  - pattern: "Time series aggregation"
    description: "Monthly/quarterly revenue and order trends with growth rates"
    key_tables: ["orders", "order_payments"]
    sql_structure: "DATE_TRUNC('month', timestamp) GROUP BY month, use LAG() for MoM growth"
  
  - pattern: "Cohort retention analysis"
    description: "Track customer activity by cohort month over time"
    key_tables: ["customers", "orders"]
    sql_structure: "CTE for first_purchase (cohort_month), CTE for monthly_activity, join and calculate months_since_cohort"
  
  - pattern: "RFM segmentation"
    description: "Recency, Frequency, Monetary analysis for customer segmentation"
    key_tables: ["customers", "orders", "order_payments"]
    sql_structure: "GROUP BY customer_unique_id, calculate MAX(date) for recency, COUNT for frequency, SUM for monetary"
  
  - pattern: "Geographic performance"
    description: "Revenue, orders, and metrics by state/city"
    key_tables: ["customers", "orders", "order_payments"]
    sql_structure: "GROUP BY customer_state, aggregate revenue/orders. SP dominates at 46%."
  
  - pattern: "Product category ranking"
    description: "Top categories by revenue, AOV, review scores"
    key_tables: ["order_items", "products", "product_category_name_translation", "reviews"]
    sql_structure: "LEFT JOIN for translation, GROUP BY category, ORDER BY revenue DESC. Top: bed_bath_table."
  
  - pattern: "Delivery performance analysis"
    description: "On-time rate, delivery days, late delivery analysis"
    key_tables: ["orders", "customers"]
    sql_structure: "CASE for on-time vs late, date arithmetic for delivery_days, GROUP BY state/category"
  
  - pattern: "Seller performance ranking"
    description: "Top sellers by revenue with review scores"
    key_tables: ["sellers", "order_items", "orders", "reviews"]
    sql_structure: "GROUP BY seller_id, aggregate revenue/orders/reviews, HAVING for minimum thresholds"
  
  - pattern: "Payment method analysis"
    description: "Distribution and AOV by payment type"
    key_tables: ["order_payments", "orders"]
    sql_structure: "GROUP BY payment_type, calculate percentages. Credit card: 76% of orders."
  
  - pattern: "Freight cost optimization"
    description: "Freight vs distance, weight, delivery time correlations"
    key_tables: ["order_items", "products", "geolocation", "orders"]
    sql_structure: "Haversine distance calculation, CASE for weight/distance buckets, analyze freight_value patterns"
  
  - pattern: "Review score correlation"
    description: "Review scores vs delivery performance, category, seller"
    key_tables: ["reviews", "orders", "order_items", "products"]
    sql_structure: "JOIN reviews with delivery metrics, GROUP BY delivery_status/category, AVG(review_score)"
  
  - pattern: "Customer lifetime value"
    description: "Total spending in time window from first order"
    key_tables: ["customers", "orders", "order_payments"]
    sql_structure: "CTE for first_order_date, filter orders within window (182.5 days), SUM payment_value"
  
  - pattern: "Order complexity analysis"
    description: "Items per order, multi-seller orders, fulfillment complexity"
    key_tables: ["orders", "order_items"]
    sql_structure: "Subquery to COUNT items/sellers per order_id, outer query to aggregate by complexity level"
  
  - pattern: "Seasonality analysis"
    description: "Day-of-week, monthly patterns in orders"
    key_tables: ["orders"]
    sql_structure: "EXTRACT(DOW/MONTH), GROUP BY period, compare to averages with window functions"
  
  - pattern: "Data quality validation"
    description: "Reconciliation, timeline validation, duplicate checks"
    key_tables: ["all tables"]
    sql_structure: "Compare aggregates (payment_value vs price+freight), check date sequences, COUNT vs COUNT DISTINCT"

key_insights:
  geographic:
    - "SÃ£o Paulo (SP) dominates with ~46% of customers"
    - "SP + RJ account for >50% of customer base"
    - "Top 10 states contain >90% of customers"
  
  product:
    - "bed_bath_table is top category: ~R$1.69M revenue"
    - "Computers has high AOV, bed_bath_table has low AOV but high volume"
    - "Product weight and dimensions drive freight costs"
  
  payment:
    - "Credit card: 76% of orders, 75% of revenue, AOV ~R$162.70"
    - "Boleto: 18% of orders"
    - "Most credit card payments use 1 installment"
  
  logistics:
    - "~63% on-time delivery rate (benchmark)"
    - "Late delivery strongly correlates with poor reviews"
    - "Distance drives both shipping cost and delivery time"
  
  customer:
    - "Only ~3% repeat purchase rate (97% one-time buyers)"
    - "Average review score: ~4.09/5.0"
    - "56.55% of customers give 5-star reviews"
  
  temporal:
    - "Q2 2018 had highest revenue"
    - "Q3 2016 had lowest revenue"
    - "Dataset spans September 2016 - September 2018"
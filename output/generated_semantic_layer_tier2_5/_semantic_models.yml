version: 2

semantic_models:
  - name: orders
    description: |
      Core order fact table containing the complete order lifecycle from purchase through delivery.
      Each order represents a customer transaction on the Olist marketplace. Orders can contain
      multiple items from multiple sellers. 97% of orders (96,478) are successfully delivered,
      with 63% meeting estimated delivery dates. Average order lifecycle is ~12 days from purchase
      to customer delivery.
    model: ref('orders')
    defaults:
      agg_time_dimension: order_date
    
    entities:
      - name: order
        type: primary
        expr: order_id
      - name: customer
        type: foreign
        expr: customer_id
    
    dimensions:
      - name: order_date
        type: time
        label: Order Purchase Date
        description: Timestamp when customer placed the order
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: order_approved_date
        type: time
        label: Order Approval Date
        description: Timestamp when payment was approved
        expr: order_approved_at
        type_params:
          time_granularity: day
      
      - name: delivered_carrier_date
        type: time
        label: Carrier Pickup Date
        description: Timestamp when carrier picked up order from seller
        expr: order_delivered_carrier_date
        type_params:
          time_granularity: day
      
      - name: delivered_customer_date
        type: time
        label: Customer Delivery Date
        description: Timestamp when order was delivered to customer
        expr: order_delivered_customer_date
        type_params:
          time_granularity: day
      
      - name: estimated_delivery_date
        type: time
        label: Estimated Delivery Date
        description: Promised delivery date shown to customer at purchase
        expr: order_estimated_delivery_date
        type_params:
          time_granularity: day
      
      - name: order_status
        type: categorical
        label: Order Status
        description: |
          Current order status: delivered (96,478 orders, 97%), shipped (1,107), 
          canceled (625), processing, unavailable, invoiced, created, approved
      
      - name: is_delivered
        type: categorical
        label: Is Delivered
        description: Boolean flag for successfully delivered orders
        expr: "CASE WHEN order_status = 'delivered' THEN TRUE ELSE FALSE END"
      
      - name: is_canceled
        type: categorical
        label: Is Canceled
        description: Boolean flag for canceled orders
        expr: "CASE WHEN order_status = 'canceled' THEN TRUE ELSE FALSE END"
      
      - name: is_on_time
        type: categorical
        label: Is On Time Delivery
        description: Boolean flag for orders delivered by estimated date (63% on-time rate)
        expr: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN TRUE ELSE FALSE END"
      
      - name: delivery_days
        type: categorical
        label: Delivery Time (Days)
        description: Days from purchase to customer delivery
        expr: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp))/86400"
      
      - name: approval_delay_hours
        type: categorical
        label: Approval Delay (Hours)
        description: Hours from purchase to payment approval
        expr: "EXTRACT(EPOCH FROM (order_approved_at - order_purchase_timestamp))/3600"
    
    measures:
      - name: orders_total_count
        agg: count
        label: Total Orders
        description: Total count of all orders regardless of status
      
      - name: orders_delivered_count
        agg: count
        label: Delivered Orders
        description: Count of successfully delivered orders (97% of all orders)
        expr: "CASE WHEN order_status = 'delivered' THEN order_id END"
      
      - name: orders_canceled_count
        agg: count
        label: Canceled Orders
        description: Count of canceled orders
        expr: "CASE WHEN order_status = 'canceled' THEN order_id END"
      
      - name: orders_on_time_count
        agg: count
        label: On-Time Deliveries
        description: Count of orders delivered by estimated date
        expr: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN order_id END"
      
      - name: orders_late_count
        agg: count
        label: Late Deliveries
        description: Count of orders delivered after estimated date
        expr: "CASE WHEN order_delivered_customer_date > order_estimated_delivery_date THEN order_id END"
      
      - name: orders_delivery_days_sum
        agg: sum
        label: Total Delivery Days
        description: Sum of delivery days for calculating averages
        expr: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp))/86400"
      
      - name: orders_approval_hours_sum
        agg: sum
        label: Total Approval Hours
        description: Sum of approval delay hours for calculating averages
        expr: "EXTRACT(EPOCH FROM (order_approved_at - order_purchase_timestamp))/3600"

  - name: order_items
    description: |
      Line items within orders, representing individual products sold. Each order can have
      multiple items (average 1.2 items per order, max 21 items). Items include pricing,
      freight costs, and seller information. Total of 112,650 line items across 98,666 orders.
      Average item price is R$120.65, average freight is R$19.99.
    model: ref('order_items')
    defaults:
      agg_time_dimension: shipping_limit_date
    
    entities:
      - name: order_item
        type: primary
        expr: "order_id || '-' || order_item_id"
      - name: order
        type: foreign
        expr: order_id
      - name: product
        type: foreign
        expr: product_id
      - name: seller
        type: foreign
        expr: seller_id
    
    dimensions:
      - name: shipping_limit_date
        type: time
        label: Shipping Limit Date
        description: Deadline for seller to ship the item
        type_params:
          time_granularity: day
      
      - name: order_item_sequence
        type: categorical
        label: Item Sequence Number
        description: Sequential number of item within order (1-21)
        expr: order_item_id
    
    measures:
      - name: order_items_count
        agg: count
        label: Order Items Count
        description: Total number of line items sold
      
      - name: order_items_price_sum
        agg: sum
        label: Product Revenue (GMV)
        description: Total product price excluding freight (R$13.6M total)
        expr: price
      
      - name: order_items_freight_sum
        agg: sum
        label: Total Freight Revenue
        description: Total shipping charges collected (R$2.25M total)
        expr: freight_value
      
      - name: order_items_total_value_sum
        agg: sum
        label: Total Item Value (Price + Freight)
        description: Combined product price and freight charges
        expr: "price + freight_value"
      
      - name: order_items_price_avg
        agg: average
        label: Average Item Price
        description: Average product price per line item (R$120.65)
        expr: price
      
      - name: order_items_freight_avg
        agg: average
        label: Average Freight per Item
        description: Average shipping cost per line item (R$19.99)
        expr: freight_value
      
      - name: order_items_distinct_orders
        agg: count_distinct
        label: Orders with Items
        description: Distinct count of orders containing items
        expr: order_id
      
      - name: order_items_distinct_products
        agg: count_distinct
        label: Distinct Products Sold
        description: Count of unique products sold
        expr: product_id
      
      - name: order_items_distinct_sellers
        agg: count_distinct
        label: Active Sellers
        description: Count of unique sellers with sales
        expr: seller_id

  - name: order_payments
    description: |
      Payment transactions for orders. Orders can have multiple payment records for installments
      or split payments (average 1.09 payments per order). Credit cards dominate at 76% of 
      payments (76,795 transactions), followed by boleto (19,784), voucher (5,775), and debit.
      Average payment value is R$154.10, with credit card AOV at R$162.70.
    model: ref('order_payments')
    defaults:
      agg_time_dimension: order_date
    
    entities:
      - name: payment
        type: primary
        expr: "order_id || '-' || payment_sequential"
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: order_date
        type: time
        label: Order Date
        description: Order purchase date (joined from orders table)
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: payment_type
        type: categorical
        label: Payment Method
        description: |
          Payment method: credit_card (76%, R$162.70 AOV), boleto (18%), 
          voucher (5.5%, R$62.33 AOV), debit_card, not_defined
      
      - name: payment_sequential
        type: categorical
        label: Payment Sequence Number
        description: Sequential payment number for split/installment payments (1-29)
      
      - name: payment_installments
        type: categorical
        label: Installment Count
        description: Number of installments for credit card payments (0-24, average 2.85)
      
      - name: is_credit_card
        type: categorical
        label: Is Credit Card
        description: Boolean flag for credit card payments
        expr: "CASE WHEN payment_type = 'credit_card' THEN TRUE ELSE FALSE END"
      
      - name: is_boleto
        type: categorical
        label: Is Boleto
        description: Boolean flag for boleto (bank slip) payments
        expr: "CASE WHEN payment_type = 'boleto' THEN TRUE ELSE FALSE END"
      
      - name: is_voucher
        type: categorical
        label: Is Voucher
        description: Boolean flag for voucher/gift card payments
        expr: "CASE WHEN payment_type = 'voucher' THEN TRUE ELSE FALSE END"
    
    measures:
      - name: payments_count
        agg: count
        label: Payment Transactions
        description: Total number of payment records
      
      - name: payments_value_sum
        agg: sum
        label: Total Payment Value
        description: Total payment amount collected (R$16M total)
        expr: payment_value
      
      - name: payments_value_avg
        agg: average
        label: Average Payment Value
        description: Average payment amount per transaction (R$154.10)
        expr: payment_value
      
      - name: payments_installments_sum
        agg: sum
        label: Total Installments
        description: Sum of installment counts for analysis
        expr: payment_installments
      
      - name: payments_installments_avg
        agg: average
        label: Average Installments
        description: Average number of installments per payment (2.85)
        expr: payment_installments
      
      - name: payments_distinct_orders
        agg: count_distinct
        label: Orders with Payments
        description: Distinct count of orders with payment records
        expr: order_id
      
      - name: payments_credit_card_count
        agg: count
        label: Credit Card Payments
        description: Count of credit card payment transactions
        expr: "CASE WHEN payment_type = 'credit_card' THEN order_id END"
      
      - name: payments_boleto_count
        agg: count
        label: Boleto Payments
        description: Count of boleto payment transactions
        expr: "CASE WHEN payment_type = 'boleto' THEN order_id END"
      
      - name: payments_voucher_count
        agg: count
        label: Voucher Payments
        description: Count of voucher payment transactions
        expr: "CASE WHEN payment_type = 'voucher' THEN order_id END"

  - name: order_reviews
    description: |
      Customer reviews and ratings for completed orders. 99,224 reviews with average score
      of 4.09/5.0. Distribution heavily skewed positive: 57,328 five-star reviews (56.55%),
      19,142 four-star (19%), 11,424 one-star (11%). 58.7% include written comments.
      Reviews created 0-636 days after order, with answers typically within 1-3 days.
    model: ref('order_reviews')
    defaults:
      agg_time_dimension: review_creation_date
    
    entities:
      - name: review
        type: primary
        expr: review_id
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: review_creation_date
        type: time
        label: Review Creation Date
        description: Date customer created the review
        type_params:
          time_granularity: day
      
      - name: review_answer_date
        type: time
        label: Review Answer Date
        description: Date marketplace responded to review
        expr: review_answer_timestamp
        type_params:
          time_granularity: day
      
      - name: review_score
        type: categorical
        label: Review Score
        description: Customer rating from 1-5 stars (average 4.09)
      
      - name: has_comment_title
        type: categorical
        label: Has Comment Title
        description: Boolean flag for reviews with title (11.7% have titles)
        expr: "CASE WHEN review_comment_title IS NOT NULL THEN TRUE ELSE FALSE END"
      
      - name: has_comment_message
        type: categorical
        label: Has Comment Message
        description: Boolean flag for reviews with written feedback (41.3% have messages)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN TRUE ELSE FALSE END"
      
      - name: is_positive_review
        type: categorical
        label: Is Positive Review
        description: Boolean flag for 4-5 star reviews (75.55% positive)
        expr: "CASE WHEN review_score >= 4 THEN TRUE ELSE FALSE END"
      
      - name: is_five_star
        type: categorical
        label: Is Five Star
        description: Boolean flag for perfect 5-star reviews (56.55%)
        expr: "CASE WHEN review_score = 5 THEN TRUE ELSE FALSE END"
      
      - name: is_one_star
        type: categorical
        label: Is One Star
        description: Boolean flag for 1-star reviews (11.5%)
        expr: "CASE WHEN review_score = 1 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: reviews_count
        agg: count
        label: Total Reviews
        description: Total number of customer reviews submitted
      
      - name: reviews_score_sum
        agg: sum
        label: Total Review Score Points
        description: Sum of all review scores for calculating averages
        expr: review_score
      
      - name: reviews_score_avg
        agg: average
        label: Average Review Score
        description: Mean customer satisfaction rating (4.09/5.0)
        expr: review_score
      
      - name: reviews_five_star_count
        agg: count
        label: Five Star Reviews
        description: Count of perfect 5-star reviews (56.55% of all reviews)
        expr: "CASE WHEN review_score = 5 THEN review_id END"
      
      - name: reviews_four_star_count
        agg: count
        label: Four Star Reviews
        description: Count of 4-star reviews (19% of all reviews)
        expr: "CASE WHEN review_score = 4 THEN review_id END"
      
      - name: reviews_positive_count
        agg: count
        label: Positive Reviews (4-5 Stars)
        description: Count of reviews with 4 or 5 stars (75.55%)
        expr: "CASE WHEN review_score >= 4 THEN review_id END"
      
      - name: reviews_negative_count
        agg: count
        label: Negative Reviews (1-2 Stars)
        description: Count of reviews with 1 or 2 stars
        expr: "CASE WHEN review_score <= 2 THEN review_id END"
      
      - name: reviews_with_comments_count
        agg: count
        label: Reviews with Comments
        description: Count of reviews containing written feedback (41.3%)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN review_id END"
      
      - name: reviews_distinct_orders
        agg: count_distinct
        label: Orders with Reviews
        description: Distinct count of orders that received reviews
        expr: order_id

  - name: customers
    description: |
      Customer dimension table with geographic information. 99,441 customer records representing
      96,096 unique individuals (customer_unique_id). São Paulo state dominates with 41,746
      customers (42%), followed by Rio de Janeiro (12,852, 13%) and Minas Gerais (11,635, 12%).
      Customers span 14,994 zip codes and 4,119 cities across 27 Brazilian states.
    model: ref('customers')
    defaults:
      agg_time_dimension: first_order_date
    
    entities:
      - name: customer
        type: primary
        expr: customer_id
      - name: customer_unique
        type: natural
        expr: customer_unique_id
    
    dimensions:
      - name: first_order_date
        type: time
        label: First Order Date
        description: Date of customer's first order (joined from orders)
        expr: first_order_timestamp
        type_params:
          time_granularity: day
      
      - name: customer_state
        type: categorical
        label: Customer State
        description: |
          Brazilian state code (27 states). Top states: SP (42%), RJ (13%), MG (12%),
          RS (5.5%), PR (5.1%). SP + RJ account for 55% of customer base.
      
      - name: customer_city
        type: categorical
        label: Customer City
        description: Customer city name (4,119 unique cities)
      
      - name: customer_zip_code_prefix
        type: categorical
        label: Customer Zip Code
        description: First 5 digits of customer zip code (14,994 unique prefixes)
      
      - name: is_sao_paulo
        type: categorical
        label: Is São Paulo Customer
        description: Boolean flag for customers in SP state (42% of customers)
        expr: "CASE WHEN customer_state = 'SP' THEN TRUE ELSE FALSE END"
      
      - name: is_top_state
        type: categorical
        label: Is Top 3 State
        description: Boolean flag for SP, RJ, or MG customers (67% of customer base)
        expr: "CASE WHEN customer_state IN ('SP', 'RJ', 'MG') THEN TRUE ELSE FALSE END"
    
    measures:
      - name: customers_count
        agg: count
        label: Customer Records
        description: Total customer records (includes duplicates per order)
      
      - name: customers_unique_count
        agg: count_distinct
        label: Unique Customers
        description: Distinct count of unique individuals (96,096 unique customers)
        expr: customer_unique_id
      
      - name: customers_states_count
        agg: count_distinct
        label: States with Customers
        description: Number of distinct states with customer presence
        expr: customer_state
      
      - name: customers_cities_count
        agg: count_distinct
        label: Cities with Customers
        description: Number of distinct cities with customer presence
        expr: customer_city
      
      - name: customers_zip_codes_count
        agg: count_distinct
        label: Zip Codes with Customers
        description: Number of distinct zip code prefixes
        expr: customer_zip_code_prefix

  - name: products
    description: |
      Product catalog with 32,951 unique products across 73 categories. Products have physical
      dimensions and weights that drive freight costs. Average weight is 2,276g (median 700g),
      ranging from 0g to 40,425g. Average dimensions: 30.8cm length, 16.9cm height, 23.2cm width.
      Most products have 1-2 photos (average 2.19). 1.9% of products missing category data.
    model: ref('products')
    defaults:
      agg_time_dimension: first_sale_date
    
    entities:
      - name: product
        type: primary
        expr: product_id
      - name: product_category
        type: foreign
        expr: product_category_name
    
    dimensions:
      - name: first_sale_date
        type: time
        label: First Sale Date
        description: Date product was first sold (joined from order_items)
        expr: first_sale_timestamp
        type_params:
          time_granularity: day
      
      - name: product_category_name
        type: categorical
        label: Product Category (Portuguese)
        description: Product category in Portuguese (73 categories, 1.9% null)
      
      - name: product_weight_g
        type: categorical
        label: Product Weight (grams)
        description: Product weight in grams (0-40,425g, average 2,276g, median 700g)
      
      - name: product_length_cm
        type: categorical
        label: Product Length (cm)
        description: Product length in centimeters (7-105cm, average 30.8cm)
      
      - name: product_height_cm
        type: categorical
        label: Product Height (cm)
        description: Product height in centimeters (2-105cm, average 16.9cm)
      
      - name: product_width_cm
        type: categorical
        label: Product Width (cm)
        description: Product width in centimeters (6-118cm, average 23.2cm)
      
      - name: product_photos_qty
        type: categorical
        label: Product Photo Count
        description: Number of product photos (1-20, average 2.19, most have 1-2)
      
      - name: product_name_length
        type: categorical
        label: Product Name Length
        description: Character count of product name (5-76, average 48.5)
      
      - name: product_description_length
        type: categorical
        label: Product Description Length
        description: Character count of product description (4-3,992, average 771.5)
      
      - name: weight_category
        type: categorical
        label: Weight Category
        description: Product weight classification for freight analysis
        expr: |
          CASE 
            WHEN product_weight_g < 500 THEN 'Light (<500g)'
            WHEN product_weight_g < 2000 THEN 'Medium (500-2000g)'
            WHEN product_weight_g < 5000 THEN 'Heavy (2000-5000g)'
            ELSE 'Very Heavy (5000g+)'
          END
      
      - name: has_multiple_photos
        type: categorical
        label: Has Multiple Photos
        description: Boolean flag for products with 2+ photos
        expr: "CASE WHEN product_photos_qty >= 2 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: products_count
        agg: count
        label: Total Products
        description: Total number of products in catalog
      
      - name: products_weight_avg
        agg: average
        label: Average Product Weight
        description: Mean product weight in grams (2,276g)
        expr: product_weight_g
      
      - name: products_weight_sum
        agg: sum
        label: Total Catalog Weight
        description: Sum of all product weights
        expr: product_weight_g
      
      - name: products_volume_avg
        agg: average
        label: Average Product Volume
        description: Mean product volume in cubic cm
        expr: "product_length_cm * product_height_cm * product_width_cm"
      
      - name: products_photos_avg
        agg: average
        label: Average Photos per Product
        description: Mean number of product photos (2.19)
        expr: product_photos_qty
      
      - name: products_categories_count
        agg: count_distinct
        label: Product Categories
        description: Number of distinct product categories
        expr: product_category_name

  - name: sellers
    description: |
      Seller dimension table with 3,095 active sellers across Brazil. São Paulo state has
      the most sellers (1,849, 60%), followed by Paraná (349, 11%) and Minas Gerais (244, 8%).
      Sellers span 2,246 zip codes and 611 cities across 23 states. Geographic distribution
      affects fulfillment speed and freight costs.
    model: ref('sellers')
    defaults:
      agg_time_dimension: first_sale_date
    
    entities:
      - name: seller
        type: primary
        expr: seller_id
    
    dimensions:
      - name: first_sale_date
        type: time
        label: First Sale Date
        description: Date of seller's first sale (joined from order_items)
        expr: first_sale_timestamp
        type_params:
          time_granularity: day
      
      - name: seller_state
        type: categorical
        label: Seller State
        description: |
          Brazilian state code (23 states). Top states: SP (60%), PR (11%), MG (8%),
          RJ (5%), SC (4%). São Paulo dominates seller concentration.
      
      - name: seller_city
        type: categorical
        label: Seller City
        description: Seller city name (611 unique cities)
      
      - name: seller_zip_code_prefix
        type: categorical
        label: Seller Zip Code
        description: First 5 digits of seller zip code (2,246 unique prefixes)
      
      - name: is_sao_paulo_seller
        type: categorical
        label: Is São Paulo Seller
        description: Boolean flag for sellers in SP state (60% of sellers)
        expr: "CASE WHEN seller_state = 'SP' THEN TRUE ELSE FALSE END"
    
    measures:
      - name: sellers_count
        agg: count
        label: Total Sellers
        description: Total number of active sellers on platform
      
      - name: sellers_states_count
        agg: count_distinct
        label: States with Sellers
        description: Number of distinct states with seller presence
        expr: seller_state
      
      - name: sellers_cities_count
        agg: count_distinct
        label: Cities with Sellers
        description: Number of distinct cities with seller presence
        expr: seller_city

  - name: product_category_translation
    description: |
      Translation table mapping Portuguese product category names to English equivalents.
      Contains 73 category translations covering the full product taxonomy. Used for
      reporting and international analysis. All categories in the products table have
      corresponding English translations.
    model: ref('product_category_translation')
    defaults:
      agg_time_dimension: created_date
    
    entities:
      - name: product_category
        type: primary
        expr: product_category_name
    
    dimensions:
      - name: created_date
        type: time
        label: Translation Created Date
        description: Date translation was added (static dimension table)
        expr: current_date
        type_params:
          time_granularity: day
      
      - name: product_category_name
        type: categorical
        label: Category Name (Portuguese)
        description: Product category name in Portuguese
      
      - name: product_category_name_english
        type: categorical
        label: Category Name (English)
        description: Product category name translated to English
    
    measures:
      - name: categories_count
        agg: count
        label: Total Categories
        description: Total number of product categories with translations
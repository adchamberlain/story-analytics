business_domain:
  description: "Brazilian e-commerce marketplace (Olist) connecting sellers with customers across Brazil. Platform facilitates order fulfillment, payment processing, and logistics coordination. Data represents actual transactions, customer reviews, and operational metrics from a multi-seller marketplace model similar to Amazon or eBay."
  currency: "BRL (Brazilian Real, R$)"
  date_range: "September 2016 - September 2018 (~2 years)"
  scale: "~100,000 orders, ~96,000 unique customers, ~3,095 sellers"

metric_definitions:
  total_revenue:
    description: "Total payment value from completed orders"
    calculation: "SUM(order_payments.payment_value)"
    standard_filters: "order_status <> 'canceled' OR order_status = 'delivered'"
    notes: "Expected value ~R$15.4-15.9 million for full dataset. Always exclude canceled orders."
    
  gmv:
    description: "Gross Merchandise Value - total value of goods sold"
    calculation: "SUM(order_items.price + order_items.freight_value) OR SUM(order_items.price)"
    standard_filters: "order_status = 'delivered'"
    notes: "Two definitions exist: (1) price only, (2) price + freight. Context determines which to use."
    
  aov:
    description: "Average Order Value"
    calculation: "AVG(order_payments.payment_value) OR AVG(order_items.price)"
    standard_filters: "order_status = 'delivered'"
    notes: "Credit card AOV ~R$162.70, Voucher AOV ~R$62.33"
    
  on_time_delivery_rate:
    description: "Percentage of orders delivered by estimated date"
    calculation: "SUM(CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN 1 ELSE 0 END) * 100.0 / COUNT(*)"
    standard_filters: "order_status = 'delivered' AND order_delivered_customer_date IS NOT NULL"
    notes: "Benchmark: ~63% on-time delivery rate. Critical operational KPI."
    
  delivery_time_days:
    description: "Days from purchase to customer delivery"
    calculation: "order_delivered_customer_date - order_purchase_timestamp (in days)"
    standard_filters: "order_status = 'delivered' AND order_delivered_customer_date IS NOT NULL"
    notes: "Use EXTRACT(EPOCH FROM ...)/86400 for PostgreSQL, DATEDIFF for SQL Server"
    
  repeat_purchase_rate:
    description: "Percentage of customers who make more than one order"
    calculation: "COUNT(customers with order_count > 1) * 100.0 / COUNT(DISTINCT customer_unique_id)"
    standard_filters: "order_status <> 'canceled'"
    notes: "Benchmark: ~3% repeat rate (97% one-time buyers). Critical retention metric."
    
  freight_to_price_ratio:
    description: "Shipping cost as percentage of product price"
    calculation: "SUM(order_items.freight_value) / NULLIF(SUM(order_items.price), 0)"
    standard_filters: "order_status = 'delivered'"
    notes: "Varies by distance and product category. Used for logistics optimization."
    
  avg_review_score:
    description: "Average customer satisfaction rating"
    calculation: "AVG(reviews.review_score)"
    standard_filters: "None typically, but join to delivered orders for operational analysis"
    notes: "Scale 1-5. Benchmark: 4.09/5.0 overall, 56.55% give 5 stars. Strongly correlated with delivery performance."
    
  monthly_revenue:
    description: "Revenue aggregated by calendar month"
    calculation: "SUM(order_payments.payment_value) grouped by DATE_TRUNC('month', order_purchase_timestamp)"
    standard_filters: "order_status <> 'canceled'"
    notes: "Q2 2018 had highest revenue, Q3 2016 had lowest. Used for trend analysis."
    
  customer_lifetime_value:
    description: "Total spending per customer in defined time window"
    calculation: "SUM(order_payments.payment_value) per customer_unique_id within time window"
    standard_filters: "order_status <> 'canceled', typically first 6 months (182.5 days)"
    notes: "Track from first_order_date + INTERVAL '182.5 day'"

standard_filters:
  - name: "exclude_canceled_orders"
    sql: "WHERE order_status <> 'canceled'"
    when_applied: "All revenue, GMV, and financial calculations. Canceled orders should never count toward business metrics."
    
  - name: "delivered_orders_only"
    sql: "WHERE order_status = 'delivered'"
    when_applied: "Product performance, seller performance, review analysis, delivery metrics. Most restrictive filter."
    
  - name: "valid_delivery_dates"
    sql: "WHERE order_delivered_customer_date IS NOT NULL"
    when_applied: "Any delivery time or on-time performance calculation. Prevents NULL date arithmetic."
    
  - name: "minimum_review_threshold"
    sql: "HAVING COUNT(review_id) >= 100"
    when_applied: "Category or seller review analysis to ensure statistical significance."
    
  - name: "minimum_order_threshold"
    sql: "HAVING COUNT(DISTINCT order_id) >= 10"
    when_applied: "Seller performance analysis to filter out low-volume sellers."

join_patterns:
  - tables: ["orders", "order_payments"]
    join_key: "order_id"
    join_type: "INNER"
    notes: "Standard join for all revenue calculations. Always use INNER JOIN."
    
  - tables: ["orders", "order_items"]
    join_key: "order_id"
    join_type: "INNER"
    notes: "For product-level analysis, seller analysis, freight calculations."
    
  - tables: ["orders", "customers"]
    join_key: "customer_id"
    join_type: "INNER"
    notes: "For geographic analysis, customer segmentation. Note: customer_id is NOT unique per customer."
    
  - tables: ["customers", "orders"]
    join_key: "customer_id"
    join_type: "INNER"
    notes: "Always aggregate by customer_unique_id, not customer_id, for accurate customer counts."
    
  - tables: ["order_items", "products"]
    join_key: "product_id"
    join_type: "INNER"
    notes: "For category analysis, product dimensions, weight-based freight analysis."
    
  - tables: ["products", "product_category_name_translation"]
    join_key: "product_category_name"
    join_type: "LEFT"
    notes: "Always LEFT JOIN to get English category names. Some categories may not have translations."
    
  - tables: ["order_items", "sellers"]
    join_key: "seller_id"
    join_type: "INNER"
    notes: "For seller performance, geographic distribution of sellers, multi-seller order analysis."
    
  - tables: ["orders", "reviews"]
    join_key: "order_id"
    join_type: "INNER"
    notes: "For satisfaction analysis. Reviews exist for most but not all orders."
    
  - tables: ["customers", "geolocation"]
    join_key: "customer_zip_code = geolocation_zip_code_prefix"
    join_type: "INNER"
    notes: "For distance calculations, logistics optimization. Use Haversine formula for distance."
    
  - tables: ["sellers", "geolocation"]
    join_key: "seller_zip_code_prefix = geolocation_zip_code_prefix"
    join_type: "INNER"
    notes: "For seller-to-customer distance calculations affecting freight and delivery time."

naming_conventions:
  - concept: "Gross transaction value"
    preferred_name: "GMV"
    alternatives: ["revenue", "total_revenue", "category_revenue"]
    notes: "GMV and revenue used somewhat interchangeably, but GMV typically includes freight"
    
  - concept: "Customer identifier"
    preferred_name: "customer_unique_id"
    alternatives: ["customer_id"]
    notes: "CRITICAL: Always use customer_unique_id for counting customers. customer_id can repeat."
    
  - concept: "Product price"
    preferred_name: "price"
    alternatives: ["item_price", "product_revenue"]
    notes: "From order_items.price, excludes freight"
    
  - concept: "Shipping cost"
    preferred_name: "freight_value"
    alternatives: ["shipping_cost", "freight", "freight_cost"]
    notes: "Always from order_items.freight_value"
    
  - concept: "Order completion"
    preferred_name: "delivered"
    alternatives: ["completed", "fulfilled"]
    notes: "order_status = 'delivered' is the canonical completed state"
    
  - concept: "Customer satisfaction"
    preferred_name: "review_score"
    alternatives: ["rating", "satisfaction_score"]
    notes: "Scale 1-5 from reviews.review_score"
    
  - concept: "Geographic region"
    preferred_name: "state"
    alternatives: ["customer_state", "seller_state", "region"]
    notes: "Use 2-letter state codes (SP, RJ, MG). State preferred over city for aggregation."
    
  - concept: "Time period grouping"
    preferred_name: "month" or "cohort_month"
    alternatives: ["period", "date", "order_month"]
    notes: "Use DATE_TRUNC('month', ...) for monthly aggregations"
    
  - concept: "First purchase date"
    preferred_name: "first_order_date"
    alternatives: ["cohort_date", "acquisition_date"]
    notes: "MIN(order_purchase_timestamp) per customer_unique_id"

key_dimensions:
  - dimension: "DATE_TRUNC('month', order_purchase_timestamp)"
    used_for: "Monthly trend analysis, time series, MoM growth, cohort definition"
    
  - dimension: "customer_state"
    used_for: "Geographic performance, regional revenue, delivery performance by region"
    notes: "SP (São Paulo) dominates at ~46% of customers"
    
  - dimension: "product_category_name_english"
    used_for: "Category performance, product mix analysis, AOV by category"
    notes: "Top category: bed_bath_table (~R$1.69M revenue)"
    
  - dimension: "payment_type"
    used_for: "Payment method analysis, installment behavior, financial strategy"
    notes: "credit_card ~76%, boleto ~18%, voucher ~4%, debit_card ~2%"
    
  - dimension: "seller_id / seller_state"
    used_for: "Seller performance ranking, marketplace coverage, seller quality"
    
  - dimension: "review_score"
    used_for: "Satisfaction distribution, quality analysis, correlation with delivery"
    
  - dimension: "order_status"
    used_for: "Order lifecycle analysis, cancellation rates, operational health"
    notes: "Statuses: delivered, shipped, canceled, processing, unavailable, etc."
    
  - dimension: "EXTRACT(DOW FROM order_purchase_timestamp)"
    used_for: "Day of week patterns, weekly seasonality, staffing planning"
    
  - dimension: "cohort_month"
    used_for: "Cohort retention analysis, customer lifetime value tracking"
    notes: "Defined as DATE_TRUNC('month', MIN(order_purchase_timestamp))"

business_rules:
  - rule: "On-time delivery definition"
    sql_pattern: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN 'On Time' ELSE 'Late' END"
    notes: "Critical for logistics KPIs. Late delivery strongly correlates with poor reviews."
    
  - rule: "Repeat customer identification"
    sql_pattern: "CASE WHEN order_count > 1 THEN 1 ELSE 0 END"
    notes: "Only ~3% of customers are repeat buyers. Major retention opportunity."
    
  - rule: "Freight cost bucketing"
    sql_pattern: "CASE WHEN freight_value < 10 THEN '< R$10' WHEN freight_value < 20 THEN 'R$10-20' WHEN freight_value < 30 THEN 'R$20-30' ELSE 'R$30+' END"
    notes: "Used for logistics cost analysis and delivery time correlation."
    
  - rule: "Product weight categories"
    sql_pattern: "CASE WHEN product_weight_g < 500 THEN 'Light' WHEN product_weight_g < 2000 THEN 'Medium' WHEN product_weight_g < 5000 THEN 'Heavy' ELSE 'Very Heavy' END"
    notes: "Weight drives freight costs. Used for logistics pricing analysis."
    
  - rule: "Distance bucketing for logistics"
    sql_pattern: "CASE WHEN distance_km < 100 THEN '< 100km' WHEN distance_km < 500 THEN '100-500km' WHEN distance_km < 1000 THEN '500-1000km' ELSE '1000km+' END"
    notes: "Distance calculated using Haversine formula. Drives shipping cost and delivery time."
    
  - rule: "Positive review definition"
    sql_pattern: "CASE WHEN review_score >= 4 THEN 1 ELSE 0 END"
    notes: "4-5 stars considered positive. Used for seller quality metrics."
    
  - rule: "Multi-seller order complexity"
    sql_pattern: "COUNT(DISTINCT seller_id) per order_id"
    notes: "Orders with multiple sellers require coordination. Affects fulfillment complexity."
    
  - rule: "Order timeline validation"
    sql_pattern: "WHERE order_approved_at >= order_purchase_timestamp AND order_delivered_carrier_date >= order_approved_at AND order_delivered_customer_date >= order_delivered_carrier_date"
    notes: "Data quality check. Dates must be in logical sequence."
    
  - rule: "Payment reconciliation"
    sql_pattern: "ABS(SUM(order_items.price + order_items.freight_value) - SUM(order_payments.payment_value)) < 0.01"
    notes: "Financial reconciliation. Payment total should match order items total within rounding."
    
  - rule: "Customer lifetime value window"
    sql_pattern: "WHERE order_purchase_timestamp < first_order_date + INTERVAL '182.5 day'"
    notes: "Standard 6-month window for CLV analysis. 182.5 days = ~6 months."

analytical_patterns:
  - pattern: "Monthly time series"
    description: "Aggregate metrics by calendar month for trend analysis"
    key_tables: ["orders", "order_payments"]
    sql_structure: "DATE_TRUNC('month', order_purchase_timestamp) GROUP BY month ORDER BY month"
    notes: "Used for revenue trends, order volume, MoM growth calculations"
    
  - pattern: "Cohort retention analysis"
    description: "Track customer activity over time from first purchase date"
    key_tables: ["customers", "orders"]
    sql_structure: "CTE for first_purchase (cohort_month), CTE for monthly_activity, join and calculate months_since_cohort"
    notes: "Critical for understanding retention. Only ~3% repeat rate indicates retention problem."
    
  - pattern: "Geographic performance"
    description: "Aggregate metrics by customer_state or customer_city"
    key_tables: ["customers", "orders", "order_payments"]
    sql_structure: "GROUP BY customer_state ORDER BY revenue/customers DESC"
    notes: "SP dominates at 46%. Top 10 states = 90%+ of business."
    
  - pattern: "Category performance ranking"
    description: "Rank product categories by revenue, orders, AOV"
    key_tables: ["order_items", "products", "product_category_name_translation"]
    sql_structure: "LEFT JOIN for translation, GROUP BY category, ORDER BY revenue DESC LIMIT 20"
    notes: "bed_bath_table is top category. Always use English translation."
    
  - pattern: "Delivery performance analysis"
    description: "Calculate on-time rate, delivery time, late orders"
    key_tables: ["orders"]
    sql_structure: "CASE for on-time logic, date arithmetic for delivery_days, filter for delivered + NOT NULL dates"
    notes: "~63% on-time benchmark. Late delivery = poor reviews."
    
  - pattern: "Seller performance ranking"
    description: "Rank sellers by revenue, orders, review scores"
    key_tables: ["sellers", "order_items", "orders", "reviews"]
    sql_structure: "GROUP BY seller_id, HAVING minimum order threshold, ORDER BY revenue DESC"
    notes: "Filter for sellers with >= 10 orders for statistical significance."
    
  - pattern: "Payment method analysis"
    description: "Distribution of payment types, installment behavior"
    key_tables: ["order_payments", "orders"]
    sql_structure: "GROUP BY payment_type, calculate percentages, AVG(payment_installments)"
    notes: "Credit card 76%, most use 1 installment. Credit card AOV highest."
    
  - pattern: "Review correlation analysis"
    description: "Correlate review scores with delivery performance, category, seller"
    key_tables: ["reviews", "orders", "order_items", "products"]
    sql_structure: "JOIN reviews to orders, CASE for delivery_status, GROUP BY and AVG(review_score)"
    notes: "Late delivery strongly predicts poor reviews. Avg 4.09/5.0 overall."
    
  - pattern: "RFM segmentation"
    description: "Recency, Frequency, Monetary analysis for customer segmentation"
    key_tables: ["customers", "orders", "order_payments"]
    sql_structure: "GROUP BY customer_unique_id, calculate days since last order, COUNT orders, SUM payment_value"
    notes: "Used for marketing segmentation. Most customers are one-time buyers."
    
  - pattern: "Freight cost optimization"
    description: "Analyze freight costs by distance, weight, category"
    key_tables: ["order_items", "products", "geolocation", "customers", "sellers"]
    sql_structure: "Haversine distance calculation, GROUP BY distance/weight buckets, AVG(freight_value)"
    notes: "Distance and weight drive freight. Formula: 111 * SQRT(POW(lat_diff, 2) + POW(lng_diff * COS(lat), 2))"
    
  - pattern: "Month-over-month growth"
    description: "Calculate period-over-period growth rates"
    key_tables: ["orders", "order_payments"]
    sql_structure: "CTE for monthly_stats, LAG() window function for previous period, calculate growth %"
    notes: "Used for executive reporting. Shows business momentum."
    
  - pattern: "Multi-seller order complexity"
    description: "Analyze orders with multiple sellers"
    key_tables: ["orders", "order_items"]
    sql_structure: "Subquery: COUNT(DISTINCT seller_id) per order_id, outer query: GROUP BY seller_count"
    notes: "Multi-seller orders require coordination. Affects fulfillment complexity."
    
  - pattern: "Data quality validation"
    description: "Check for duplicates, NULL values, logical inconsistencies"
    key_tables: ["all tables"]
    sql_structure: "COUNT(*) vs COUNT(DISTINCT), date sequence validation, reconciliation queries"
    notes: "Always validate: order_id uniqueness, date sequences, payment reconciliation, geolocation matches"

key_business_insights:
  - insight: "Low repeat purchase rate"
    value: "~3% of customers make repeat purchases"
    implication: "Major retention opportunity. Focus on customer lifecycle marketing."
    
  - insight: "Geographic concentration"
    value: "São Paulo (SP) = 46% of customers, SP + RJ > 50%"
    implication: "Business highly concentrated in Southeast Brazil. Expansion opportunity in other regions."
    
  - insight: "Delivery performance gap"
    value: "Only 63% on-time delivery rate"
    implication: "Logistics improvement needed. Late delivery = poor reviews."
    
  - insight: "Payment preference"
    value: "Credit card 76%, boleto 18%"
    implication: "Credit card dominant. Most pay in 1 installment despite installment option."
    
  - insight: "Category concentration"
    value: "bed_bath_table is top category by revenue"
    implication: "Home goods drive business. Low AOV but high volume."
    
  - insight: "Review-delivery correlation"
    value: "Late delivery strongly predicts poor reviews"
    implication: "Delivery performance is primary driver of satisfaction, not just product quality."
    
  - insight: "One-time buyer dominance"
    value: "97% of customers make only one purchase"
    implication: "Acquisition-focused business model. Need retention strategy."

data_quality_considerations:
  - consideration: "Customer ID vs Unique ID"
    issue: "customer_id can repeat per customer"
    solution: "Always use customer_unique_id for customer counts"
    
  - consideration: "Payment reconciliation"
    issue: "order_items total may not match order_payments total"
    solution: "Check ABS(difference) < 0.01 for rounding. Investigate larger discrepancies."
    
  - consideration: "Geolocation matching"
    issue: "customer_city may not match geolocation_city for same zip"
    solution: "Use geolocation table as source of truth for coordinates"
    
  - consideration: "Date sequence validation"
    issue: "Order dates may be out of logical sequence"
    solution: "Validate: purchase < approved < carrier < delivered"
    
  - consideration: "NULL delivery dates"
    issue: "Some delivered orders have NULL delivery dates"
    solution: "Always filter: order_delivered_customer_date IS NOT NULL for time calculations"
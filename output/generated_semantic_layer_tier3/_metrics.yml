version: 2

metrics:
  # ============================================================================
  # REVENUE & GMV METRICS
  # ============================================================================
  
  - name: gmv
    label: GMV (Gross Merchandise Value)
    description: |
      Total product value excluding freight - the primary top-line revenue metric.
      Total dataset GMV: R$13.6M. Always exclude canceled orders from revenue calculations.
    type: simple
    type_params:
      measure: gmv_total
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: realized_gmv
    label: Realized GMV
    description: |
      GMV from delivered orders only - represents actual completed revenue.
      97% of orders reach delivered status.
    type: simple
    type_params:
      measure: gmv_total
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: total_revenue
    label: Total Revenue
    description: |
      Total revenue including product price and freight charges.
      Excludes canceled orders.
    type: simple
    type_params:
      measure: total_revenue
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: freight_revenue
    label: Freight Revenue
    description: |
      Total shipping charges collected from customers.
      Median freight R$16.26, mean R$19.99.
    type: simple
    type_params:
      measure: freight_revenue_total
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: aov
    label: AOV (Average Order Value)
    description: |
      Average order value - GMV divided by order count.
      Dataset average: R$137. Preferred business abbreviation is "AOV".
    type: derived
    type_params:
      expr: gmv / NULLIF(orders, 0)
      metrics:
        - name: gmv
        - name: orders
  
  - name: revenue_per_customer
    label: Revenue per Customer
    description: |
      Total GMV divided by unique customer count - measures monetization efficiency.
      Use customer_unique_id for accurate customer counts.
    type: derived
    type_params:
      expr: gmv / NULLIF(unique_customers, 0)
      metrics:
        - name: gmv
        - name: unique_customers
  
  - name: avg_item_price
    label: Average Item Price
    description: |
      Mean item price across all items sold.
      R$120.65 average, R$74.99 median.
    type: simple
    type_params:
      measure: avg_item_price
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: avg_freight_value
    label: Average Freight Value
    description: |
      Mean shipping cost per item.
      R$19.99 average, R$16.26 median.
    type: simple
    type_params:
      measure: avg_freight_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: freight_to_price_ratio
    label: Freight to Price Ratio
    description: |
      Shipping cost as percentage of product price.
      Used for logistics optimization and pricing analysis.
    type: derived
    type_params:
      expr: freight_revenue / NULLIF(gmv, 0)
      metrics:
        - name: freight_revenue
        - name: gmv
  
  # ============================================================================
  # CUMULATIVE REVENUE METRICS
  # ============================================================================
  
  - name: cumulative_gmv
    label: Cumulative GMV
    description: |
      Running total of GMV over time - tracks cumulative revenue growth.
      Used for all-time revenue tracking and growth visualization.
    type: cumulative
    type_params:
      measure: gmv_total
  
  - name: gmv_mtd
    label: GMV Month-to-Date
    description: |
      GMV accumulated from the start of the current month.
      Used for monthly performance tracking against targets.
    type: cumulative
    type_params:
      measure: gmv_total
      grain_to_date: month
  
  - name: cumulative_revenue
    label: Cumulative Total Revenue
    description: |
      Running total of revenue including freight over time.
    type: cumulative
    type_params:
      measure: total_revenue
  
  # ============================================================================
  # VOLUME METRICS
  # ============================================================================
  
  - name: orders
    label: Orders
    description: |
      Total count of orders excluding canceled.
      Total dataset: 99,441 orders, 97% delivered.
    type: simple
    type_params:
      measure: orders_total_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: delivered_orders
    label: Delivered Orders
    description: |
      Count of orders that reached delivered status.
      97% of orders are delivered.
    type: simple
    type_params:
      measure: orders_delivered_count
  
  - name: canceled_orders
    label: Canceled Orders
    description: |
      Count of canceled orders.
      0.6% cancellation rate.
    type: simple
    type_params:
      measure: orders_canceled_count
  
  - name: items_sold
    label: Items Sold
    description: |
      Total count of items sold across all orders.
      112,650 items across 99,441 orders.
    type: simple
    type_params:
      measure: order_items_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: items_per_order
    label: Items per Order
    description: |
      Average number of items per order.
      Mean 1.13 items per order, 87.6% of orders have single item.
    type: derived
    type_params:
      expr: items_sold / NULLIF(orders, 0)
      metrics:
        - name: items_sold
        - name: orders
  
  - name: unique_customers
    label: Unique Customers
    description: |
      Count of unique customers using customer_unique_id.
      CRITICAL: Always use customer_unique_id, not customer_id.
      96,096 unique customers in dataset.
    type: simple
    type_params:
      measure: customer_count
  
  - name: active_sellers
    label: Active Sellers
    description: |
      Count of sellers with sales in the period.
      3,095 sellers total.
    type: simple
    type_params:
      measure: seller_count
  
  - name: active_products
    label: Active Products
    description: |
      Count of products sold in the period.
      32,951 products total across 73 categories.
    type: simple
    type_params:
      measure: product_count
  
  # ============================================================================
  # CUSTOMER METRICS
  # ============================================================================
  
  - name: orders_per_customer
    label: Orders per Customer
    description: |
      Average number of orders per unique customer.
      Very low at ~1.03, indicating minimal repeat purchases.
    type: derived
    type_params:
      expr: orders / NULLIF(unique_customers, 0)
      metrics:
        - name: orders
        - name: unique_customers
  
  - name: repeat_purchase_rate
    label: Repeat Purchase Rate
    description: |
      Percentage of customers with more than one order.
      Only ~3% repeat rate - major retention opportunity.
      Calculated as (customers with >1 order) / total customers.
    type: derived
    type_params:
      expr: (unique_customers - first_time_customers) / NULLIF(unique_customers, 0) * 100
      metrics:
        - name: unique_customers
        - name: first_time_customers
  
  - name: first_time_customers
    label: First Time Customers
    description: |
      Count of customers making their first purchase in the period.
      ~97% of customers are one-time buyers.
    type: simple
    type_params:
      measure: customer_count
    filter: |
      {{ Dimension('customer__first_order_date') }} >= {{ TimeDimension('metric_time', 'day') }}
  
  # ============================================================================
  # DELIVERY PERFORMANCE METRICS
  # ============================================================================
  
  - name: avg_delivery_days
    label: Average Delivery Days
    description: |
      Average calendar days from order purchase to customer delivery.
      Critical operational KPI for customer satisfaction.
    type: derived
    type_params:
      expr: delivery_days_total / NULLIF(delivered_orders, 0)
      metrics:
        - name: delivery_days_total
          alias: delivery_days_total
        - name: delivered_orders
  
  - name: delivery_days_total
    label: Total Delivery Days
    description: |
      Sum of days from purchase to delivery across all orders.
      Used to calculate average delivery time.
    type: simple
    type_params:
      measure: delivery_days_total
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: avg_shipping_days
    label: Average Shipping Days
    description: |
      Average calendar days from carrier handoff to customer delivery.
      Measures carrier transit time specifically.
    type: derived
    type_params:
      expr: shipping_days_total / NULLIF(delivered_orders, 0)
      metrics:
        - name: shipping_days_total
          alias: shipping_days_total
        - name: delivered_orders
  
  - name: shipping_days_total
    label: Total Shipping Days
    description: |
      Sum of days from carrier handoff to delivery.
      Used to calculate average shipping time.
    type: simple
    type_params:
      measure: shipping_days_total
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: on_time_delivery_rate
    label: On-Time Delivery Rate
    description: |
      Percentage of orders delivered on or before estimated date.
      Benchmark: 63% on-time rate. Most critical operational KPI.
      Late delivery strongly predicts poor reviews.
    type: derived
    type_params:
      expr: on_time_orders / NULLIF(delivered_orders, 0) * 100
      metrics:
        - name: on_time_orders
        - name: delivered_orders
  
  - name: on_time_orders
    label: On-Time Orders
    description: |
      Count of orders delivered on or before estimated date.
      ~63% of delivered orders are on-time.
    type: simple
    type_params:
      measure: orders_on_time_count
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: late_orders
    label: Late Orders
    description: |
      Count of orders delivered after estimated date.
      ~37% of delivered orders are late.
    type: simple
    type_params:
      measure: orders_late_count
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: late_delivery_rate
    label: Late Delivery Rate
    description: |
      Percentage of orders delivered after estimated date.
      ~37% late delivery rate - major operational issue.
    type: derived
    type_params:
      expr: late_orders / NULLIF(delivered_orders, 0) * 100
      metrics:
        - name: late_orders
        - name: delivered_orders
  
  # ============================================================================
  # CUSTOMER SATISFACTION METRICS
  # ============================================================================
  
  - name: avg_review_score
    label: Average Review Score
    description: |
      Mean customer satisfaction rating on 1-5 scale.
      Dataset average: 4.09/5.0. Strongly correlated with delivery performance.
    type: simple
    type_params:
      measure: avg_review_score
  
  - name: review_count
    label: Review Count
    description: |
      Total count of reviews submitted.
      99,224 reviews in dataset.
    type: simple
    type_params:
      measure: review_count
  
  - name: five_star_rate
    label: Five Star Rate
    description: |
      Percentage of reviews that are 5 stars.
      57.8% of reviews are 5 stars - bimodal distribution.
    type: derived
    type_params:
      expr: five_star_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: five_star_count
        - name: review_count
  
  - name: five_star_count
    label: Five Star Count
    description: |
      Count of 5-star reviews.
      57.8% of all reviews.
    type: simple
    type_params:
      measure: five_star_count
  
  - name: one_star_rate
    label: One Star Rate
    description: |
      Percentage of reviews that are 1 star.
      11.5% of reviews are 1 star.
    type: derived
    type_params:
      expr: one_star_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: one_star_count
        - name: review_count
  
  - name: one_star_count
    label: One Star Count
    description: |
      Count of 1-star reviews.
      11.5% of all reviews.
    type: simple
    type_params:
      measure: one_star_count
  
  - name: positive_review_rate
    label: Positive Review Rate
    description: |
      Percentage of reviews with 4 or 5 stars.
      77.1% positive review rate.
    type: derived
    type_params:
      expr: positive_review_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: positive_review_count
        - name: review_count
  
  - name: positive_review_count
    label: Positive Review Count
    description: |
      Count of 4-5 star reviews.
      77.1% of all reviews.
    type: simple
    type_params:
      measure: positive_review_count
  
  - name: negative_review_rate
    label: Negative Review Rate
    description: |
      Percentage of reviews with 1 or 2 stars.
      14.7% negative review rate.
    type: derived
    type_params:
      expr: negative_review_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: negative_review_count
        - name: review_count
  
  - name: negative_review_count
    label: Negative Review Count
    description: |
      Count of 1-2 star reviews.
      14.7% of all reviews.
    type: simple
    type_params:
      measure: negative_review_count
  
  # ============================================================================
  # PAYMENT METRICS
  # ============================================================================
  
  - name: total_payment_value
    label: Total Payment Value
    description: |
      Total payment value across all payment methods.
      Should reconcile with GMV + freight within rounding.
    type: simple
    type_params:
      measure: payment_value_total
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: avg_payment_value
    label: Average Payment Value
    description: |
      Mean payment value per transaction.
      R$154.10 average.
    type: simple
    type_params:
      measure: avg_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: credit_card_revenue
    label: Credit Card Revenue
    description: |
      Total payment value from credit cards.
      73.9% of total payment value.
    type: simple
    type_params:
      measure: credit_card_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: boleto_revenue
    label: Boleto Revenue
    description: |
      Total payment value from boleto bank slips.
      19% of total payment value. Boleto is unique to Brazil.
    type: simple
    type_params:
      measure: boleto_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: voucher_revenue
    label: Voucher Revenue
    description: |
      Total payment value from vouchers.
      5.5% of total payment value.
    type: simple
    type_params:
      measure: voucher_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: credit_card_share
    label: Credit Card Share
    description: |
      Percentage of payment value from credit cards.
      ~74% credit card share.
    type: derived
    type_params:
      expr: credit_card_revenue / NULLIF(total_payment_value, 0) * 100
      metrics:
        - name: credit_card_revenue
        - name: total_payment_value
  
  - name: avg_installments
    label: Average Installments
    description: |
      Average number of installments for credit card payments.
      2.85 average, but 50.6% pay in 1 installment.
    type: simple
    type_params:
      measure: avg_installments
    filter: |
      {{ Dimension('order_payment__payment_type') }} = 'credit_card'
  
  # ============================================================================
  # MARKETPLACE HEALTH METRICS
  # ============================================================================
  
  - name: gmv_per_seller
    label: GMV per Seller
    description: |
      Average GMV per active seller - measures seller productivity.
      Used for marketplace health monitoring.
    type: derived
    type_params:
      expr: gmv / NULLIF(active_sellers, 0)
      metrics:
        - name: gmv
        - name: active_sellers
  
  - name: items_per_seller
    label: Items per Seller
    description: |
      Average items sold per active seller - measures seller activity.
    type: derived
    type_params:
      expr: items_sold / NULLIF(active_sellers, 0)
      metrics:
        - name: items_sold
        - name: active_sellers
  
  - name: orders_per_seller
    label: Orders per Seller
    description: |
      Average orders per active seller.
    type: derived
    type_params:
      expr: orders / NULLIF(active_sellers, 0)
      metrics:
        - name: orders
        - name: active_sellers
  
  - name: cancellation_rate
    label: Cancellation Rate
    description: |
      Percentage of orders that are canceled.
      0.6% cancellation rate.
    type: derived
    type_params:
      expr: canceled_orders / NULLIF(orders + canceled_orders, 0) * 100
      metrics:
        - name: canceled_orders
        - name: orders
  
  # ============================================================================
  # GROWTH METRICS (Month-over-Month)
  # ============================================================================
  
  - name: gmv_mom_growth
    label: GMV Month-over-Month Growth
    description: |
      Month-over-month GMV growth rate as percentage.
      Used for executive reporting and trend analysis.
    type: derived
    type_params:
      expr: (gmv - gmv_prior_month) / NULLIF(gmv_prior_month, 0) * 100
      metrics:
        - name: gmv
        - name: gmv
          alias: gmv_prior_month
          offset_window: 1 month
  
  - name: orders_mom_growth
    label: Orders Month-over-Month Growth
    description: |
      Month-over-month order volume growth rate as percentage.
    type: derived
    type_params:
      expr: (orders - orders_prior_month) / NULLIF(orders_prior_month, 0) * 100
      metrics:
        - name: orders
        - name: orders
          alias: orders_prior_month
          offset_window: 1 month
  
  - name: customers_mom_growth
    label: Customers Month-over-Month Growth
    description: |
      Month-over-month unique customer growth rate as percentage.
    type: derived
    type_params:
      expr: (unique_customers - unique_customers_prior_month) / NULLIF(unique_customers_prior_month, 0) * 100
      metrics:
        - name: unique_customers
        - name: unique_customers
          alias: unique_customers_prior_month
          offset_window: 1 month
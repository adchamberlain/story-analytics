version: 2

semantic_models:
  - name: orders
    description: |
      Core order fact table representing the complete order lifecycle from purchase through delivery.
      Each row is one order. 97% of orders reach delivered status. This is the primary fact table
      for order-level analysis, revenue trends, and delivery performance metrics.
    model: ref('orders')
    defaults:
      agg_time_dimension: order_purchase_date
    
    entities:
      - name: order
        type: primary
        expr: order_id
      - name: customer
        type: foreign
        expr: customer_id
    
    dimensions:
      - name: order_purchase_date
        type: time
        label: Order Purchase Date
        description: When the customer placed the order - primary time dimension for all order analysis
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: order_approved_date
        type: time
        label: Order Approved Date
        description: When payment was approved (0.2% null for canceled orders)
        expr: order_approved_at
        type_params:
          time_granularity: day
      
      - name: order_delivered_carrier_date
        type: time
        label: Delivered to Carrier Date
        description: When seller handed package to carrier (1.8% null)
        expr: order_delivered_carrier_date
        type_params:
          time_granularity: day
      
      - name: order_delivered_customer_date
        type: time
        label: Delivered to Customer Date
        description: When customer received the package (3.0% null)
        expr: order_delivered_customer_date
        type_params:
          time_granularity: day
      
      - name: order_estimated_delivery_date
        type: time
        label: Estimated Delivery Date
        description: Estimated delivery date shown to customer at purchase
        expr: order_estimated_delivery_date
        type_params:
          time_granularity: day
      
      - name: order_status
        type: categorical
        label: Order Status
        description: Order lifecycle stage - delivered (97%), shipped (1.1%), canceled (0.6%), processing, unavailable, etc.
      
      - name: is_delivered
        type: categorical
        label: Is Delivered
        description: Whether order reached delivered status
        expr: "CASE WHEN order_status = 'delivered' THEN TRUE ELSE FALSE END"
      
      - name: is_canceled
        type: categorical
        label: Is Canceled
        description: Whether order was canceled
        expr: "CASE WHEN order_status = 'canceled' THEN TRUE ELSE FALSE END"
      
      - name: is_on_time
        type: categorical
        label: Is On Time
        description: Whether order was delivered on or before estimated date (63% on-time rate)
        expr: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN TRUE ELSE FALSE END"
    
    measures:
      - name: orders_total_count
        agg: count
        label: Total Orders
        description: Total count of all orders including canceled (99,441 orders)
      
      - name: orders_delivered_count
        agg: count
        label: Delivered Orders
        description: Count of orders that reached delivered status (97% of total)
        expr: "CASE WHEN order_status = 'delivered' THEN order_id END"
      
      - name: orders_canceled_count
        agg: count
        label: Canceled Orders
        description: Count of canceled orders (0.6% of total)
        expr: "CASE WHEN order_status = 'canceled' THEN order_id END"
      
      - name: orders_on_time_count
        agg: count
        label: On-Time Orders
        description: Count of orders delivered on or before estimated date
        expr: "CASE WHEN order_delivered_customer_date <= order_estimated_delivery_date THEN order_id END"
      
      - name: orders_late_count
        agg: count
        label: Late Orders
        description: Count of orders delivered after estimated date
        expr: "CASE WHEN order_delivered_customer_date > order_estimated_delivery_date THEN order_id END"
      
      - name: delivery_days_total
        agg: sum
        label: Total Delivery Days
        description: Sum of days from purchase to customer delivery
        expr: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp)) / 86400"
      
      - name: shipping_days_total
        agg: sum
        label: Total Shipping Days
        description: Sum of days from carrier handoff to customer delivery
        expr: "EXTRACT(EPOCH FROM (order_delivered_customer_date - order_delivered_carrier_date)) / 86400"

  - name: order_items
    description: |
      Line items within orders - one row per product per order. Most orders (87.6%) have a single item,
      max is 21 items. This is the primary fact table for GMV, revenue, freight analysis, and
      product/seller performance. Total 112,650 items across 99,441 orders.
    model: ref('order_items')
    defaults:
      agg_time_dimension: order_purchase_date
    
    entities:
      - name: order_item
        type: primary
        expr: "order_id || '-' || order_item_id"
      - name: order
        type: foreign
        expr: order_id
      - name: product
        type: foreign
        expr: product_id
      - name: seller
        type: foreign
        expr: seller_id
    
    dimensions:
      - name: order_purchase_date
        type: time
        label: Order Purchase Date
        description: When the order was placed (joined from orders table)
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: shipping_limit_date
        type: time
        label: Shipping Limit Date
        description: Deadline for seller to ship - used for seller SLA compliance tracking
        expr: shipping_limit_date
        type_params:
          time_granularity: day
      
      - name: order_item_sequence
        type: categorical
        label: Order Item Sequence
        description: Sequential item number within order (1-21)
        expr: order_item_id
      
      - name: price_bucket
        type: categorical
        label: Price Bucket
        description: Item price range - median R$74.99, mean R$120.65
        expr: |
          CASE 
            WHEN price < 50 THEN '< R$50'
            WHEN price < 100 THEN 'R$50-100'
            WHEN price < 200 THEN 'R$100-200'
            WHEN price < 500 THEN 'R$200-500'
            ELSE 'R$500+'
          END
      
      - name: freight_bucket
        type: categorical
        label: Freight Bucket
        description: Shipping cost range - median R$16.26, used for logistics analysis
        expr: |
          CASE 
            WHEN freight_value < 10 THEN '< R$10'
            WHEN freight_value < 20 THEN 'R$10-20'
            WHEN freight_value < 30 THEN 'R$20-30'
            ELSE 'R$30+'
          END
    
    measures:
      - name: order_items_count
        agg: count
        label: Items Sold
        description: Total count of items sold (112,650 items)
      
      - name: gmv_total
        agg: sum
        label: GMV (Gross Merchandise Value)
        description: Total product value excluding freight - primary revenue metric (R$13.6M total)
        expr: price
      
      - name: freight_revenue_total
        agg: sum
        label: Freight Revenue
        description: Total shipping charges collected from customers
        expr: freight_value
      
      - name: total_revenue
        agg: sum
        label: Total Revenue
        description: Total revenue including product price and freight charges
        expr: price + freight_value
      
      - name: avg_item_price
        agg: average
        label: Average Item Price
        description: Mean item price (R$120.65 average)
        expr: price
      
      - name: avg_freight_value
        agg: average
        label: Average Freight Value
        description: Mean shipping cost per item (R$19.99 average)
        expr: freight_value
      
      - name: max_item_price
        agg: max
        label: Maximum Item Price
        description: Highest item price in the period
        expr: price
      
      - name: min_item_price
        agg: min
        label: Minimum Item Price
        description: Lowest item price in the period
        expr: price

  - name: order_payments
    description: |
      Payment details for orders - one row per payment method used. Most orders (95.7%) have a single
      payment, but orders can split payment across multiple methods (e.g., credit card + voucher).
      Credit cards dominate at 73.9%, followed by boleto (19%) and voucher (5.5%).
    model: ref('order_payments')
    defaults:
      agg_time_dimension: order_purchase_date
    
    entities:
      - name: order_payment
        type: primary
        expr: "order_id || '-' || payment_sequential"
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: order_purchase_date
        type: time
        label: Order Purchase Date
        description: When the order was placed (joined from orders table)
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: payment_type
        type: categorical
        label: Payment Type
        description: Payment method - credit_card (73.9%), boleto (19%), voucher (5.5%), debit_card (1.5%)
      
      - name: payment_sequential
        type: categorical
        label: Payment Sequential
        description: Sequential payment number within order (95.7% have only 1 payment)
      
      - name: installment_bucket
        type: categorical
        label: Installment Bucket
        description: Number of installments for credit card payments (50.6% pay in 1 installment)
        expr: |
          CASE 
            WHEN payment_installments = 1 THEN '1 installment'
            WHEN payment_installments BETWEEN 2 AND 3 THEN '2-3 installments'
            WHEN payment_installments BETWEEN 4 AND 6 THEN '4-6 installments'
            WHEN payment_installments BETWEEN 7 AND 12 THEN '7-12 installments'
            ELSE '13+ installments'
          END
    
    measures:
      - name: payment_count
        agg: count
        label: Payment Count
        description: Total count of payment transactions (103,886 payments)
      
      - name: payment_value_total
        agg: sum
        label: Total Payment Value
        description: Total payment value across all payment methods
        expr: payment_value
      
      - name: avg_payment_value
        agg: average
        label: Average Payment Value
        description: Mean payment value per transaction (R$154.10 average)
        expr: payment_value
      
      - name: avg_installments
        agg: average
        label: Average Installments
        description: Mean number of installments for credit card payments (2.85 average)
        expr: payment_installments
      
      - name: credit_card_payment_value
        agg: sum
        label: Credit Card Payment Value
        description: Total payment value from credit cards (73.9% of total)
        expr: "CASE WHEN payment_type = 'credit_card' THEN payment_value END"
      
      - name: boleto_payment_value
        agg: sum
        label: Boleto Payment Value
        description: Total payment value from boleto bank slips (19% of total)
        expr: "CASE WHEN payment_type = 'boleto' THEN payment_value END"
      
      - name: voucher_payment_value
        agg: sum
        label: Voucher Payment Value
        description: Total payment value from vouchers (5.5% of total)
        expr: "CASE WHEN payment_type = 'voucher' THEN payment_value END"

  - name: order_reviews
    description: |
      Customer reviews - one row per review. Bimodal distribution with 57.8% giving 5 stars and
      11.5% giving 1 star. Mean score 4.09/5.0. Most reviews (58.7%) have no comment text.
      Late delivery strongly predicts poor reviews - critical for satisfaction analysis.
    model: ref('order_reviews')
    defaults:
      agg_time_dimension: review_creation_date
    
    entities:
      - name: review
        type: primary
        expr: review_id
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: review_creation_date
        type: time
        label: Review Creation Date
        description: When the review was submitted by the customer
        expr: review_creation_date
        type_params:
          time_granularity: day
      
      - name: review_answer_date
        type: time
        label: Review Answer Date
        description: When the review was processed/answered
        expr: review_answer_timestamp
        type_params:
          time_granularity: day
      
      - name: review_score
        type: categorical
        label: Review Score
        description: Customer satisfaction rating 1-5 (mean 4.09, 57.8% give 5 stars)
      
      - name: is_positive_review
        type: categorical
        label: Is Positive Review
        description: Whether review score is 4 or 5 stars (77.1% positive)
        expr: "CASE WHEN review_score >= 4 THEN TRUE ELSE FALSE END"
      
      - name: is_negative_review
        type: categorical
        label: Is Negative Review
        description: Whether review score is 1 or 2 stars (14.7% negative)
        expr: "CASE WHEN review_score <= 2 THEN TRUE ELSE FALSE END"
      
      - name: is_five_star
        type: categorical
        label: Is Five Star
        description: Whether review is 5 stars (57.8% of reviews)
        expr: "CASE WHEN review_score = 5 THEN TRUE ELSE FALSE END"
      
      - name: has_comment
        type: categorical
        label: Has Comment
        description: Whether review includes comment text (41.3% have comments)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN TRUE ELSE FALSE END"
    
    measures:
      - name: review_count
        agg: count
        label: Review Count
        description: Total count of reviews submitted (99,224 reviews)
      
      - name: avg_review_score
        agg: average
        label: Average Review Score
        description: Mean customer satisfaction rating (4.09/5.0 overall)
        expr: review_score
      
      - name: five_star_count
        agg: count
        label: Five Star Count
        description: Count of 5-star reviews (57.8% of total)
        expr: "CASE WHEN review_score = 5 THEN review_id END"
      
      - name: one_star_count
        agg: count
        label: One Star Count
        description: Count of 1-star reviews (11.5% of total)
        expr: "CASE WHEN review_score = 1 THEN review_id END"
      
      - name: positive_review_count
        agg: count
        label: Positive Review Count
        description: Count of 4-5 star reviews (77.1% of total)
        expr: "CASE WHEN review_score >= 4 THEN review_id END"
      
      - name: negative_review_count
        agg: count
        label: Negative Review Count
        description: Count of 1-2 star reviews (14.7% of total)
        expr: "CASE WHEN review_score <= 2 THEN review_id END"
      
      - name: review_score_sum
        agg: sum
        label: Review Score Sum
        description: Sum of all review scores for weighted calculations
        expr: review_score

  - name: customers
    description: |
      Customer dimension table. CRITICAL: customer_id is per-order (99,441 values), customer_unique_id
      is the true unique identifier (96,096 values). Always use customer_unique_id for customer counts.
      Geographic concentration: São Paulo (SP) 42%, Rio de Janeiro (RJ) 12.9%, Minas Gerais (MG) 11.7%.
    model: ref('customers')
    defaults:
      agg_time_dimension: first_order_date
    
    entities:
      - name: customer
        type: primary
        expr: customer_id
      - name: customer_unique
        type: natural
        expr: customer_unique_id
    
    dimensions:
      - name: first_order_date
        type: time
        label: First Order Date
        description: Date of customer's first order (joined from orders table for time dimension)
        expr: first_order_date
        type_params:
          time_granularity: day
      
      - name: customer_state
        type: categorical
        label: Customer State
        description: Two-letter Brazilian state code - SP (42%), RJ (12.9%), MG (11.7%)
      
      - name: customer_city
        type: categorical
        label: Customer City
        description: Customer city - top cities are São Paulo, Rio de Janeiro, Belo Horizonte
      
      - name: customer_zip_code_prefix
        type: categorical
        label: Customer ZIP Code Prefix
        description: 5-digit ZIP code prefix (14,994 unique values)
      
      - name: is_sao_paulo
        type: categorical
        label: Is São Paulo
        description: Whether customer is in São Paulo state (42% of customers)
        expr: "CASE WHEN customer_state = 'SP' THEN TRUE ELSE FALSE END"
      
      - name: is_top_3_states
        type: categorical
        label: Is Top 3 States
        description: Whether customer is in SP, RJ, or MG (66.6% of customers)
        expr: "CASE WHEN customer_state IN ('SP', 'RJ', 'MG') THEN TRUE ELSE FALSE END"
    
    measures:
      - name: customer_count
        agg: count_distinct
        label: Unique Customers
        description: Count of unique customers using customer_unique_id (96,096 unique customers)
        expr: customer_unique_id
      
      - name: customer_order_count
        agg: count
        label: Customer Order Count
        description: Count of customer_id records (equals order count, 99,441)

  - name: products
    description: |
      Product catalog - 32,951 products across 73 categories. Physical dimensions (weight, length,
      height, width) affect shipping costs. 1.9% have null category. Top category by revenue is
      bed_bath_table. 51% of products have only 1 photo.
    model: ref('products')
    defaults:
      agg_time_dimension: first_sold_date
    
    entities:
      - name: product
        type: primary
        expr: product_id
    
    dimensions:
      - name: first_sold_date
        type: time
        label: First Sold Date
        description: Date product was first sold (joined from order_items for time dimension)
        expr: first_sold_date
        type_params:
          time_granularity: day
      
      - name: product_category_name
        type: categorical
        label: Product Category (Portuguese)
        description: Category in Portuguese - 73 categories, 1.9% null
      
      - name: product_category_name_english
        type: categorical
        label: Product Category (English)
        description: Category in English - join from translation table
      
      - name: product_weight_bucket
        type: categorical
        label: Product Weight Bucket
        description: Weight category affecting shipping cost - median 700g, mean 2,276g
        expr: |
          CASE 
            WHEN product_weight_g < 500 THEN 'Light (< 500g)'
            WHEN product_weight_g < 2000 THEN 'Medium (500-2000g)'
            WHEN product_weight_g < 5000 THEN 'Heavy (2-5kg)'
            ELSE 'Very Heavy (5kg+)'
          END
      
      - name: product_photo_count_bucket
        type: categorical
        label: Product Photo Count Bucket
        description: Number of product photos - 51% have only 1 photo
        expr: |
          CASE 
            WHEN product_photos_qty = 1 THEN '1 photo'
            WHEN product_photos_qty BETWEEN 2 AND 3 THEN '2-3 photos'
            WHEN product_photos_qty BETWEEN 4 AND 6 THEN '4-6 photos'
            ELSE '7+ photos'
          END
    
    measures:
      - name: product_count
        agg: count_distinct
        label: Product Count
        description: Count of unique products (32,951 products)
        expr: product_id
      
      - name: avg_product_weight
        agg: average
        label: Average Product Weight
        description: Mean product weight in grams (2,276g average)
        expr: product_weight_g
      
      - name: avg_product_length
        agg: average
        label: Average Product Length
        description: Mean product length in cm (30.82cm average)
        expr: product_length_cm
      
      - name: avg_product_height
        agg: average
        label: Average Product Height
        description: Mean product height in cm (16.94cm average)
        expr: product_height_cm
      
      - name: avg_product_width
        agg: average
        label: Average Product Width
        description: Mean product width in cm (23.20cm average)
        expr: product_width_cm
      
      - name: avg_photos_per_product
        agg: average
        label: Average Photos per Product
        description: Mean number of product photos (2.19 average)
        expr: product_photos_qty

  - name: sellers
    description: |
      Seller dimension - 3,095 sellers across 23 of 27 Brazilian states. Seller concentration
      in São Paulo (59.7%) is much higher than customer concentration (42%). Top states:
      SP (59.7%), PR (11.3%), MG (7.9%).
    model: ref('sellers')
    defaults:
      agg_time_dimension: first_sale_date
    
    entities:
      - name: seller
        type: primary
        expr: seller_id
    
    dimensions:
      - name: first_sale_date
        type: time
        label: First Sale Date
        description: Date of seller's first sale (joined from order_items for time dimension)
        expr: first_sale_date
        type_params:
          time_granularity: day
      
      - name: seller_state
        type: categorical
        label: Seller State
        description: Two-letter Brazilian state code - SP (59.7%), PR (11.3%), MG (7.9%)
      
      - name: seller_city
        type: categorical
        label: Seller City
        description: Seller city - São Paulo dominates at 22.4%
      
      - name: seller_zip_code_prefix
        type: categorical
        label: Seller ZIP Code Prefix
        description: 5-digit ZIP code prefix (2,246 unique values)
      
      - name: is_sao_paulo_seller
        type: categorical
        label: Is São Paulo Seller
        description: Whether seller is in São Paulo state (59.7% of sellers)
        expr: "CASE WHEN seller_state = 'SP' THEN TRUE ELSE FALSE END"
    
    measures:
      - name: seller_count
        agg: count_distinct
        label: Seller Count
        description: Count of unique sellers (3,095 sellers)
        expr: seller_id

---

version: 2

metrics:
  # ============================================================================
  # REVENUE & GMV METRICS
  # ============================================================================
  
  - name: gmv
    label: GMV (Gross Merchandise Value)
    description: |
      Total product value excluding freight - the primary top-line revenue metric.
      Total dataset GMV: R$13.6M. Always exclude canceled orders from revenue calculations.
    type: simple
    type_params:
      measure: gmv_total
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: realized_gmv
    label: Realized GMV
    description: |
      GMV from delivered orders only - represents actual completed revenue.
      97% of orders reach delivered status.
    type: simple
    type_params:
      measure: gmv_total
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: total_revenue
    label: Total Revenue
    description: |
      Total revenue including product price and freight charges.
      Excludes canceled orders.
    type: simple
    type_params:
      measure: total_revenue
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: freight_revenue
    label: Freight Revenue
    description: |
      Total shipping charges collected from customers.
      Median freight R$16.26, mean R$19.99.
    type: simple
    type_params:
      measure: freight_revenue_total
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: aov
    label: AOV (Average Order Value)
    description: |
      Average order value - GMV divided by order count.
      Dataset average: R$137. Preferred business abbreviation is "AOV".
    type: derived
    type_params:
      expr: gmv / NULLIF(orders, 0)
      metrics:
        - name: gmv
        - name: orders
  
  - name: revenue_per_customer
    label: Revenue per Customer
    description: |
      Total GMV divided by unique customer count - measures monetization efficiency.
      Use customer_unique_id for accurate customer counts.
    type: derived
    type_params:
      expr: gmv / NULLIF(unique_customers, 0)
      metrics:
        - name: gmv
        - name: unique_customers
  
  - name: avg_item_price
    label: Average Item Price
    description: |
      Mean item price across all items sold.
      R$120.65 average, R$74.99 median.
    type: simple
    type_params:
      measure: avg_item_price
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: avg_freight_value
    label: Average Freight Value
    description: |
      Mean shipping cost per item.
      R$19.99 average, R$16.26 median.
    type: simple
    type_params:
      measure: avg_freight_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: freight_to_price_ratio
    label: Freight to Price Ratio
    description: |
      Shipping cost as percentage of product price.
      Used for logistics optimization and pricing analysis.
    type: derived
    type_params:
      expr: freight_revenue / NULLIF(gmv, 0)
      metrics:
        - name: freight_revenue
        - name: gmv
  
  # ============================================================================
  # CUMULATIVE REVENUE METRICS
  # ============================================================================
  
  - name: cumulative_gmv
    label: Cumulative GMV
    description: |
      Running total of GMV over time - tracks cumulative revenue growth.
      Used for all-time revenue tracking and growth visualization.
    type: cumulative
    type_params:
      measure: gmv_total
  
  - name: gmv_mtd
    label: GMV Month-to-Date
    description: |
      GMV accumulated from the start of the current month.
      Used for monthly performance tracking against targets.
    type: cumulative
    type_params:
      measure: gmv_total
      grain_to_date: month
  
  - name: cumulative_revenue
    label: Cumulative Total Revenue
    description: |
      Running total of revenue including freight over time.
    type: cumulative
    type_params:
      measure: total_revenue
  
  # ============================================================================
  # VOLUME METRICS
  # ============================================================================
  
  - name: orders
    label: Orders
    description: |
      Total count of orders excluding canceled.
      Total dataset: 99,441 orders, 97% delivered.
    type: simple
    type_params:
      measure: orders_total_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: delivered_orders
    label: Delivered Orders
    description: |
      Count of orders that reached delivered status.
      97% of orders are delivered.
    type: simple
    type_params:
      measure: orders_delivered_count
  
  - name: canceled_orders
    label: Canceled Orders
    description: |
      Count of canceled orders.
      0.6% cancellation rate.
    type: simple
    type_params:
      measure: orders_canceled_count
  
  - name: items_sold
    label: Items Sold
    description: |
      Total count of items sold across all orders.
      112,650 items across 99,441 orders.
    type: simple
    type_params:
      measure: order_items_count
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: items_per_order
    label: Items per Order
    description: |
      Average number of items per order.
      Mean 1.13 items per order, 87.6% of orders have single item.
    type: derived
    type_params:
      expr: items_sold / NULLIF(orders, 0)
      metrics:
        - name: items_sold
        - name: orders
  
  - name: unique_customers
    label: Unique Customers
    description: |
      Count of unique customers using customer_unique_id.
      CRITICAL: Always use customer_unique_id, not customer_id.
      96,096 unique customers in dataset.
    type: simple
    type_params:
      measure: customer_count
  
  - name: active_sellers
    label: Active Sellers
    description: |
      Count of sellers with sales in the period.
      3,095 sellers total.
    type: simple
    type_params:
      measure: seller_count
  
  - name: active_products
    label: Active Products
    description: |
      Count of products sold in the period.
      32,951 products total across 73 categories.
    type: simple
    type_params:
      measure: product_count
  
  # ============================================================================
  # CUSTOMER METRICS
  # ============================================================================
  
  - name: orders_per_customer
    label: Orders per Customer
    description: |
      Average number of orders per unique customer.
      Very low at ~1.03, indicating minimal repeat purchases.
    type: derived
    type_params:
      expr: orders / NULLIF(unique_customers, 0)
      metrics:
        - name: orders
        - name: unique_customers
  
  - name: repeat_purchase_rate
    label: Repeat Purchase Rate
    description: |
      Percentage of customers with more than one order.
      Only ~3% repeat rate - major retention opportunity.
      Calculated as (customers with >1 order) / total customers.
    type: derived
    type_params:
      expr: (unique_customers - first_time_customers) / NULLIF(unique_customers, 0) * 100
      metrics:
        - name: unique_customers
        - name: first_time_customers
  
  - name: first_time_customers
    label: First Time Customers
    description: |
      Count of customers making their first purchase in the period.
      ~97% of customers are one-time buyers.
    type: simple
    type_params:
      measure: customer_count
    filter: |
      {{ Dimension('customer__first_order_date') }} >= {{ TimeDimension('metric_time', 'day') }}
  
  # ============================================================================
  # DELIVERY PERFORMANCE METRICS
  # ============================================================================
  
  - name: avg_delivery_days
    label: Average Delivery Days
    description: |
      Average calendar days from order purchase to customer delivery.
      Critical operational KPI for customer satisfaction.
    type: derived
    type_params:
      expr: delivery_days_total / NULLIF(delivered_orders, 0)
      metrics:
        - name: delivery_days_total
          alias: delivery_days_total
        - name: delivered_orders
  
  - name: delivery_days_total
    label: Total Delivery Days
    description: |
      Sum of days from purchase to delivery across all orders.
      Used to calculate average delivery time.
    type: simple
    type_params:
      measure: delivery_days_total
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: avg_shipping_days
    label: Average Shipping Days
    description: |
      Average calendar days from carrier handoff to customer delivery.
      Measures carrier transit time specifically.
    type: derived
    type_params:
      expr: shipping_days_total / NULLIF(delivered_orders, 0)
      metrics:
        - name: shipping_days_total
          alias: shipping_days_total
        - name: delivered_orders
  
  - name: shipping_days_total
    label: Total Shipping Days
    description: |
      Sum of days from carrier handoff to delivery.
      Used to calculate average shipping time.
    type: simple
    type_params:
      measure: shipping_days_total
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: on_time_delivery_rate
    label: On-Time Delivery Rate
    description: |
      Percentage of orders delivered on or before estimated date.
      Benchmark: 63% on-time rate. Most critical operational KPI.
      Late delivery strongly predicts poor reviews.
    type: derived
    type_params:
      expr: on_time_orders / NULLIF(delivered_orders, 0) * 100
      metrics:
        - name: on_time_orders
        - name: delivered_orders
  
  - name: on_time_orders
    label: On-Time Orders
    description: |
      Count of orders delivered on or before estimated date.
      ~63% of delivered orders are on-time.
    type: simple
    type_params:
      measure: orders_on_time_count
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: late_orders
    label: Late Orders
    description: |
      Count of orders delivered after estimated date.
      ~37% of delivered orders are late.
    type: simple
    type_params:
      measure: orders_late_count
    filter: |
      {{ Dimension('order__order_status') }} = 'delivered'
  
  - name: late_delivery_rate
    label: Late Delivery Rate
    description: |
      Percentage of orders delivered after estimated date.
      ~37% late delivery rate - major operational issue.
    type: derived
    type_params:
      expr: late_orders / NULLIF(delivered_orders, 0) * 100
      metrics:
        - name: late_orders
        - name: delivered_orders
  
  # ============================================================================
  # CUSTOMER SATISFACTION METRICS
  # ============================================================================
  
  - name: avg_review_score
    label: Average Review Score
    description: |
      Mean customer satisfaction rating on 1-5 scale.
      Dataset average: 4.09/5.0. Strongly correlated with delivery performance.
    type: simple
    type_params:
      measure: avg_review_score
  
  - name: review_count
    label: Review Count
    description: |
      Total count of reviews submitted.
      99,224 reviews in dataset.
    type: simple
    type_params:
      measure: review_count
  
  - name: five_star_rate
    label: Five Star Rate
    description: |
      Percentage of reviews that are 5 stars.
      57.8% of reviews are 5 stars - bimodal distribution.
    type: derived
    type_params:
      expr: five_star_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: five_star_count
        - name: review_count
  
  - name: five_star_count
    label: Five Star Count
    description: |
      Count of 5-star reviews.
      57.8% of all reviews.
    type: simple
    type_params:
      measure: five_star_count
  
  - name: one_star_rate
    label: One Star Rate
    description: |
      Percentage of reviews that are 1 star.
      11.5% of reviews are 1 star.
    type: derived
    type_params:
      expr: one_star_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: one_star_count
        - name: review_count
  
  - name: one_star_count
    label: One Star Count
    description: |
      Count of 1-star reviews.
      11.5% of all reviews.
    type: simple
    type_params:
      measure: one_star_count
  
  - name: positive_review_rate
    label: Positive Review Rate
    description: |
      Percentage of reviews with 4 or 5 stars.
      77.1% positive review rate.
    type: derived
    type_params:
      expr: positive_review_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: positive_review_count
        - name: review_count
  
  - name: positive_review_count
    label: Positive Review Count
    description: |
      Count of 4-5 star reviews.
      77.1% of all reviews.
    type: simple
    type_params:
      measure: positive_review_count
  
  - name: negative_review_rate
    label: Negative Review Rate
    description: |
      Percentage of reviews with 1 or 2 stars.
      14.7% negative review rate.
    type: derived
    type_params:
      expr: negative_review_count / NULLIF(review_count, 0) * 100
      metrics:
        - name: negative_review_count
        - name: review_count
  
  - name: negative_review_count
    label: Negative Review Count
    description: |
      Count of 1-2 star reviews.
      14.7% of all reviews.
    type: simple
    type_params:
      measure: negative_review_count
  
  # ============================================================================
  # PAYMENT METRICS
  # ============================================================================
  
  - name: total_payment_value
    label: Total Payment Value
    description: |
      Total payment value across all payment methods.
      Should reconcile with GMV + freight within rounding.
    type: simple
    type_params:
      measure: payment_value_total
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: avg_payment_value
    label: Average Payment Value
    description: |
      Mean payment value per transaction.
      R$154.10 average.
    type: simple
    type_params:
      measure: avg_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: credit_card_revenue
    label: Credit Card Revenue
    description: |
      Total payment value from credit cards.
      73.9% of total payment value.
    type: simple
    type_params:
      measure: credit_card_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: boleto_revenue
    label: Boleto Revenue
    description: |
      Total payment value from boleto bank slips.
      19% of total payment value. Boleto is unique to Brazil.
    type: simple
    type_params:
      measure: boleto_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: voucher_revenue
    label: Voucher Revenue
    description: |
      Total payment value from vouchers.
      5.5% of total payment value.
    type: simple
    type_params:
      measure: voucher_payment_value
    filter: |
      {{ Dimension('order__order_status') }} != 'canceled'
  
  - name: credit_card_share
    label: Credit Card Share
    description: |
      Percentage of payment value from credit cards.
      ~74% credit card share.
    type: derived
    type_params:
      expr: credit_card_revenue / NULLIF(total_payment_value, 0) * 100
      metrics:
        - name: credit_card_revenue
        - name: total_payment_value
  
  - name: avg_installments
    label: Average Installments
    description: |
      Average number of installments for credit card payments.
      2.85 average, but 50.6% pay in 1 installment.
    type: simple
    type_params:
      measure: avg_installments
    filter: |
      {{ Dimension('order_payment__payment_type') }} = 'credit_card'
  
  # ============================================================================
  # MARKETPLACE HEALTH METRICS
  # ============================================================================
  
  - name: gmv_per_seller
    label: GMV per Seller
    description: |
      Average GMV per active seller - measures seller productivity.
      Used for marketplace health monitoring.
    type: derived
    type_params:
      expr: gmv / NULLIF(active_sellers, 0)
      metrics:
        - name: gmv
        - name: active_sellers
  
  - name: items_per_seller
    label: Items per Seller
    description: |
      Average items sold per active seller - measures seller activity.
    type: derived
    type_params:
      expr: items_sold / NULLIF(active_sellers, 0)
      metrics:
        - name: items_sold
        - name: active_sellers
  
  - name: orders_per_seller
    label: Orders per Seller
    description: |
      Average orders per active seller.
    type: derived
    type_params:
      expr: orders / NULLIF(active_sellers, 0)
      metrics:
        - name: orders
        - name: active_sellers
  
  - name: cancellation_rate
    label: Cancellation Rate
    description: |
      Percentage of orders that are canceled.
      0.6% cancellation rate.
    type: derived
    type_params:
      expr: canceled_orders / NULLIF(orders + canceled_orders, 0) * 100
      metrics:
        - name: canceled_orders
        - name: orders
  
  # ============================================================================
  # GROWTH METRICS (Month-over-Month)
  # ============================================================================
  
  - name: gmv_mom_growth
    label: GMV Month-over-Month Growth
    description: |
      Month-over-month GMV growth rate as percentage.
      Used for executive reporting and trend analysis.
    type: derived
    type_params:
      expr: (gmv - gmv_prior_month) / NULLIF(gmv_prior_month, 0) * 100
      metrics:
        - name: gmv
        - name: gmv
          alias: gmv_prior_month
          offset_window: 1 month
  
  - name: orders_mom_growth
    label: Orders Month-over-Month Growth
    description: |
      Month-over-month order volume growth rate as percentage.
    type: derived
    type_params:
      expr: (orders - orders_prior_month) / NULLIF(orders_prior_month, 0) * 100
      metrics:
        - name: orders
        - name: orders
          alias: orders_prior_month
          offset_window: 1 month
  
  - name: customers_mom_growth
    label: Customers Month-over-Month Growth
    description: |
      Month-over-month unique customer growth rate as percentage.
    type: derived
    type_params:
      expr: (unique_customers - unique_customers_prior_month) / NULLIF(unique_customers_prior_month, 0) * 100
      metrics:
        - name: unique_customers
        - name: unique_customers
          alias: unique_customers_prior_month
          offset_window: 1 month

---

version: 2

saved_queries:
  - name: monthly_revenue_overview
    label: Monthly Revenue Overview
    description: |
      Key revenue and volume metrics aggregated by month for executive reporting.
      Shows GMV, orders, customers, AOV, and month-over-month growth trends.
    query_params:
      metrics:
        - gmv
        - realized_gmv
        - total_revenue
        - freight_revenue
        - orders
        - delivered_orders
        - unique_customers
        - aov
        - items_per_order
        - gmv_mom_growth
        - orders_mom_growth
      group_by:
        - "TimeDimension('metric_time', 'month')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: delivery_performance_dashboard
    label: Delivery Performance Dashboard
    description: |
      Critical operational KPIs for delivery performance monitoring.
      Tracks on-time rate, delivery times, and late deliveries by month.
      63% on-time benchmark - late delivery predicts poor reviews.
    query_params:
      metrics:
        - delivered_orders
        - on_time_orders
        - late_orders
        - on_time_delivery_rate
        - late_delivery_rate
        - avg_delivery_days
        - avg_shipping_days
      group_by:
        - "TimeDimension('metric_time', 'month')"
      where:
        - "{{ Dimension('order__order_status') }} = 'delivered'"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: customer_satisfaction_analysis
    label: Customer Satisfaction Analysis
    description: |
      Customer review metrics by month showing satisfaction trends.
      Mean score 4.09/5.0, 57.8% give 5 stars, 11.5% give 1 star.
      Strongly correlated with delivery performance.
    query_params:
      metrics:
        - review_count
        - avg_review_score
        - five_star_rate
        - one_star_rate
        - positive_review_rate
        - negative_review_rate
      group_by:
        - "TimeDimension('metric_time', 'month')"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: geographic_performance
    label: Geographic Performance by State
    description: |
      Revenue and order metrics by customer state for regional analysis.
      São Paulo (SP) dominates at 42% of customers, followed by RJ (12.9%) and MG (11.7%).
    query_params:
      metrics:
        - gmv
        - orders
        - unique_customers
        - aov
        - avg_review_score
        - on_time_delivery_rate
      group_by:
        - "Dimension('customer__customer_state')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      order_by:
        - gmv desc
      limit: 27
  
  - name: category_performance_ranking
    label: Category Performance Ranking
    description: |
      Product category performance ranked by GMV.
      Top category: bed_bath_table. 73 categories total.
      Always use English translation for readability.
    query_params:
      metrics:
        - gmv
        - orders
        - items_sold
        - aov
        - avg_item_price
        - avg_review_score
      group_by:
        - "Dimension('product__product_category_name_english')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      order_by:
        - gmv desc
      limit: 20
  
  - name: seller_performance_ranking
    label: Seller Performance Ranking
    description: |
      Top sellers ranked by GMV with quality metrics.
      Filter for sellers with minimum 10 orders for statistical significance.
      3,095 sellers total, 59.7% in São Paulo state.
    query_params:
      metrics:
        - gmv
        - orders
        - items_sold
        - avg_review_score
        - on_time_delivery_rate
      group_by:
        - "Dimension('seller__seller_id')"
        - "Dimension('seller__seller_state')"
        - "Dimension('seller__seller_city')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      having:
        - "{{ Metric('orders') }} >= 10"
      order_by:
        - gmv desc
      limit: 100
  
  - name: payment_method_analysis
    label: Payment Method Analysis
    description: |
      Payment method distribution and performance by month.
      Credit card 73.9%, boleto 19%, voucher 5.5%, debit 1.5%.
      50.6% of credit card payments are in 1 installment.
    query_params:
      metrics:
        - total_payment_value
        - credit_card_revenue
        - boleto_revenue
        - voucher_revenue
        - credit_card_share
        - avg_installments
        - orders
      group_by:
        - "TimeDimension('metric_time', 'month')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: customer_retention_cohort
    label: Customer Retention Cohort Analysis
    description: |
      Customer acquisition and repeat purchase behavior by cohort month.
      Only ~3% repeat purchase rate - major retention opportunity.
      97% of customers are one-time buyers.
    query_params:
      metrics:
        - unique_customers
        - orders
        - gmv
        - orders_per_customer
        - repeat_purchase_rate
        - revenue_per_customer
      group_by:
        - "TimeDimension('customer__first_order_date', 'month')"
      order_by:
        - "TimeDimension('customer__first_order_date', 'month')"
  
  - name: marketplace_health_metrics
    label: Marketplace Health Metrics
    description: |
      Key marketplace health indicators by month.
      Tracks seller productivity, product diversity, and platform efficiency.
    query_params:
      metrics:
        - gmv
        - orders
        - active_sellers
        - active_products
        - gmv_per_seller
        - items_per_seller
        - orders_per_seller
        - cancellation_rate
      group_by:
        - "TimeDimension('metric_time', 'month')"
      order_by:
        - "TimeDimension('metric_time', 'month')"
  
  - name: freight_cost_analysis
    label: Freight Cost Analysis
    description: |
      Shipping cost analysis by freight bucket and product weight.
      Median freight R$16.26, mean R$19.99.
      Used for logistics optimization and pricing strategy.
    query_params:
      metrics:
        - items_sold
        - freight_revenue
        - gmv
        - avg_freight_value
        - freight_to_price_ratio
      group_by:
        - "Dimension('order_item__freight_bucket')"
        - "Dimension('product__product_weight_bucket')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      order_by:
        - items_sold desc
  
  - name: weekly_operational_snapshot
    label: Weekly Operational Snapshot
    description: |
      Week-over-week operational metrics for short-term monitoring.
      Tracks orders, delivery performance, and satisfaction by week.
    query_params:
      metrics:
        - orders
        - delivered_orders
        - gmv
        - on_time_delivery_rate
        - avg_delivery_days
        - avg_review_score
        - cancellation_rate
      group_by:
        - "TimeDimension('metric_time', 'week')"
      where:
        - "{{ Dimension('order__order_status') }} != 'canceled'"
      order_by:
        - "TimeDimension('metric_time', 'week')"
  
  - name: delivery_satisfaction_correlation
    label: Delivery Performance vs Satisfaction
    description: |
      Correlation analysis between delivery performance and review scores.
      Late delivery strongly predicts poor reviews - critical insight.
      On-time orders have significantly higher review scores.
    query_params:
      metrics:
        - delivered_orders
        - avg_review_score
        - five_star_rate
        - one_star_rate
        - avg_delivery_days
      group_by:
        - "Dimension('order__is_on_time')"
        - "TimeDimension('metric_time', 'month')"
      where:
        - "{{ Dimension('order__order_status') }} = 'delivered'"
      order_by:
        - "TimeDimension('metric_time', 'month')"
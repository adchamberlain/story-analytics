version: 2

semantic_models:
  - name: orders
    description: |
      Core order fact table containing all e-commerce orders. 97% of orders are delivered successfully.
      Includes order lifecycle timestamps from purchase through delivery. Each order is placed by exactly
      one customer and can contain multiple items.
    model: ref('orders')
    defaults:
      agg_time_dimension: order_date
    
    entities:
      - name: order
        type: primary
        expr: order_id
      - name: customer
        type: foreign
        expr: customer_id
    
    dimensions:
      - name: order_date
        type: time
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      - name: approved_at
        type: time
        expr: order_approved_at
        type_params:
          time_granularity: day
      - name: delivered_carrier_date
        type: time
        expr: order_delivered_carrier_date
        type_params:
          time_granularity: day
      - name: delivered_customer_date
        type: time
        expr: order_delivered_customer_date
        type_params:
          time_granularity: day
      - name: estimated_delivery_date
        type: time
        expr: order_estimated_delivery_date
        type_params:
          time_granularity: day
      - name: order_status
        type: categorical
        description: "Order status: 97% delivered, 1.1% shipped, 0.6% canceled, 0.3% other"
      - name: is_delivered
        type: categorical
        expr: "case when order_status = 'delivered' then true else false end"
        description: "Boolean flag for delivered orders (97% of all orders)"
      - name: is_canceled
        type: categorical
        expr: "case when order_status = 'canceled' then true else false end"
    
    measures:
      - name: order_count
        agg: count
        description: "Total number of orders"
        label: "Order Count"
      - name: delivered_order_count
        agg: count
        expr: "case when order_status = 'delivered' then 1 end"
        description: "Count of successfully delivered orders (97% of total)"
        label: "Delivered Orders"
      - name: canceled_order_count
        agg: count
        expr: "case when order_status = 'canceled' then 1 end"
        description: "Count of canceled orders (0.6% of total)"
        label: "Canceled Orders"
      - name: days_to_approval
        agg: average
        expr: "datediff('day', order_purchase_timestamp, order_approved_at)"
        description: "Average days from purchase to approval"
        label: "Avg Days to Approval"
      - name: days_to_carrier
        agg: average
        expr: "datediff('day', order_approved_at, order_delivered_carrier_date)"
        description: "Average days from approval to carrier pickup"
        label: "Avg Days to Carrier"
      - name: days_to_delivery
        agg: average
        expr: "datediff('day', order_purchase_timestamp, order_delivered_customer_date)"
        description: "Average total days from purchase to customer delivery"
        label: "Avg Days to Delivery"
      - name: delivery_vs_estimate_days
        agg: average
        expr: "datediff('day', order_delivered_customer_date, order_estimated_delivery_date)"
        description: "Average days early (positive) or late (negative) vs estimate"
        label: "Avg Days vs Estimate"
      - name: on_time_delivery_count
        agg: count
        expr: "case when order_delivered_customer_date <= order_estimated_delivery_date then 1 end"
        description: "Count of orders delivered on or before estimated date"
        label: "On-Time Deliveries"

  - name: order_items
    description: |
      Line items for each order. Average 1.2 items per order, with 89% of orders having just 1 item.
      Contains pricing, freight, and seller information for each product in an order.
    model: ref('order_items')
    defaults:
      agg_time_dimension: shipping_limit_date
    
    entities:
      - name: order_item
        type: primary
        expr: "order_id || '-' || order_item_id"
      - name: order
        type: foreign
        expr: order_id
      - name: product
        type: foreign
        expr: product_id
      - name: seller
        type: foreign
        expr: seller_id
    
    dimensions:
      - name: shipping_limit_date
        type: time
        expr: shipping_limit_date
        type_params:
          time_granularity: day
      - name: order_item_sequence
        type: categorical
        expr: order_item_id
        description: "Item sequence in order (1-21, avg 1.2)"
    
    measures:
      - name: order_item_count
        agg: count
        description: "Total number of order line items"
        label: "Order Items"
      - name: total_item_revenue
        agg: sum
        expr: price
        description: "Total revenue from item prices (avg $120.65 per item)"
        label: "Item Revenue"
      - name: total_freight_revenue
        agg: sum
        expr: freight_value
        description: "Total freight/shipping revenue (avg $19.99 per item)"
        label: "Freight Revenue"
      - name: total_gmv
        agg: sum
        expr: "price + freight_value"
        description: "Total Gross Merchandise Value including freight"
        label: "GMV"
      - name: avg_item_price
        agg: average
        expr: price
        description: "Average item price ($120.65)"
        label: "Avg Item Price"
      - name: avg_freight_value
        agg: average
        expr: freight_value
        description: "Average freight cost per item ($19.99)"
        label: "Avg Freight"
      - name: distinct_products_sold
        agg: count_distinct
        expr: product_id
        description: "Number of unique products sold"
        label: "Unique Products"
      - name: distinct_sellers
        agg: count_distinct
        expr: seller_id
        description: "Number of unique sellers with sales"
        label: "Active Sellers"

  - name: order_payments
    description: |
      Payment transactions for orders. 74% paid by credit card, 19% boleto, 5.6% voucher.
      Average 1.09 payment records per order, with 96% of orders having single payment.
      Average 2.85 installments per payment.
    model: ref('order_payments')
    defaults:
      agg_time_dimension: payment_date
    
    entities:
      - name: payment
        type: primary
        expr: "order_id || '-' || payment_sequential"
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: payment_date
        type: time
        expr: "cast(order_id as timestamp)"
        description: "Using order_id as proxy for payment date (join to orders for actual timestamp)"
        type_params:
          time_granularity: day
      - name: payment_type
        type: categorical
        description: "Payment method: credit_card (74%), boleto (19%), voucher (5.6%), debit_card (1.5%)"
      - name: payment_installments
        type: categorical
        description: "Number of installments (0-24, avg 2.85)"
      - name: is_credit_card
        type: categorical
        expr: "case when payment_type = 'credit_card' then true else false end"
      - name: is_installment_payment
        type: categorical
        expr: "case when payment_installments > 1 then true else false end"
    
    measures:
      - name: payment_count
        agg: count
        description: "Total number of payment transactions"
        label: "Payment Count"
      - name: total_payment_value
        agg: sum
        expr: payment_value
        description: "Total payment value (avg $154.10 per payment)"
        label: "Payment Value"
      - name: avg_payment_value
        agg: average
        expr: payment_value
        description: "Average payment amount ($154.10)"
        label: "Avg Payment"
      - name: avg_installments
        agg: average
        expr: payment_installments
        description: "Average number of installments (2.85)"
        label: "Avg Installments"
      - name: credit_card_payment_count
        agg: count
        expr: "case when payment_type = 'credit_card' then 1 end"
        description: "Count of credit card payments (74% of total)"
        label: "Credit Card Payments"
      - name: boleto_payment_count
        agg: count
        expr: "case when payment_type = 'boleto' then 1 end"
        description: "Count of boleto payments (19% of total)"
        label: "Boleto Payments"
      - name: installment_payment_count
        agg: count
        expr: "case when payment_installments > 1 then 1 end"
        description: "Count of payments with installments"
        label: "Installment Payments"

  - name: order_reviews
    description: |
      Customer reviews for orders. Average review score is 4.09 out of 5. 58% gave 5 stars,
      19% gave 4 stars, 12% gave 1 star. 58.7% include comment messages, 88.3% lack titles.
    model: ref('order_reviews')
    defaults:
      agg_time_dimension: review_creation_date
    
    entities:
      - name: review
        type: primary
        expr: review_id
      - name: order
        type: foreign
        expr: order_id
    
    dimensions:
      - name: review_creation_date
        type: time
        expr: review_creation_date
        type_params:
          time_granularity: day
      - name: review_answer_date
        type: time
        expr: review_answer_timestamp
        type_params:
          time_granularity: day
      - name: review_score
        type: categorical
        description: "Star rating 1-5 (avg 4.09): 58% give 5 stars, 19% give 4 stars"
      - name: has_comment
        type: categorical
        expr: "case when review_comment_message is not null then true else false end"
        description: "Whether review includes written comment (41.3% do)"
      - name: has_title
        type: categorical
        expr: "case when review_comment_title is not null then true else false end"
        description: "Whether review includes title (11.7% do)"
    
    measures:
      - name: review_count
        agg: count
        description: "Total number of reviews"
        label: "Review Count"
      - name: avg_review_score
        agg: average
        expr: review_score
        description: "Average review score (4.09 out of 5)"
        label: "Avg Review Score"
      - name: five_star_review_count
        agg: count
        expr: "case when review_score = 5 then 1 end"
        description: "Count of 5-star reviews (58% of total)"
        label: "5-Star Reviews"
      - name: one_star_review_count
        agg: count
        expr: "case when review_score = 1 then 1 end"
        description: "Count of 1-star reviews (12% of total)"
        label: "1-Star Reviews"
      - name: positive_review_count
        agg: count
        expr: "case when review_score >= 4 then 1 end"
        description: "Count of 4-5 star reviews (77% of total)"
        label: "Positive Reviews"
      - name: negative_review_count
        agg: count
        expr: "case when review_score <= 2 then 1 end"
        description: "Count of 1-2 star reviews (15% of total)"
        label: "Negative Reviews"
      - name: review_with_comment_count
        agg: count
        expr: "case when review_comment_message is not null then 1 end"
        description: "Reviews with written comments (41.3%)"
        label: "Reviews with Comments"
      - name: days_to_review_response
        agg: average
        expr: "datediff('day', review_creation_date, review_answer_timestamp)"
        description: "Average days from review creation to response"
        label: "Avg Days to Response"

  - name: customers
    description: |
      Customer dimension with 99,441 customers. 96,096 unique customer IDs (3.4% are repeat customers).
      Customers span 27 states, 4,119 cities, and 14,994 zip codes. 42% are from SP state, 13% from RJ.
    model: ref('customers')
    defaults:
      agg_time_dimension: customer_created_date
    
    entities:
      - name: customer
        type: primary
        expr: customer_id
      - name: unique_customer
        type: natural
        expr: customer_unique_id
    
    dimensions:
      - name: customer_created_date
        type: time
        expr: "cast(customer_id as timestamp)"
        description: "Proxy date for customer dimension (join to orders for actual activity)"
        type_params:
          time_granularity: day
      - name: customer_state
        type: categorical
        description: "Customer state: SP (42%), RJ (13%), MG (12%), RS (5.5%), PR (5.4%)"
      - name: customer_city
        type: categorical
        description: "Customer city (4,119 unique cities)"
      - name: customer_zip_code_prefix
        type: categorical
        description: "Customer zip code prefix (14,994 unique)"
    
    measures:
      - name: customer_count
        agg: count
        description: "Total customer records"
        label: "Customers"
      - name: unique_customer_count
        agg: count_distinct
        expr: customer_unique_id
        description: "Unique customers (96,096 - indicating 3.4% repeat rate)"
        label: "Unique Customers"

  - name: products
    description: |
      Product catalog with 32,951 products across 73 categories. Average product weighs 2,276g,
      has 2.19 photos, and 771-character descriptions. 1.9% of products have missing category data.
    model: ref('products')
    defaults:
      agg_time_dimension: product_created_date
    
    entities:
      - name: product
        type: primary
        expr: product_id
    
    dimensions:
      - name: product_created_date
        type: time
        expr: "cast(product_id as timestamp)"
        description: "Proxy date for product dimension"
        type_params:
          time_granularity: day
      - name: product_category_name
        type: categorical
        description: "Product category in Portuguese (73 categories, 1.9% null)"
      - name: has_category
        type: categorical
        expr: "case when product_category_name is not null then true else false end"
      - name: photo_count_tier
        type: categorical
        expr: |
          case 
            when product_photos_qty = 1 then '1 photo'
            when product_photos_qty = 2 then '2 photos'
            when product_photos_qty >= 3 then '3+ photos'
            else 'no photos'
          end
        description: "Product photo count tier (50% have 1 photo, 19% have 2)"
    
    measures:
      - name: product_count
        agg: count
        description: "Total number of products in catalog"
        label: "Products"
      - name: avg_product_weight_g
        agg: average
        expr: product_weight_g
        description: "Average product weight in grams (2,276g)"
        label: "Avg Weight (g)"
      - name: avg_product_photos
        agg: average
        expr: product_photos_qty
        description: "Average number of product photos (2.19)"
        label: "Avg Photos"
      - name: avg_description_length
        agg: average
        expr: product_description_length
        description: "Average product description length (771 chars)"
        label: "Avg Description Length"

  - name: sellers
    description: |
      Seller dimension with 3,095 sellers across 611 cities and 23 states.
      60% of sellers are in SP state, 11% in PR, 8% in MG.
    model: ref('sellers')
    defaults:
      agg_time_dimension: seller_created_date
    
    entities:
      - name: seller
        type: primary
        expr: seller_id
    
    dimensions:
      - name: seller_created_date
        type: time
        expr: "cast(seller_id as timestamp)"
        description: "Proxy date for seller dimension"
        type_params:
          time_granularity: day
      - name: seller_state
        type: categorical
        description: "Seller state: SP (60%), PR (11%), MG (8%), RJ (7%)"
      - name: seller_city
        type: categorical
        description: "Seller city (611 unique cities)"
      - name: seller_zip_code_prefix
        type: categorical
        description: "Seller zip code prefix (2,246 unique)"
    
    measures:
      - name: seller_count
        agg: count
        description: "Total number of sellers"
        label: "Sellers"
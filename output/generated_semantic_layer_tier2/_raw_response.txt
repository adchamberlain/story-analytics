# File: _semantic_models.yml
version: 2

semantic_models:
  - name: orders
    description: |
      Core order transactions representing the complete order lifecycle from purchase through delivery.
      Covers 99,441 orders from September 2016 to October 2018. 97% of orders are delivered successfully,
      with 1.1% shipped, 0.6% canceled, and small percentages in other statuses.
    model: ref('orders')
    defaults:
      agg_time_dimension: order_purchase_date
    
    entities:
      - name: order_id
        type: primary
        expr: order_id
      - name: customer_id
        type: foreign
        expr: customer_id
    
    dimensions:
      - name: order_purchase_date
        type: time
        label: Order Purchase Date
        description: Timestamp when the customer completed the purchase
        expr: order_purchase_timestamp
        type_params:
          time_granularity: day
      
      - name: order_approved_date
        type: time
        label: Order Approved Date
        description: Timestamp when payment was approved (0.2% null rate)
        expr: order_approved_at
        type_params:
          time_granularity: day
      
      - name: order_delivered_carrier_date
        type: time
        label: Delivered to Carrier Date
        description: Timestamp when order was handed to logistics partner (1.8% null)
        expr: order_delivered_carrier_date
        type_params:
          time_granularity: day
      
      - name: order_delivered_customer_date
        type: time
        label: Delivered to Customer Date
        description: Actual delivery timestamp to customer (3.0% null for in-transit orders)
        expr: order_delivered_customer_date
        type_params:
          time_granularity: day
      
      - name: order_estimated_delivery_date
        type: time
        label: Estimated Delivery Date
        description: Promised delivery date communicated to customer
        expr: order_estimated_delivery_date
        type_params:
          time_granularity: day
      
      - name: order_status
        type: categorical
        label: Order Status
        description: |
          Current order status: delivered (97.0%), shipped (1.1%), canceled (0.6%),
          processing, unavailable, invoiced, created, approved
        expr: order_status
      
      - name: is_delivered
        type: categorical
        label: Is Delivered
        description: Boolean flag for successfully delivered orders
        expr: "CASE WHEN order_status = 'delivered' THEN TRUE ELSE FALSE END"
      
      - name: is_canceled
        type: categorical
        label: Is Canceled
        description: Boolean flag for canceled orders
        expr: "CASE WHEN order_status = 'canceled' THEN TRUE ELSE FALSE END"
      
      - name: order_purchase_year
        type: categorical
        label: Purchase Year
        description: Year of order purchase for year-over-year analysis
        expr: "EXTRACT(YEAR FROM order_purchase_timestamp)"
      
      - name: order_purchase_month
        type: categorical
        label: Purchase Month
        description: Month number (1-12) for seasonality analysis
        expr: "EXTRACT(MONTH FROM order_purchase_timestamp)"
      
      - name: order_purchase_quarter
        type: categorical
        label: Purchase Quarter
        description: Quarter (Q1-Q4) for quarterly reporting
        expr: "EXTRACT(QUARTER FROM order_purchase_timestamp)"
      
      - name: order_purchase_day_of_week
        type: categorical
        label: Purchase Day of Week
        description: Day of week (0=Sunday, 6=Saturday) for weekly pattern analysis
        expr: "EXTRACT(DOW FROM order_purchase_timestamp)"
    
    measures:
      - name: orders_total_count
        agg: count
        label: Total Orders
        description: Total count of all orders regardless of status
      
      - name: orders_delivered_count
        agg: count
        label: Delivered Orders
        description: Count of successfully delivered orders (97% of all orders)
        expr: order_id
        agg_time_dimension: order_purchase_date
      
      - name: orders_canceled_count
        agg: sum
        label: Canceled Orders
        description: Count of canceled orders (0.6% of all orders)
        expr: "CASE WHEN order_status = 'canceled' THEN 1 ELSE 0 END"
      
      - name: orders_on_time_count
        agg: sum
        label: On-Time Deliveries
        description: Orders delivered by or before estimated date (approximately 63% of delivered orders)
        expr: |
          CASE 
            WHEN order_status = 'delivered' 
              AND order_delivered_customer_date <= order_estimated_delivery_date 
            THEN 1 
            ELSE 0 
          END
      
      - name: orders_late_count
        agg: sum
        label: Late Deliveries
        description: Orders delivered after estimated date (approximately 37% of delivered orders)
        expr: |
          CASE 
            WHEN order_status = 'delivered' 
              AND order_delivered_customer_date > order_estimated_delivery_date 
            THEN 1 
            ELSE 0 
          END
      
      - name: delivery_days_total
        agg: sum
        label: Total Delivery Days
        description: Sum of days from purchase to customer delivery for calculating averages
        expr: |
          CASE 
            WHEN order_status = 'delivered' AND order_delivered_customer_date IS NOT NULL
            THEN EXTRACT(EPOCH FROM (order_delivered_customer_date - order_purchase_timestamp)) / 86400
            ELSE 0
          END
      
      - name: approval_hours_total
        agg: sum
        label: Total Approval Hours
        description: Sum of hours from purchase to approval for calculating averages
        expr: |
          CASE 
            WHEN order_approved_at IS NOT NULL
            THEN EXTRACT(EPOCH FROM (order_approved_at - order_purchase_timestamp)) / 3600
            ELSE 0
          END
      
      - name: late_days_total
        agg: sum
        label: Total Late Days
        description: Sum of days late for orders delivered after estimated date
        expr: |
          CASE 
            WHEN order_status = 'delivered' 
              AND order_delivered_customer_date > order_estimated_delivery_date
            THEN EXTRACT(EPOCH FROM (order_delivered_customer_date - order_estimated_delivery_date)) / 86400
            ELSE 0
          END

  - name: order_items
    description: |
      Individual line items within orders, representing products sold by sellers.
      Contains 112,650 items across 98,666 orders. Most orders (98,666) have 1 item,
      9,803 have 2 items, with decreasing frequency up to 21 items per order.
      Includes pricing and freight costs per item.
    model: ref('order_items')
    defaults:
      agg_time_dimension: shipping_limit_date
    
    entities:
      - name: order_item
        type: primary
        expr: "order_id || '-' || order_item_id"
      - name: order_id
        type: foreign
        expr: order_id
      - name: product_id
        type: foreign
        expr: product_id
      - name: seller_id
        type: foreign
        expr: seller_id
    
    dimensions:
      - name: shipping_limit_date
        type: time
        label: Shipping Limit Date
        description: Deadline for seller to ship the item to carrier
        expr: shipping_limit_date
        type_params:
          time_granularity: day
      
      - name: order_item_sequence
        type: categorical
        label: Order Item Sequence
        description: Position of item in order (1-21, avg 1.20, median 1)
        expr: order_item_id
      
      - name: price_bucket
        type: categorical
        label: Price Bucket
        description: Price range categorization for analysis
        expr: |
          CASE 
            WHEN price < 20 THEN '< R$20'
            WHEN price < 50 THEN 'R$20-50'
            WHEN price < 100 THEN 'R$50-100'
            WHEN price < 200 THEN 'R$100-200'
            WHEN price < 500 THEN 'R$200-500'
            ELSE 'R$500+'
          END
      
      - name: freight_bucket
        type: categorical
        label: Freight Bucket
        description: Freight cost range categorization
        expr: |
          CASE 
            WHEN freight_value < 10 THEN '< R$10'
            WHEN freight_value < 20 THEN 'R$10-20'
            WHEN freight_value < 30 THEN 'R$20-30'
            ELSE 'R$30+'
          END
    
    measures:
      - name: order_items_count
        agg: count
        label: Order Items Count
        description: Total number of items sold (112,650 items)
      
      - name: order_items_price_total
        agg: sum
        label: Total Item Price
        description: Sum of item prices excluding freight (avg R$120.65, median R$74.99)
        expr: price
      
      - name: order_items_freight_total
        agg: sum
        label: Total Freight Value
        description: Sum of freight costs (avg R$19.99, median R$16.26)
        expr: freight_value
      
      - name: order_items_gmv_total
        agg: sum
        label: Total GMV (Price + Freight)
        description: Gross merchandise value including freight costs
        expr: price + freight_value
      
      - name: order_items_price_min
        agg: min
        label: Minimum Item Price
        description: Lowest item price (R$0.85)
        expr: price
      
      - name: order_items_price_max
        agg: max
        label: Maximum Item Price
        description: Highest item price (R$6,735.00)
        expr: price
      
      - name: order_items_freight_min
        agg: min
        label: Minimum Freight
        description: Lowest freight cost (R$0.00 for some items)
        expr: freight_value
      
      - name: order_items_freight_max
        agg: max
        label: Maximum Freight
        description: Highest freight cost (R$409.68)
        expr: freight_value
      
      - name: distinct_orders_with_items
        agg: count_distinct
        label: Distinct Orders
        description: Number of unique orders containing items (98,666 orders)
        expr: order_id
      
      - name: distinct_products_sold
        agg: count_distinct
        label: Distinct Products Sold
        description: Number of unique products sold (32,951 products)
        expr: product_id
      
      - name: distinct_sellers_active
        agg: count_distinct
        label: Active Sellers
        description: Number of unique sellers with sales (3,095 sellers)
        expr: seller_id

  - name: order_payments
    description: |
      Payment transactions for orders, including payment method and installment details.
      Contains 103,886 payment records for 99,440 orders. Most orders (99,360) have 1 payment,
      with some split across multiple payments. Credit card dominates at 76,795 payments (74%),
      followed by boleto at 19,784 (19%), voucher at 5,775 (5.6%), and debit card at 1,529 (1.5%).
    model: ref('order_payments')
    defaults:
      agg_time_dimension: payment_date
    
    entities:
      - name: payment
        type: primary
        expr: "order_id || '-' || payment_sequential"
      - name: order_id
        type: foreign
        expr: order_id
    
    dimensions:
      - name: payment_date
        type: time
        label: Payment Date
        description: Date dimension derived from order purchase timestamp via join
        expr: "DATE_TRUNC('day', order_purchase_timestamp)"
        type_params:
          time_granularity: day
      
      - name: payment_type
        type: categorical
        label: Payment Type
        description: |
          Payment method: credit_card (74.0%), boleto (19.0%), voucher (5.6%), 
          debit_card (1.5%), not_defined (0.003%)
        expr: payment_type
      
      - name: payment_sequential
        type: categorical
        label: Payment Sequential
        description: Sequence number for split payments (1-29, avg 1.09, median 1)
        expr: payment_sequential
      
      - name: installments_bucket
        type: categorical
        label: Installment Bucket
        description: Installment count categorization
        expr: |
          CASE 
            WHEN payment_installments = 0 THEN '0 (Boleto/Debit)'
            WHEN payment_installments = 1 THEN '1 (Full Payment)'
            WHEN payment_installments <= 3 THEN '2-3 Installments'
            WHEN payment_installments <= 6 THEN '4-6 Installments'
            WHEN payment_installments <= 12 THEN '7-12 Installments'
            ELSE '13+ Installments'
          END
      
      - name: is_credit_card
        type: categorical
        label: Is Credit Card
        description: Boolean flag for credit card payments
        expr: "CASE WHEN payment_type = 'credit_card' THEN TRUE ELSE FALSE END"
      
      - name: is_boleto
        type: categorical
        label: Is Boleto
        description: Boolean flag for boleto payments (Brazilian payment slip)
        expr: "CASE WHEN payment_type = 'boleto' THEN TRUE ELSE FALSE END"
      
      - name: is_split_payment
        type: categorical
        label: Is Split Payment
        description: Boolean flag for orders with multiple payment transactions
        expr: "CASE WHEN payment_sequential > 1 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: payments_count
        agg: count
        label: Payment Transactions
        description: Total number of payment transactions (103,886)
      
      - name: payments_value_total
        agg: sum
        label: Total Payment Value
        description: Sum of all payment values (avg R$154.10, median R$100.00)
        expr: payment_value
      
      - name: payments_installments_total
        agg: sum
        label: Total Installments
        description: Sum of installment counts for calculating averages (avg 2.85, median 1)
        expr: payment_installments
      
      - name: payments_credit_card_count
        agg: sum
        label: Credit Card Payments
        description: Count of credit card payment transactions (76,795 or 74%)
        expr: "CASE WHEN payment_type = 'credit_card' THEN 1 ELSE 0 END"
      
      - name: payments_boleto_count
        agg: sum
        label: Boleto Payments
        description: Count of boleto payment transactions (19,784 or 19%)
        expr: "CASE WHEN payment_type = 'boleto' THEN 1 ELSE 0 END"
      
      - name: payments_voucher_count
        agg: sum
        label: Voucher Payments
        description: Count of voucher payment transactions (5,775 or 5.6%)
        expr: "CASE WHEN payment_type = 'voucher' THEN 1 ELSE 0 END"
      
      - name: payments_debit_card_count
        agg: sum
        label: Debit Card Payments
        description: Count of debit card payment transactions (1,529 or 1.5%)
        expr: "CASE WHEN payment_type = 'debit_card' THEN 1 ELSE 0 END"
      
      - name: payments_credit_card_value
        agg: sum
        label: Credit Card Payment Value
        description: Total value from credit card payments (approximately 75% of revenue)
        expr: "CASE WHEN payment_type = 'credit_card' THEN payment_value ELSE 0 END"
      
      - name: payments_boleto_value
        agg: sum
        label: Boleto Payment Value
        description: Total value from boleto payments
        expr: "CASE WHEN payment_type = 'boleto' THEN payment_value ELSE 0 END"
      
      - name: distinct_orders_with_payments
        agg: count_distinct
        label: Orders with Payments
        description: Number of unique orders with payment records (99,440)
        expr: order_id

  - name: order_reviews
    description: |
      Customer reviews and ratings for completed orders. Contains 99,224 reviews for 98,673 orders.
      Average review score is 4.09/5.0. Distribution: 5 stars (57.8%), 4 stars (19.3%), 
      1 star (11.5%), 3 stars (8.1%), 2 stars (3.3%). 88.3% have no comment title,
      58.7% have no comment message.
    model: ref('order_reviews')
    defaults:
      agg_time_dimension: review_creation_date
    
    entities:
      - name: review_id
        type: primary
        expr: review_id
      - name: order_id
        type: foreign
        expr: order_id
    
    dimensions:
      - name: review_creation_date
        type: time
        label: Review Creation Date
        description: Date when customer created the review (636 unique dates)
        expr: review_creation_date
        type_params:
          time_granularity: day
      
      - name: review_answer_date
        type: time
        label: Review Answer Date
        description: Timestamp when review was answered (98,248 unique timestamps)
        expr: review_answer_timestamp
        type_params:
          time_granularity: day
      
      - name: review_score
        type: categorical
        label: Review Score
        description: |
          Customer rating 1-5: 5 stars (57.8%), 4 stars (19.3%), 1 star (11.5%),
          3 stars (8.1%), 2 stars (3.3%)
        expr: review_score
      
      - name: review_score_category
        type: categorical
        label: Review Score Category
        description: Grouped review scores for analysis
        expr: |
          CASE 
            WHEN review_score >= 4 THEN 'Positive (4-5)'
            WHEN review_score = 3 THEN 'Neutral (3)'
            ELSE 'Negative (1-2)'
          END
      
      - name: has_comment_title
        type: categorical
        label: Has Comment Title
        description: Boolean flag for reviews with comment titles (11.7% have titles)
        expr: "CASE WHEN review_comment_title IS NOT NULL THEN TRUE ELSE FALSE END"
      
      - name: has_comment_message
        type: categorical
        label: Has Comment Message
        description: Boolean flag for reviews with comment messages (41.3% have messages)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN TRUE ELSE FALSE END"
      
      - name: is_five_star
        type: categorical
        label: Is Five Star
        description: Boolean flag for 5-star reviews (57.8% of reviews)
        expr: "CASE WHEN review_score = 5 THEN TRUE ELSE FALSE END"
      
      - name: is_one_star
        type: categorical
        label: Is One Star
        description: Boolean flag for 1-star reviews (11.5% of reviews)
        expr: "CASE WHEN review_score = 1 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: reviews_count
        agg: count
        label: Total Reviews
        description: Total number of customer reviews (99,224)
      
      - name: reviews_score_total
        agg: sum
        label: Total Review Score Points
        description: Sum of all review scores for calculating averages (avg 4.09)
        expr: review_score
      
      - name: reviews_five_star_count
        agg: sum
        label: Five Star Reviews
        description: Count of 5-star reviews (57,328 or 57.8%)
        expr: "CASE WHEN review_score = 5 THEN 1 ELSE 0 END"
      
      - name: reviews_four_star_count
        agg: sum
        label: Four Star Reviews
        description: Count of 4-star reviews (19,142 or 19.3%)
        expr: "CASE WHEN review_score = 4 THEN 1 ELSE 0 END"
      
      - name: reviews_three_star_count
        agg: sum
        label: Three Star Reviews
        description: Count of 3-star reviews (8,040 or 8.1%)
        expr: "CASE WHEN review_score = 3 THEN 1 ELSE 0 END"
      
      - name: reviews_two_star_count
        agg: sum
        label: Two Star Reviews
        description: Count of 2-star reviews (3,151 or 3.2%)
        expr: "CASE WHEN review_score = 2 THEN 1 ELSE 0 END"
      
      - name: reviews_one_star_count
        agg: sum
        label: One Star Reviews
        description: Count of 1-star reviews (11,424 or 11.5%)
        expr: "CASE WHEN review_score = 1 THEN 1 ELSE 0 END"
      
      - name: reviews_positive_count
        agg: sum
        label: Positive Reviews (4-5 Stars)
        description: Count of reviews with 4 or 5 stars (76,470 or 77.1%)
        expr: "CASE WHEN review_score >= 4 THEN 1 ELSE 0 END"
      
      - name: reviews_negative_count
        agg: sum
        label: Negative Reviews (1-2 Stars)
        description: Count of reviews with 1 or 2 stars (14,575 or 14.7%)
        expr: "CASE WHEN review_score <= 2 THEN 1 ELSE 0 END"
      
      - name: reviews_with_title_count
        agg: sum
        label: Reviews with Title
        description: Count of reviews with comment titles (11.7% have titles)
        expr: "CASE WHEN review_comment_title IS NOT NULL THEN 1 ELSE 0 END"
      
      - name: reviews_with_message_count
        agg: sum
        label: Reviews with Message
        description: Count of reviews with comment messages (41.3% have messages)
        expr: "CASE WHEN review_comment_message IS NOT NULL THEN 1 ELSE 0 END"
      
      - name: review_response_hours_total
        agg: sum
        label: Total Review Response Hours
        description: Sum of hours from review creation to answer for calculating averages
        expr: |
          CASE 
            WHEN review_answer_timestamp IS NOT NULL
            THEN EXTRACT(EPOCH FROM (review_answer_timestamp - review_creation_date)) / 3600
            ELSE 0
          END
      
      - name: distinct_orders_reviewed
        agg: count_distinct
        label: Orders Reviewed
        description: Number of unique orders with reviews (98,673)
        expr: order_id

  - name: customers
    description: |
      Customer master data with geographic information. Contains 99,441 customer records
      with 96,096 unique customers (some customers have multiple customer_ids).
      Geographic distribution: São Paulo state (SP) has 41,746 customers (42.0%),
      Rio de Janeiro (RJ) 12,852 (12.9%), Minas Gerais (MG) 11,635 (11.7%).
      Covers 4,119 cities and 14,994 zip code prefixes across 27 states.
    model: ref('customers')
    defaults:
      agg_time_dimension: customer_first_order_date
    
    entities:
      - name: customer_id
        type: primary
        expr: customer_id
      - name: customer_unique_id
        type: natural
        expr: customer_unique_id
    
    dimensions:
      - name: customer_first_order_date
        type: time
        label: Customer First Order Date
        description: Date of customer's first order (derived from orders table join)
        expr: "DATE_TRUNC('day', first_order_timestamp)"
        type_params:
          time_granularity: day
      
      - name: customer_state
        type: categorical
        label: Customer State
        description: |
          Brazilian state code (27 states). Top states: SP (42.0%), RJ (12.9%), 
          MG (11.7%), RS (5.5%), PR (5.1%)
        expr: customer_state
      
      - name: customer_city
        type: categorical
        label: Customer City
        description: City name (4,119 unique cities)
        expr: customer_city
      
      - name: customer_zip_code_prefix
        type: categorical
        label: Customer Zip Code Prefix
        description: First 5 digits of zip code (14,994 unique prefixes)
        expr: customer_zip_code_prefix
      
      - name: customer_region
        type: categorical
        label: Customer Region
        description: Brazilian geographic region derived from state
        expr: |
          CASE 
            WHEN customer_state IN ('SP', 'RJ', 'MG', 'ES') THEN 'Southeast'
            WHEN customer_state IN ('RS', 'SC', 'PR') THEN 'South'
            WHEN customer_state IN ('BA', 'SE', 'AL', 'PE', 'PB', 'RN', 'CE', 'PI', 'MA') THEN 'Northeast'
            WHEN customer_state IN ('GO', 'DF', 'MT', 'MS') THEN 'Central-West'
            WHEN customer_state IN ('AM', 'RR', 'AP', 'PA', 'TO', 'RO', 'AC') THEN 'North'
            ELSE 'Unknown'
          END
      
      - name: is_sao_paulo_state
        type: categorical
        label: Is São Paulo State
        description: Boolean flag for SP state customers (42% of customer base)
        expr: "CASE WHEN customer_state = 'SP' THEN TRUE ELSE FALSE END"
      
      - name: is_top_3_states
        type: categorical
        label: Is Top 3 States
        description: Boolean flag for SP, RJ, MG customers (66.6% of customer base)
        expr: "CASE WHEN customer_state IN ('SP', 'RJ', 'MG') THEN TRUE ELSE FALSE END"
    
    measures:
      - name: customers_count
        agg: count
        label: Total Customer Records
        description: Total customer records including duplicates (99,441)
      
      - name: customers_unique_count
        agg: count_distinct
        label: Unique Customers
        description: Distinct customers by customer_unique_id (96,096)
        expr: customer_unique_id
      
      - name: customers_sp_count
        agg: sum
        label: São Paulo Customers
        description: Count of customers in SP state (41,746 or 42%)
        expr: "CASE WHEN customer_state = 'SP' THEN 1 ELSE 0 END"
      
      - name: customers_rj_count
        agg: sum
        label: Rio de Janeiro Customers
        description: Count of customers in RJ state (12,852 or 12.9%)
        expr: "CASE WHEN customer_state = 'RJ' THEN 1 ELSE 0 END"
      
      - name: customers_mg_count
        agg: sum
        label: Minas Gerais Customers
        description: Count of customers in MG state (11,635 or 11.7%)
        expr: "CASE WHEN customer_state = 'MG' THEN 1 ELSE 0 END"
      
      - name: distinct_cities_count
        agg: count_distinct
        label: Distinct Cities
        description: Number of unique cities with customers (4,119)
        expr: customer_city
      
      - name: distinct_states_count
        agg: count_distinct
        label: Distinct States
        description: Number of unique states with customers (27)
        expr: customer_state
      
      - name: distinct_zip_codes_count
        agg: count_distinct
        label: Distinct Zip Codes
        description: Number of unique zip code prefixes (14,994)
        expr: customer_zip_code_prefix

  - name: products
    description: |
      Product catalog with physical dimensions and category information.
      Contains 32,951 products across 73 categories. 1.9% of products have missing
      category or dimension data. Average product weighs 2,276g (median 700g),
      measures 30.8cm length (median 25cm), 16.9cm height (median 13cm),
      23.2cm width (median 20cm). Average 2.19 photos per product (median 1).
    model: ref('products')
    defaults:
      agg_time_dimension: product_created_date
    
    entities:
      - name: product_id
        type: primary
        expr: product_id
      - name: product_category_name
        type: foreign
        expr: product_category_name
    
    dimensions:
      - name: product_created_date
        type: time
        label: Product Created Date
        description: Date dimension for time-based analysis (derived from first sale)
        expr: "DATE_TRUNC('day', first_sale_timestamp)"
        type_params:
          time_granularity: day
      
      - name: product_category_name
        type: categorical
        label: Product Category (Portuguese)
        description: Product category in Portuguese (73 categories, 1.9% null)
        expr: product_category_name
      
      - name: product_weight_bucket
        type: categorical
        label: Product Weight Bucket
        description: Weight categorization for logistics analysis
        expr: |
          CASE 
            WHEN product_weight_g < 500 THEN 'Light (<500g)'
            WHEN product_weight_g < 2000 THEN 'Medium (500g-2kg)'
            WHEN product_weight_g < 5000 THEN 'Heavy (2-5kg)'
            WHEN product_weight_g < 10000 THEN 'Very Heavy (5-10kg)'
            ELSE 'Extra Heavy (10kg+)'
          END
      
      - name: product_size_category
        type: categorical
        label: Product Size Category
        description: Size categorization based on volume
        expr: |
          CASE 
            WHEN (product_length_cm * product_height_cm * product_width_cm) < 5000 THEN 'Small'
            WHEN (product_length_cm * product_height_cm * product_width_cm) < 20000 THEN 'Medium'
            WHEN (product_length_cm * product_height_cm * product_width_cm) < 50000 THEN 'Large'
            ELSE 'Extra Large'
          END
      
      - name: has_multiple_photos
        type: categorical
        label: Has Multiple Photos
        description: Boolean flag for products with 2+ photos
        expr: "CASE WHEN product_photos_qty > 1 THEN TRUE ELSE FALSE END"
      
      - name: has_long_description
        type: categorical
        label: Has Long Description
        description: Boolean flag for products with description >500 characters
        expr: "CASE WHEN product_description_length > 500 THEN TRUE ELSE FALSE END"
    
    measures:
      - name: products_count
        agg: count
        label: Total Products
        description: Total number of products in catalog (32,951)
      
      - name: products_weight_total
        agg: sum
        label: Total Product Weight
        description: Sum of product weights in grams (avg 2,276g, median 700g)
        expr: product_weight_g
      
      - name: products_weight_avg
        agg: average
        label: Average Product Weight
        description: Average product weight in grams (2,276g)
        expr: product_weight_g
      
      - name: products_volume_total
        agg: sum
        label: Total Product Volume
        description: Sum of product volumes (length × height × width in cm³)
        expr: product_length_cm * product_height_cm * product_width_cm
      
      - name: products_photos_total
        agg: sum
        label: Total Product Photos
        description: Sum of photo counts (avg 2.19, median 1)
        expr: product_photos_qty
      
      - name: products_name_length_total
        agg: sum
        label: Total Name Length
        description: Sum of product name lengths (avg 48.48, median 51)
        expr: product_name_length
      
      - name: products_description_length_total
        agg: sum
        label: Total Description Length
        description: Sum of description lengths (avg 771.50, median 595)
        expr: product_description_length
      
      - name: products_with_category_count
        agg: sum
        label: Products with Category
        description: Count of products with assigned category (98.1% have category)
        expr: "CASE WHEN product_category_name IS NOT NULL THEN 1 ELSE 0 END"
      
      - name: products_heavy_count
        agg: sum
        label: Heavy Products (5kg+)
        description: Count of products weighing 5kg or more
        expr: "CASE WHEN product_weight_g >= 5000 THEN 1 ELSE 0 END"
      
      - name: distinct_categories_count
        agg: count_distinct
        label: Distinct Categories
        description: Number of unique product categories (73)
        expr: product_category_name

  - name: sellers
    description: |
      Seller master data with geographic information. Contains 3,095 sellers
      across 611 cities and 23 states. Geographic distribution: São Paulo (SP)
      has 1,849 sellers (59.7%), Paraná (PR) 349 (11.3%), Minas Gerais (MG) 244 (7.9%).
      Covers 2,246 unique zip code prefixes.
    model: ref('sellers')
    defaults:
      agg_time_dimension: seller_first_sale_date
    
    entities:
      - name: seller_id
        type: primary
        expr: seller_id
    
    dimensions:
      - name: seller_first_sale_date
        type: time
        label: Seller First Sale Date
        description: Date of seller's first sale (derived from order_items join)
        expr: "DATE_TRUNC('day', first_sale_timestamp)"
        type_params:
          time_granularity: day
      
      - name: seller_state
        type: categorical
        label: Seller State
        description: |
          Brazilian state code (23 states). Top states: SP (59.7%), PR (11.3%),
          MG (7.9%), RJ (4.6%), SC (3.3%)
        expr: seller_state
      
      - name: seller_city
        type: categorical
        label: Seller City
        description: City name (611 unique cities)
        expr: seller_city
      
      - name: seller_zip_code_prefix
        type: categorical
        label: Seller Zip Code Prefix
        description: First 5 digits of zip code (2,246 unique prefixes)
        expr: seller_zip_code_prefix
      
      - name: seller_region
        type: categorical
        label: Seller Region
        description: Brazilian geographic region derived from state
        expr: |
          CASE 
            WHEN seller_state IN ('SP', 'RJ', 'MG', 'ES') THEN 'Southeast'
            WHEN seller_state IN ('RS', 'SC', 'PR') THEN 'South'
            WHEN seller_state IN ('BA', 'SE', 'AL', 'PE', 'PB', 'RN', 'CE', 'PI', 'MA') THEN 'Northeast'
            WHEN seller_state IN ('GO', 'DF', 'MT', 'MS') THEN 'Central-West'
            WHEN seller_state IN ('AM', 'RR', 'AP', 'PA', 'TO', 'RO', 'AC') THEN 'North'
            ELSE 'Unknown'
          END
      
      - name: is_sao_paulo_seller
        type: categorical
        label: Is São Paulo Seller
        description: Boolean flag for SP state sellers (59.7% of sellers)
        expr: "CASE WHEN seller_state = 'SP' THEN TRUE ELSE FALSE END"
      
      - name: is_top_3_seller_states
        type: categorical
        label: Is Top 3 Seller States
        description: Boolean flag for SP, PR, MG sellers (78.9% of sellers)
        expr: "CASE WHEN seller_state IN ('SP', 'PR', 'MG') THEN TRUE ELSE FALSE END"
    
    measures:
      - name: sellers_count
        agg: count
        label: Total Sellers
        description: Total number of sellers in marketplace (3,095)
      
      - name: sellers_sp_count
        agg: sum
        label: São Paulo Sellers
        description: Count of sellers in SP state (1,849 or 59.7%)
        expr: "CASE WHEN seller_state = 'SP' THEN 1 ELSE 0 END"
      
      - name: sellers_pr_count
        agg: sum
        label: Paraná Sellers
        description: Count of sellers in PR state (349 or 11.3%)
        expr: "CASE WHEN seller_state = 'PR' THEN 1 ELSE 0 END"
      
      - name: sellers_mg_count
        agg: sum
        label: Minas Gerais Sellers
        description: Count of sellers in MG state (244 or 7.9%)
        expr: "CASE WHEN seller_state = 'MG' THEN 1 ELSE 0 END"
      
      - name: distinct_seller_cities_count
        agg: count_distinct
        label: Distinct Seller Cities
        description: Number of unique cities with sellers (611)
        expr: seller_city
      
      - name: distinct_seller_states_count
        agg: count_distinct
        label: Distinct Seller States
        description: Number of unique states with sellers (23)
        expr: seller_state
      
      - name: distinct_seller_zip_codes_count
        agg: count_distinct
        label: Distinct Seller Zip Codes
        description: Number of unique seller zip code prefixes (2,246)
        expr: seller_zip_code_prefix

  - name: product_categories
    description: |
      Product category translation table mapping Portuguese category names to English.
      Contains 73 category translations for the complete product taxonomy.
    model: ref('product_category_translation')
    defaults:
      agg_time_dimension: category_created_date
    
    entities:
      - name: product_category_name
        type: primary
        expr: product_category_name
    
    dimensions:
      - name: category_created_date
        type: time
        label: Category Created Date
        description: Date dimension for time-based analysis (derived from first product)
        expr: "DATE_TRUNC('day', first_product_timestamp)"
        type_params:
          time_granularity: day
      
      - name: product_category_name_english
        type: categorical
        label: Product Category (English)
        description: Product category in English (73 categories)
        expr: product_category_name_english
      
      - name: category_group
        type: categorical
        label: Category Group
        description: High-level category grouping for analysis
        expr: |
          CASE 
            WHEN product_category_name_english IN ('bed_bath_table', 'furniture_decor', 'furniture_bedroom', 'furniture_living_room', 'home_comfort', 'home_construction', 'garden_tools', 'home_confort') THEN 'Home & Furniture'
            WHEN product_category_name_english IN ('health_beauty', 'perfumery', 'diapers_and_hygiene') THEN 'Health & Beauty'
            WHEN product_category_name_english IN ('sports_leisure', 'toys', 'baby', 'fashion_sport') THEN 'Sports & Leisure'
            WHEN product_category_name_english IN ('computers_accessories', 'electronics', 'telephony', 'computers', 'tablets_printing_image', 'audio', 'consoles_games', 'pc_gamer', 'fixed_telephony') THEN 'Electronics & Computers'
            WHEN product_category_name_english IN ('housewares', 'small_appliances', 'small_appliances_home_oven_and_coffee', 'kitchen_dining_laundry_garden_furniture') THEN 'Appliances & Housewares'
            WHEN product_category_name_english IN ('watches_gifts', 'cool_stuff', 'party_supplies', 'christmas_supplies', 'arts_and_craftmanship', 'art', 'flowers', 'costumes_fashions') THEN 'Gifts & Party'
            WHEN product_category_name_english IN ('auto', 'automotive') THEN 'Automotive'
            WHEN product_category_name_english IN ('books_general_interest', 'books_technical', 'books_imported', 'cds_dvds_musicals', 'music', 'dvds_blu_ray') THEN 'Books & Media'
            WHEN product_category_name_english IN ('fashion_bags_accessories', 'fashion_shoes', 'fashion_male_clothing', 'fashion_childrens_clothes', 'fashion_underwear_beach', 'luggage_accessories', 'signaling_and_security') THEN 'Fashion & Accessories'
            WHEN product_category_name_english IN ('stationery', 'office_furniture') THEN 'Office & Stationery'
            WHEN product_category_name_english IN ('food_drink', 'food', 'drinks') THEN 'Food & Drink'
            WHEN product_category_name_english IN ('pet_shop', 'agro_industry_and_commerce') THEN 'Pet & Agro'
            WHEN product_category_name_english IN ('construction_tools_safety', 'construction_tools_lights', 'construction_tools_tools', 'industry_commerce_and_business', 'air_conditioning') THEN 'Construction & Industry'
            ELSE 'Other'
          END
    
    measures:
      - name: categories_count
        agg: count
        label: Total Categories
        description: Total number of product categories (73)

---

# File: _metrics.yml
version: 2

metrics:
  # ============================================================================
  # REVENUE & GMV METRICS
  # ============================================================================
  
  - name: revenue
    label: Total Revenue
    description: |
      Total payment value from all delivered orders. Excludes canceled orders.
      Based on payment_value which includes price + freight. Approximately R$15.4-15.9M
      across the dataset period (Sep 2016 - Oct 2018).
    type: simple
    type_params:
      measure: payments_value_total
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: gmv
    label: Gross Merchandise Value
    description: |
      Total GMV from order items (price + freight). Alternative revenue calculation
      based on order line items rather than payments. Should closely match revenue metric.
    type: simple
    type_params:
      measure: order_items_gmv_total
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: product_revenue
    label: Product Revenue (Excluding Freight)
    description: |
      Total revenue from product prices only, excluding freight costs.
      Useful for understanding product-level profitability before logistics costs.
    type: simple
    type_params:
      measure: order_items_price_total
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: freight_revenue
    label: Freight Revenue
    description: |
      Total freight/shipping costs charged to customers. Average freight is R$19.99
      per item. Represents logistics revenue component.
    type: simple
    type_params:
      measure: order_items_freight_total
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: cumulative_revenue
    label: Cumulative Revenue (All-Time)
    description: |
      Running total of revenue from the beginning of time. Shows total revenue
      accumulated up to each point in time.
    type: cumulative
    type_params:
      measure: payments_value_total
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: revenue_mtd
    label: Revenue Month-to-Date
    description: |
      Revenue accumulated from the start of the current month to date.
      Resets at the beginning of each month.
    type: cumulative
    type_params:
      measure: payments_value_total
      grain_to_date: month
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: revenue_qtd
    label: Revenue Quarter-to-Date
    description: |
      Revenue accumulated from the start of the current quarter to date.
      Resets at the beginning of each quarter.
    type: cumulative
    type_params:
      measure: payments_value_total
      grain_to_date: quarter
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: revenue_ytd
    label: Revenue Year-to-Date
    description: |
      Revenue accumulated from the start of the current year to date.
      Resets at the beginning of each year.
    type: cumulative
    type_params:
      measure: payments_value_total
      grain_to_date: year
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'

  # ============================================================================
  # ORDER VOLUME METRICS
  # ============================================================================
  
  - name: orders
    label: Total Orders
    description: |
      Total count of orders regardless of status. Includes delivered, shipped,
      canceled, and all other statuses. Total dataset contains 99,441 orders.
    type: simple
    type_params:
      measure: orders_total_count
  
  - name: orders_delivered
    label: Delivered Orders
    description: |
      Count of successfully delivered orders. Represents 97% of all orders
      (96,478 out of 99,441 orders).
    type: simple
    type_params:
      measure: orders_delivered_count
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: orders_canceled
    label: Canceled Orders
    description: |
      Count of canceled orders. Represents 0.6% of all orders (625 orders).
      Important for understanding order failure rate.
    type: simple
    type_params:
      measure: orders_canceled_count
  
  - name: orders_shipped
    label: Shipped Orders
    description: |
      Count of orders currently in shipping status (not yet delivered).
      Represents 1.1% of orders (1,107 orders).
    type: simple
    type_params:
      measure: orders_total_count
    filter: |
      {{ Dimension('order_id__order_status') }} = 'shipped'
  
  - name: cumulative_orders
    label: Cumulative Orders (All-Time)
    description: |
      Running total of orders from the beginning of time. Shows order volume
      growth trajectory over the entire dataset period.
    type: cumulative
    type_params:
      measure: orders_total_count

  # ============================================================================
  # AVERAGE ORDER VALUE METRICS
  # ============================================================================
  
  - name: average_order_value
    label: Average Order Value (AOV)
    description: |
      Average revenue per delivered order. Calculated as total revenue divided
      by delivered order count. Median is approximately R$100, average R$154.
    type: derived
    type_params:
      expr: revenue / nullif(orders_delivered, 0)
      metrics:
        - name: revenue
        - name: orders_delivered
  
  - name: average_item_price
    label: Average Item Price
    description: |
      Average price per item sold (excluding freight). Median is R$74.99,
      average is R$120.65. Useful for pricing strategy analysis.
    type: derived
    type_params:
      expr: product_revenue / nullif(items_sold, 0)
      metrics:
        - name: product_revenue
        - name: items_sold
  
  - name: average_freight_per_item
    label: Average Freight per Item
    description: |
      Average freight cost per item. Median is R$16.26, average is R$19.99.
      Key metric for logistics cost management.
    type: derived
    type_params:
      expr: freight_revenue / nullif(items_sold, 0)
      metrics:
        - name: freight_revenue
        - name: items_sold
  
  - name: freight_to_price_ratio
    label: Freight to Price Ratio
    description: |
      Freight cost as a percentage of product price. Shows logistics cost burden
      relative to product value. Higher ratios indicate expensive-to-ship low-value items.
    type: derived
    type_params:
      expr: freight_revenue / nullif(product_revenue, 0)
      metrics:
        - name: freight_revenue
        - name: product_revenue

  # ============================================================================
  # ITEM & PRODUCT METRICS
  # ============================================================================
  
  - name: items_sold
    label: Total Items Sold
    description: |
      Total count of individual items sold across all orders. Dataset contains
      112,650 items across 98,666 orders (average 1.14 items per order).
    type: simple
    type_params:
      measure: order_items_count
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: items_per_order
    label: Items per Order
    description: |
      Average number of items per order. Most orders (98,666) have 1 item,
      9,803 have 2 items, with decreasing frequency for higher counts.
    type: derived
    type_params:
      expr: items_sold / nullif(orders_delivered, 0)
      metrics:
        - name: items_sold
        - name: orders_delivered
  
  - name: unique_products_sold
    label: Unique Products Sold
    description: |
      Count of distinct products that have been sold. Out of 32,951 products
      in catalog, this shows how many have actual sales.
    type: simple
    type_params:
      measure: distinct_products_sold
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'
  
  - name: active_sellers
    label: Active Sellers
    description: |
      Count of distinct sellers with delivered orders. Shows marketplace
      seller participation (3,095 total sellers).
    type: simple
    type_params:
      measure: distinct_sellers_active
    filter: |
      {{ Dimension('order_id__order_status') }} = 'delivered'

  # ============================================================================
  # CUSTOMER METRICS
  # ============================================================================
  
  - name: customers
    label: Total Customers
    description: |
      Count of unique customers (by customer_unique_id). Dataset contains
      96,096 unique customers across 99,441 customer records.
    type: simple
    type_params:
      measure: customers_unique_count
  
  - name: new_customers
    label: New Customers
    description: |
      Count of customers making their first purchase in the period.
      Calculated by counting customers whose first order date falls in the period.
    type: simple
    type_params:
      measure: customers_unique_count
    filter: |
      {{ Dimension('customer_id__customer_first_order_date') }} >= {{ start_date }}
  
  - name: orders_per_customer
    label: Orders per Customer
    description: |
      Average number of orders per unique customer. Most customers (97%) make
      only 1 purchase, indicating low repeat purchase rate.
    type: derived
    type_params:
      expr: orders / nullif(customers, 0)
      metrics:
        - name: orders
        - name: customers
  
  - name: revenue_per_customer
    label: Revenue per Customer (Customer Lifetime Value)
    description: |
      Average revenue per unique customer. Represents customer lifetime value
      over the dataset period. Calculated as total revenue / unique customers.
    type: derived
    type_params:
      expr: revenue / nullif(customers, 0)
      metrics:
        - name: revenue
        - name: customers

  # ============================================================================
  # DELIVERY PERFORMANCE METRICS
  # ============================================================================
  
  - name: on_time_deliveries
    label: On-Time Deliveries
    description: |
      Count of orders delivered by or before the estimated delivery date.
      Approximately 63% of delivered orders are on-time.
    type: simple
    type_params:
      measure: orders_on_time_count
  
  - name: late_deliveries
    label: Late Deliveries
    description: |
      Count of orders delivered after the estimated delivery date.
      Approximately 37% of delivered orders are late.
    type: simple
    type_params:
      measure: orders_late_count
  
  - name: on_time_delivery_rate
    label: On-Time Delivery Rate
    description: |
      Percentage of delivered orders that arrived on-time or early.
      Key operational KPI. Target is typically 95%+, actual is ~63%.
    type: derived
    type_params:
      expr: on_time_deliveries / nullif(orders_delivered, 0)
      metrics:
        - name: on_time_deliveries
        - name: orders_delivered
  
  - name: late_delivery_rate
    label: Late Delivery Rate
    description: |
      Percentage of delivered orders that arrived late. Inverse of on-time rate.
      Current rate is ~37%, indicating significant room for improvement.
    type: derived
    type_params:
      expr: late_deliveries / nullif(orders_delivered, 0)
      metrics:
        - name: late_deliveries
        - name: orders_delivered
  
  - name: average_delivery_days
    label: Average Delivery Days
    description: |
      Average number of days from order purchase to customer delivery.
      Calculated only for delivered orders with valid delivery dates.
    type: derived
    type_params:
      expr: delivery_days_total / nullif(orders_delivered, 0)
      metrics:
        - name: delivery_days_total
          alias: delivery_days_total
        - name: orders_delivered
  
  - name: average_approval_hours
    label: Average Approval Hours
    description: |
      Average hours from order purchase to payment approval.
      Measures payment processing speed. Lower is better for customer experience.
    type: derived
    type_params:
      expr: approval_hours_total / nullif(orders, 0)
      metrics:
        - name: approval_hours_total
          alias: approval_hours_total
        - name: orders
  
  - name: average_late_days
    label: Average Days Late
    description: |
      For late deliveries, average number of days past the estimated delivery date.
      Measures severity of delivery delays.
    type: derived
    type_params:
      expr: late_days_total / nullif(late_deliveries, 0)
      metrics:
        - name: late_days_total
          alias: late_days_total
        - name: late_deliveries

  # ============================================================================
  # PAYMENT METHOD METRICS
  # ============================================================================
  
  - name: credit_card_payments
    label: Credit Card Payments
    description: |
      Count of credit card payment transactions. Credit card represents 74%
      of all payments (76,795 out of 103,886 payments).
    type: simple
    type_params:
      measure: payments_credit_card_count
  
  - name: boleto_payments
    label: Boleto Payments
    description: |
      Count of boleto payment transactions. Boleto (Brazilian payment slip)
      represents 19% of payments (19,784 payments).
    type: simple
    type_params:
      measure: payments_boleto_count
  
  - name: credit_card_revenue
    label: Credit Card Revenue
    description: |
      Total revenue from credit card payments. Represents approximately 75%
      of total revenue. Average credit card AOV is R$162.70.
    type: simple
    type_params:
      measure: payments_credit_card_value
  
  - name: boleto_revenue
    label: Boleto Revenue
    description: |
      Total revenue from boleto payments. Lower AOV than credit card.
      Boleto is popular for customers without credit cards.
    type: simple
    type_params:
      measure: payments_boleto_value
  
  - name: credit_card_share
    label: Credit Card Payment Share
    description: |
      Percentage of total revenue from credit card payments. Shows payment
      method preference and financial inclusion. Currently ~75%.
    type: derived
    type_params:
      expr: credit_card_revenue / nullif(revenue, 0)
      metrics:
        - name: credit_card_revenue
        - name: revenue
  
  - name: average_installments
    label: Average Installments
    description: |
      Average number of installments per payment. Most credit card payments
      use 1 installment (52,546 out of 76,795). Average is 2.85.
    type: derived
    type_params:
      expr: installments_total / nullif(payments, 0)
      metrics:
        - name: installments_total
          alias: installments_total
        - name: payments
          alias: payments

  # ============================================================================
  # REVIEW & SATISFACTION METRICS
  # ============================================================================
  
  - name: reviews
    label: Total Reviews
    description: |
      Total count of customer reviews. Dataset contains 99,224 reviews for
      98,673 orders (99.4% review rate).
    type: simple
    type_params:
      measure: reviews_count
  
  - name: average_review_score
    label: Average Review Score
    description: |
      Average customer review score on 1-5 scale. Overall average is 4.09/5.0.
      Distribution: 5 stars (57.8%), 4 stars (19.3%), 1 star (11.5%).
    type: derived
    type_params:
      expr: review_score_total / nullif(reviews, 0)
      metrics:
        - name: review_score_total
          alias: review_score_total
        - name: reviews
  
  - name: five_star_reviews
    label: Five Star Reviews
    description: |
      Count of 5-star reviews. Represents 57.8% of all reviews (57,328 reviews).
      Highest satisfaction level.
    type: simple
    type_params:
      measure: reviews_five_star_count
  
  - name: one_star_reviews
    label: One Star Reviews
    description: |
      Count of 1-star reviews. Represents 11.5% of all reviews (11,424 reviews).
      Indicates severe customer dissatisfaction.
    type: simple
    type_params:
      measure: reviews_one_star_count
  
  - name: positive_reviews
    label: Positive Reviews (4-5 Stars)
    description: |
      Count of reviews with 4 or 5 stars. Represents 77.1% of reviews
      (76,470 reviews). Standard measure of customer satisfaction.
    type: simple
    type_params:
      measure: reviews_positive_count
  
  - name: negative_reviews
    label: Negative Reviews (1-2 Stars)
    description: |
      Count of reviews with 1 or 2 stars. Represents 14.7% of reviews
      (14,575 reviews). Indicates customer dissatisfaction.
    type: simple
    type_params:
      measure: reviews_negative_count
  
  - name: positive_review_rate
    label: Positive Review Rate
    description: |
      Percentage of reviews that are positive (4-5 stars). Key satisfaction KPI.
      Current rate is 77.1%. Target is typically 90%+.
    type: derived
    type_params:
      expr: positive_reviews / nullif(reviews, 0)
      metrics:
        - name: positive_reviews
        - name: reviews
  
  - name: negative_review_rate
    label: Negative Review Rate
    description: |
      Percentage of reviews that are negative (1-2 stars). Inverse satisfaction metric.
      Current rate is 14.7%. Lower is better.
    type: derived
    type_params:
      expr: negative_reviews / nullif(reviews, 0)
      metrics:
        - name: negative_reviews
        - name: reviews
  
  - name: review_rate
    label: Review Rate
    description: |
      Percentage of delivered orders that have reviews. Shows customer engagement
      with review process. Current rate is ~99.4%.
    type: derived
    type_params:
      expr: reviews / nullif(orders_delivered, 0)
      metrics:
        - name: reviews
        - name: orders_delivered
  
  - name: average_review_response_hours
    label: Average Review Response Hours
    description: |
      Average hours from review creation to review answer/response.
      Measures customer service responsiveness to feedback.
    type: derived
    type_params:
      expr: review_response_hours_total / nullif(reviews, 0)
      metrics:
        - name: review_response_hours_total
          alias: review_response_hours_total
        - name: reviews

  # ============================================================================
  # GROWTH & TREND METRICS
  # ============================================================================
  
  - name: revenue_mom_growth
    label: Revenue Month-over-Month Growth
    description: |
      Percentage change in revenue compared to previous month. Shows monthly
      revenue growth trajectory. Positive values indicate growth.
    type: derived
    type_params:
      expr: (revenue - revenue_prior_month) / nullif(revenue_prior_month, 0)
      metrics:
        - name: revenue
        - name: revenue
          alias: revenue_prior_month
          offset_window: 1 month
  
  - name: orders_mom_growth
    label: Orders Month-over-Month Growth
    description: |
      Percentage change in order volume compared to previous month. Shows monthly
      order volume growth trajectory.
    type: derived
    type_params:
      expr: (orders - orders_prior_month) / nullif(orders_prior_month, 0)
      metrics:
        - name: orders
        - name: orders
          alias: orders_prior_month
          offset_window: 1 month
  
  - name: revenue_yoy_growth
    label: Revenue Year-over-Year Growth
    description: |
      Percentage change in revenue compared to same month last year. Shows
      annual growth trajectory accounting for seasonality.
    type: derived
    type_params:
      expr: (revenue - revenue_prior_year) / nullif(revenue_prior_year, 0)
      metrics:
        - name: revenue
        - name: revenue
          alias: revenue_prior_year
          offset_window: 1 year
  
  - name: orders_yoy_growth
    label: Orders Year-over-Year Growth
    description: |
      Percentage change in order volume compared to same month last year.
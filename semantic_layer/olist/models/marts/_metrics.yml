version: 2

metrics:

  # ===========================================================================
  # REVENUE METRICS
  # ===========================================================================

  - name: gmv
    label: Gross Merchandise Value
    description: >
      Total gross merchandise value — sum of product prices excluding freight.
      Includes all order statuses. Filter to delivered orders for realized GMV.
    type: simple
    type_params:
      measure: gmv

  - name: realized_gmv
    label: Realized GMV
    description: >
      GMV for delivered orders only. Represents actual revenue from
      successfully completed transactions.
    type: simple
    type_params:
      measure: gmv
    filter: |
      {{ Dimension('order_item__order_status') }} = 'delivered'

  - name: total_revenue
    label: Total Revenue
    description: >
      Sum of product prices plus freight charges for all line items.
    type: simple
    type_params:
      measure: total_revenue

  - name: freight_revenue
    label: Freight Revenue
    description: Total freight/shipping charges collected from customers.
    type: simple
    type_params:
      measure: freight_revenue

  - name: average_order_value
    label: Average Order Value (AOV)
    description: >
      Average revenue per order. Calculated as GMV divided by distinct
      order count. Dataset average is approximately R$137.
    type: derived
    type_params:
      expr: gmv / nullif(order_count, 0)
      metrics:
        - name: gmv
        - name: order_count_from_items
          alias: order_count

  - name: avg_item_price
    label: Avg Item Price
    description: Average selling price per line item.
    type: simple
    type_params:
      measure: avg_item_price

  - name: median_item_price
    label: Median Item Price
    description: >
      Median selling price per line item (R$74.99). More representative
      than the mean (R$120.65) due to right-skewed price distribution.
    type: simple
    type_params:
      measure: median_item_price

  - name: revenue_per_customer
    label: Revenue per Customer
    description: Average GMV per unique customer in the period.
    type: derived
    type_params:
      expr: total_gmv / nullif(customers, 0)
      metrics:
        - name: gmv
          alias: total_gmv
        - name: active_customers
          alias: customers


  # ===========================================================================
  # GROWTH METRICS
  # ===========================================================================

  - name: gmv_growth_mom
    label: GMV Growth % (MoM)
    description: >
      Month-over-month percentage change in GMV. Positive values indicate
      growth, negative indicate decline.
    type: derived
    type_params:
      expr: (current_gmv - previous_gmv) * 100.0 / nullif(previous_gmv, 0)
      metrics:
        - name: gmv
          alias: current_gmv
        - name: gmv
          offset_window: 1 month
          alias: previous_gmv

  - name: order_growth_mom
    label: Order Growth % (MoM)
    description: Month-over-month percentage change in order count.
    type: derived
    type_params:
      expr: (current_orders - previous_orders) * 100.0 / nullif(previous_orders, 0)
      metrics:
        - name: orders
          alias: current_orders
        - name: orders
          offset_window: 1 month
          alias: previous_orders

  - name: cumulative_gmv
    label: Cumulative GMV
    description: Running total of GMV over all time.
    type: cumulative
    type_params:
      measure: gmv

  - name: gmv_last_30_days
    label: GMV (Rolling 30 Days)
    description: Rolling 30-day GMV total.
    type: cumulative
    type_params:
      measure: gmv
      window: 30 days

  - name: gmv_mtd
    label: GMV Month-to-Date
    description: Cumulative GMV from the start of the current month.
    type: cumulative
    type_params:
      measure: gmv
      grain_to_date: month


  # ===========================================================================
  # ORDER METRICS
  # ===========================================================================

  - name: orders
    label: Orders
    description: Total number of orders placed across all statuses.
    type: simple
    type_params:
      measure: orders

  - name: delivered_orders
    label: Delivered Orders
    description: Number of orders successfully delivered to customers.
    type: simple
    type_params:
      measure: delivered_orders

  - name: canceled_orders
    label: Canceled Orders
    description: Number of orders that were canceled.
    type: simple
    type_params:
      measure: canceled_orders

  - name: order_count_from_items
    label: Orders (from Items)
    description: >
      Distinct order count derived from the line items table. Use this when
      combining with item-level metrics like GMV or item_count.
    type: simple
    type_params:
      measure: order_count_from_items

  - name: items_sold
    label: Items Sold
    description: Total number of line items sold across all orders.
    type: simple
    type_params:
      measure: item_count

  - name: items_per_order
    label: Items per Order
    description: >
      Average number of line items per order. Most orders (87.6%) have 1 item.
    type: derived
    type_params:
      expr: cast(items as double) / nullif(order_count, 0)
      metrics:
        - name: items_sold
          alias: items
        - name: order_count_from_items
          alias: order_count

  - name: cancellation_rate
    label: Cancellation Rate
    description: >
      Percentage of orders that were canceled. Dataset average is 0.6%.
    type: derived
    type_params:
      expr: canceled * 100.0 / nullif(total, 0)
      metrics:
        - name: canceled_orders
          alias: canceled
        - name: orders
          alias: total


  # ===========================================================================
  # DELIVERY METRICS
  # ===========================================================================

  - name: avg_delivery_days
    label: Avg Delivery Days
    description: >
      Average calendar days from order placement to customer delivery.
      Only includes orders with a recorded delivery date.
    type: simple
    type_params:
      measure: avg_delivery_days

  - name: avg_shipping_days
    label: Avg Shipping Days
    description: >
      Average calendar days from carrier handoff to customer delivery.
    type: simple
    type_params:
      measure: avg_shipping_days

  - name: on_time_delivery_rate
    label: On-Time Delivery Rate
    description: >
      Percentage of delivered orders that arrived on or before the estimated
      delivery date. Higher is better.
    type: derived
    type_params:
      expr: on_time * 100.0 / nullif(on_time + late, 0)
      metrics:
        - name: on_time_deliveries
          alias: on_time
        - name: late_deliveries
          alias: late

  - name: on_time_deliveries
    label: On-Time Deliveries
    description: Count of orders delivered on or before the estimated delivery date.
    type: simple
    type_params:
      measure: on_time_delivery_count

  - name: late_deliveries
    label: Late Deliveries
    description: Count of orders delivered after the estimated delivery date.
    type: simple
    type_params:
      measure: late_delivery_count


  # ===========================================================================
  # CUSTOMER METRICS
  # ===========================================================================

  - name: unique_customers
    label: Unique Customers
    description: >
      Distinct count of unique customers using the deduplicated
      customer_unique_id (96,096 total). Not the per-order customer_id.
    type: simple
    type_params:
      measure: unique_customers

  - name: active_customers
    label: Active Customers
    description: >
      Distinct count of unique customers with purchases in the period.
      Sourced from the line items table for use with revenue metrics.
    type: simple
    type_params:
      measure: active_customers

  - name: orders_per_customer
    label: Orders per Customer
    description: >
      Average number of orders per unique customer. Low values (~1.03)
      indicate the marketplace has very low repeat purchase rates.
    type: derived
    type_params:
      expr: cast(total_orders as double) / nullif(customers, 0)
      metrics:
        - name: orders
          alias: total_orders
        - name: unique_customers
          alias: customers


  # ===========================================================================
  # CUSTOMER SATISFACTION METRICS
  # ===========================================================================

  - name: avg_review_score
    label: Avg Review Score
    description: >
      Average customer review score on a 1-5 scale. Overall dataset
      average is 4.09. Distribution is bimodal — most reviews are either
      5-star (57.8%) or 1-star (11.5%).
    type: simple
    type_params:
      measure: avg_review_score

  - name: review_count
    label: Review Count
    description: Total number of customer reviews submitted.
    type: simple
    type_params:
      measure: review_count

  - name: five_star_reviews
    label: 5-Star Reviews
    description: Count of 5-star reviews.
    type: simple
    type_params:
      measure: five_star_reviews

  - name: one_star_reviews
    label: 1-Star Reviews
    description: Count of 1-star reviews.
    type: simple
    type_params:
      measure: one_star_reviews

  - name: positive_reviews
    label: Positive Reviews
    description: Count of reviews rated 4 or 5 (positive sentiment).
    type: simple
    type_params:
      measure: positive_reviews

  - name: negative_reviews
    label: Negative Reviews
    description: Count of reviews rated 1 or 2 (negative sentiment).
    type: simple
    type_params:
      measure: negative_reviews

  - name: five_star_rate
    label: 5-Star Review Rate
    description: >
      Percentage of reviews that are 5 stars. Dataset average is 57.8%.
    type: ratio
    type_params:
      numerator: five_star_reviews
      denominator: review_count

  - name: one_star_rate
    label: 1-Star Review Rate
    description: >
      Percentage of reviews that are 1 star. Dataset average is 11.5%.
    type: ratio
    type_params:
      numerator: one_star_reviews
      denominator: review_count

  - name: positive_review_rate
    label: Positive Review Rate
    description: >
      Percentage of reviews with score 4 or 5. Proxy for customer
      satisfaction.
    type: ratio
    type_params:
      numerator: positive_reviews
      denominator: review_count

  - name: negative_review_rate
    label: Negative Review Rate
    description: >
      Percentage of reviews with score 1 or 2. Proxy for customer
      dissatisfaction.
    type: ratio
    type_params:
      numerator: negative_reviews
      denominator: review_count


  # ===========================================================================
  # PAYMENT METRICS
  # ===========================================================================

  - name: total_payment_value
    label: Total Payment Value
    description: Sum of all payment values across all payment methods.
    type: simple
    type_params:
      measure: payment_total

  - name: avg_payment_value
    label: Avg Payment Value
    description: Average value per individual payment transaction.
    type: simple
    type_params:
      measure: avg_payment_value

  - name: credit_card_revenue
    label: Credit Card Revenue
    description: Total payment value from credit card transactions.
    type: simple
    type_params:
      measure: credit_card_payments

  - name: boleto_revenue
    label: Boleto Revenue
    description: Total payment value from boleto (bank slip) transactions.
    type: simple
    type_params:
      measure: boleto_payments

  - name: voucher_revenue
    label: Voucher Revenue
    description: Total payment value from voucher redemptions.
    type: simple
    type_params:
      measure: voucher_payments

  - name: credit_card_share
    label: Credit Card Revenue Share
    description: >
      Percentage of total payment value from credit card transactions.
      Dataset average is approximately 74%.
    type: ratio
    type_params:
      numerator: credit_card_revenue
      denominator: total_payment_value

  - name: avg_installments
    label: Avg Installments
    description: >
      Average number of installments for credit card payments. Excludes
      non-credit-card payments.
    type: simple
    type_params:
      measure: avg_installments


  # ===========================================================================
  # SELLER / MARKETPLACE METRICS
  # ===========================================================================

  - name: active_sellers
    label: Active Sellers
    description: Count of distinct sellers who fulfilled orders in the period.
    type: simple
    type_params:
      measure: active_sellers

  - name: active_products
    label: Active Products
    description: Count of distinct products sold in the period.
    type: simple
    type_params:
      measure: active_products

  - name: gmv_per_seller
    label: GMV per Seller
    description: Average GMV per active seller in the period.
    type: derived
    type_params:
      expr: total_gmv / nullif(sellers, 0)
      metrics:
        - name: gmv
          alias: total_gmv
        - name: active_sellers
          alias: sellers

  - name: items_per_seller
    label: Items per Seller
    description: Average number of items sold per active seller.
    type: derived
    type_params:
      expr: cast(items as double) / nullif(sellers, 0)
      metrics:
        - name: items_sold
          alias: items
        - name: active_sellers
          alias: sellers
